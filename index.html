<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HLL SPA Artillery Calculator - Calculate accurate elevation settings for multiple Self-Propelled Artillery vehicles in Hell Let Loose">
    <title>HLL SPA Artillery Calculator</title>
    <!-- Preload critical tank image for faster initial render (WebP only - PNG is fallback loaded on demand) -->
    <link rel="preload" as="image" href="images/tanks/BISHOP_248.webp" type="image/webp" fetchpriority="high">
    <link rel="stylesheet" href="dist/output.css">

    <style>
        @font-face {
            font-family: 'SpecialElite';
            src: url('fonts/SpecialElite.ttf') format('truetype');
        }
        :root {
            --paper: #0f0f10;        /* base paper black */
            --panel: #18181b;        /* panel background */
            --ink: #d7d5cc;          /* primary text */
            --muted: #9a968a;        /* muted text */
            --accent: #c2b280;       /* brass accent */
            --accent-strong: #b2a06f;/* darker brass */
            --line: #3f3f46;         /* border line */
            --shadow: rgba(0, 0, 0, 0.75);
        }
        body {
            font-family: 'SpecialElite', monospace;
            color: var(--ink);
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        /* Custom background image - optimized loading with WebP support */
        body {
            /* Use will-change to hint browser about background optimization */
            will-change: background-image;
            /* WebP with PNG fallback - massive size reduction */
            background-image: url('images/background/background2.webp');
            background-size: cover;
            background-position: 20% center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* Use contain/cover optimization */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            color: #d1d5db; /* Default text color: light gray */
        }
        
        /* Fallback for browsers that don't support WebP */
        @supports not (background-image: url('images/background/background2.webp')) {
            body {
                background-image: url('images/background/background2.png');
            }
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                /* Lighter vignette to let the photo breathe */
                radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.4) 60%, rgba(0, 0, 0, 0.8) 100%),
                /* Subtle noise texture for paper feel */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"),
                rgba(16, 16, 18, 0.75);
            pointer-events: none;
            z-index: 1;
        }
        
        .container {
            position: relative;
            z-index: 2;
            overflow: visible;
        }
        
        /* Hide slider thumb completely */
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 0;
            height: 0;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 0;
            height: 0;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        /* Military-style font for inputs and buttons */
        .military-input {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 15, 16, 0.4) !important;
            backdrop-filter: blur(8px);
            border: 2px solid rgba(156, 163, 175, 0.3) !important;
            box-shadow: 
                inset 0 0 20px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(156, 163, 175, 0.1) !important;
            transition: all 0.2s ease;
            color: #e5e7eb !important;
        }

        .military-button {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beveled-button {
            background: linear-gradient(145deg, #1f2937, #111827);
            border: none;
            border-top: 2px solid rgba(156, 163, 175, 0.2);
            border-left: 2px solid rgba(156, 163, 175, 0.15);
            border-bottom: 2px solid rgba(0, 0, 0, 0.6);
            border-right: 2px solid rgba(0, 0, 0, 0.6);
            box-shadow:
                inset -1px -1px 0 rgba(0, 0, 0, 0.4),
                inset 1px 1px 0 rgba(229, 231, 235, 0.1),
                0 2px 6px rgba(0, 0, 0, 0.55),
                0 1px 2px rgba(0, 0, 0, 0.35);
            transition: all 0.15s ease;
            position: relative;
        }

        .beveled-button:hover {
            background: linear-gradient(145deg, #374151, #1f2937);
            box-shadow:
                inset -1px -1px 0 rgba(0, 0, 0, 0.3),
                inset 1px 1px 0 rgba(229, 231, 235, 0.15),
                0 3px 8px rgba(0, 0, 0, 0.6),
                0 2px 4px rgba(0, 0, 0, 0.45);
            transform: translateY(-1px);
        }

        .beveled-button:active {
            background: linear-gradient(145deg, #111827, #0f172a);
            border-top: 2px solid rgba(0, 0, 0, 0.4);
            border-left: 2px solid rgba(0, 0, 0, 0.4);
            border-bottom: 2px solid rgba(156, 163, 175, 0.1);
            border-right: 2px solid rgba(156, 163, 175, 0.1);
            box-shadow:
                inset 2px 2px 4px rgba(0, 0, 0, 0.55),
                inset -1px -1px 2px rgba(0, 0, 0, 0.35),
                0 1px 2px rgba(0, 0, 0, 0.35);
            transform: translateY(0);
        }

        .warning-text {
            font-family: 'SpecialElite', 'Courier New', monospace;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.15em;
            color: #fef3c7;
            text-align: center;
            padding-left: 35px;
            text-shadow: 
                0 0 8px rgba(220, 38, 38, 0.6),
                1px 1px 2px rgba(0, 0, 0, 0.8);
            position: relative;
            z-index: 1;
            margin: 0;
            line-height: 1.2;
        }

        .hidden {
            display: none !important;
        }

        .warning-container {
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(0, 0, 0, 0.03) 1px,
                    rgba(0, 0, 0, 0.03) 2px
                ),
                linear-gradient(180deg, #f5f1e8 0%, #e8e0d0 50%, #f5f1e8 100%);
            border: 2px solid #8b7355;
            border-top: 3px dashed #6b5d47;
            border-bottom: 2px solid #8b7355;
            padding: 12px 35px 12px 20px;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            width: 100%;
            max-width: 768px;
            z-index: 10000;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.4),
                inset 0 1px 2px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(139, 115, 85, 0.3);
            overflow: visible;
            min-height: 50px;
            height: auto;
            display: flex;
            align-items: center;
            font-family: 'Courier New', 'Courier', monospace;
            font-weight: normal;
            opacity: 0;
            transition: none;
            margin: 0;
        }
        
        /* Ensure parent container allows overflow for warning */
        #calculator-card {
            overflow: visible !important;
        }
        
        /* Ensure the wrapper allows the warning to be visible */
        .warning-wrapper {
            overflow: visible !important;
        }

        /* Animation: Eject with Perforation Tear - triggers when not hidden */
        .warning-container:not(.hidden) {
            animation: ejectPrintWarning 0.4s ease-out forwards;
        }

        /* Reverse animation: Slide back up when hiding */
        .warning-container.hiding {
            animation: reversePrintWarning 0.4s ease-in forwards;
            /* Don't hide immediately - let animation play */
            display: flex !important;
        }
        
        /* After reverse animation completes, apply hidden */
        .warning-container.hidden.hiding {
            animation: none;
        }

        @keyframes ejectPrintWarning {
            0% {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            30% {
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes reversePrintWarning {
            0% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            70% {
                opacity: 0;
            }
            100% {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
        }

        /* Perforation tear line overlay - appears during animation */
        .warning-container:not(.hidden)::before {
            background: 
                repeating-linear-gradient(
                    to right,
                    transparent 0px,
                    transparent 8px,
                    rgba(139, 115, 85, 0.8) 8px,
                    rgba(139, 115, 85, 0.8) 12px
                ),
                radial-gradient(circle at 20% 30%, rgba(139, 115, 85, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 115, 85, 0.08) 0%, transparent 50%),
                linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.02) 50%, transparent 100%);
            background-size: 100% 3px, 100% 100%, 100% 100%, 100% 100%;
            background-position: top, 0 0, 0 0, 0 0;
            background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
            animation: tearLineWarning 0.4s ease-out forwards;
        }

        @keyframes tearLineWarning {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                opacity: 0;
                background-size: 100% 0px, 100% 100%, 100% 100%, 100% 100%;
            }
        }

        .warning-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 115, 85, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 115, 85, 0.08) 0%, transparent 50%),
                linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.02) 50%, transparent 100%);
            pointer-events: none;
            z-index: 1;
        }

        /* Perforation tear line overlay - appears during animation */
        .warning-container:not(.hidden)::before {
            background: 
                repeating-linear-gradient(
                    to right,
                    transparent 0px,
                    transparent 8px,
                    rgba(139, 115, 85, 0.8) 8px,
                    rgba(139, 115, 85, 0.8) 12px
                ),
                radial-gradient(circle at 20% 30%, rgba(139, 115, 85, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 115, 85, 0.08) 0%, transparent 50%),
                linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.02) 50%, transparent 100%);
            background-size: 100% 3px, 100% 100%, 100% 100%, 100% 100%;
            background-position: top, 0 0, 0 0, 0 0;
            background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
            animation: tearLineWarning 0.4s ease-out forwards;
        }

        .warning-container::after {
            content: '⚠';
            position: absolute;
            left: 12px;
            font-size: 2.5rem;
            color: #8b4513;
            font-weight: bold;
            z-index: 3;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
        }

        .warning-container p {
            position: relative;
            z-index: 2;
            color: #2d1b0e;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'Courier New', 'Courier', monospace;
            font-size: 1rem;
            text-shadow: 0.5px 0.5px 1px rgba(255, 255, 255, 0.3);
            padding-left: 35px;
            margin: 0;
            flex: 1;
            overflow: visible;
            white-space: normal;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* Warning inside glass screen - resized to fit */
        .glass-screen-off .warning-container {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            width: calc(100% - 10px);
            height: calc(100% - 10px);
            padding: 3px 8px;
            border: 2px solid #8b7355;
            border-top: 2px dashed #6b5d47;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(0, 0, 0, 0.02) 1px,
                    rgba(0, 0, 0, 0.02) 2px
                ),
                linear-gradient(180deg, #f5f1e8 0%, #e8e0d0 50%, #f5f1e8 100%);
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.4),
                inset 0 1px 1px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(139, 115, 85, 0.2);
            transform: translateY(-100%);
            opacity: 0;
            transition: none;
        }

        /* Animation for glass screen version */
        .glass-screen-off .warning-container:not(.hidden) {
            animation: ejectPrintWarning 0.4s ease-out forwards;
        }

        /* Reverse animation for glass screen version */
        .glass-screen-off .warning-container.hiding {
            animation: reversePrintWarning 0.4s ease-in forwards;
            /* Don't hide immediately - let animation play */
            display: flex !important;
        }
        
        .glass-screen-off .warning-container.hidden.hiding {
            animation: none;
        }

        .glass-screen-off .warning-container.hidden {
            display: none !important;
        }

        .glass-screen-off .warning-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 15% 25%, rgba(139, 115, 85, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 85% 75%, rgba(139, 115, 85, 0.06) 0%, transparent 40%);
            pointer-events: none;
            z-index: 1;
        }

        /* Perforation tear line overlay for glass screen version */
        .glass-screen-off .warning-container:not(.hidden)::before {
            background: 
                repeating-linear-gradient(
                    to right,
                    transparent 0px,
                    transparent 6px,
                    rgba(139, 115, 85, 0.8) 6px,
                    rgba(139, 115, 85, 0.8) 10px
                ),
                radial-gradient(circle at 15% 25%, rgba(139, 115, 85, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 85% 75%, rgba(139, 115, 85, 0.06) 0%, transparent 40%);
            background-size: 100% 2px, 100% 100%, 100% 100%;
            background-position: top, 0 0, 0 0;
            background-repeat: no-repeat, no-repeat, no-repeat;
            animation: tearLineWarning 0.4s ease-out forwards;
        }

        .glass-screen-off .warning-container::after {
            content: '⚠';
            font-size: 1.6rem;
            left: 6px;
            color: #8b4513;
            font-weight: bold;
            opacity: 0.9;
            text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.2);
        }

        .glass-screen-off .warning-container .warning-text {
            font-size: 0.9rem;
            padding-left: 16px;
            text-align: center;
            color: #2d1b0e;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'Courier New', 'Courier', monospace;
            text-shadow: 0.3px 0.3px 0.5px rgba(255, 255, 255, 0.3);
        }

        .nuke-button {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.6));
            width: 100%;
        }

        .nuke-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                /* Base dark metal - matching existing scheme */
                linear-gradient(145deg, 
                    #111827 0%,
                    #1f2937 25%,
                    #18181b 50%,
                    #1f2937 75%,
                    #111827 100%
                ),
                /* Subtle wear patterns */
                radial-gradient(ellipse at 20% 30%, rgba(31, 41, 55, 0.4) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 70%, rgba(15, 23, 42, 0.3) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(17, 24, 39, 0.25) 0%, transparent 60%),
                /* Metal grain texture */
                repeating-linear-gradient(0deg, 
                    transparent 0px,
                    rgba(0, 0, 0, 0.1) 1px,
                    transparent 2px,
                    rgba(255, 255, 255, 0.02) 3px
                );
            border-radius: 4px;
            border: 3px solid;
            border-color: 
                #0f172a /* outer shadow */
                #374151 /* top-left highlight */
                #0f172a /* bottom-right shadow */
                #1f2937; /* sides */
            box-shadow: 
                /* Outer shadow */
                0 6px 20px rgba(0, 0, 0, 0.8),
                0 3px 8px rgba(0, 0, 0, 0.6),
                /* Inner depth */
                inset 0 2px 4px rgba(0, 0, 0, 0.5),
                inset 0 -2px 4px rgba(0, 0, 0, 0.7),
                /* Metal highlights */
                inset -1px -1px 2px rgba(75, 85, 99, 0.2),
                inset 1px 1px 2px rgba(0, 0, 0, 0.4),
                /* Top edge highlight */
                inset 0 1px 0 rgba(107, 114, 128, 0.15),
                /* Bottom edge shadow */
                inset 0 -1px 0 rgba(0, 0, 0, 0.6);
            z-index: 1;
        }

        /* Rivets/bolts decoration */
        .nuke-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                /* Top row rivets */
                radial-gradient(circle at 15% 12%, rgba(55, 65, 81, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 50% 12%, rgba(55, 65, 81, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 85% 12%, rgba(55, 65, 81, 0.8) 2px, transparent 2px),
                /* Bottom row rivets */
                radial-gradient(circle at 15% 88%, rgba(55, 65, 81, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 50% 88%, rgba(55, 65, 81, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 85% 88%, rgba(55, 65, 81, 0.8) 2px, transparent 2px),
                /* Rivet highlights */
                radial-gradient(circle at 15% 12%, rgba(107, 114, 128, 0.4) 1px, transparent 1px),
                radial-gradient(circle at 50% 12%, rgba(107, 114, 128, 0.4) 1px, transparent 1px),
                radial-gradient(circle at 85% 12%, rgba(107, 114, 128, 0.4) 1px, transparent 1px),
                radial-gradient(circle at 15% 88%, rgba(107, 114, 128, 0.4) 1px, transparent 1px),
                radial-gradient(circle at 50% 88%, rgba(107, 114, 128, 0.4) 1px, transparent 1px),
                radial-gradient(circle at 85% 88%, rgba(107, 114, 128, 0.4) 1px, transparent 1px);
            border-radius: 4px;
            z-index: 2;
            pointer-events: none;
        }

        .nuke-button-text {
            position: relative;
            z-index: 3;
            display: block;
            padding: 20px 50px;
            color: var(--ink);
            text-shadow: 
                /* Main text shadow */
                2px 2px 4px rgba(0, 0, 0, 0.9),
                1px 1px 2px rgba(0, 0, 0, 0.8),
                /* Subtle inner glow */
                0 0 8px rgba(215, 213, 204, 0.2),
                /* Stencil effect */
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
            font-size: 1.1rem;
            letter-spacing: 0.2em;
            transition: all 0.3s ease;
            width: 100%;
        }

        /* Warning stripes on sides - keeping the cool yellow/orange danger marks */
        .nuke-button-warning {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 60%;
            background: repeating-linear-gradient(
                45deg,
                #fbbf24 0px,
                #fbbf24 4px,
                #f59e0b 4px,
                #f59e0b 8px
            );
            border-radius: 2px 0 0 2px;
            z-index: 2;
            opacity: 0.8;
            box-shadow: inset 1px 0 2px rgba(0, 0, 0, 0.5), 0 0 4px rgba(251, 191, 36, 0.3);
        }

        .nuke-button-warning-right {
            left: auto;
            right: 0;
            border-radius: 0 2px 2px 0;
            box-shadow: inset -1px 0 2px rgba(0, 0, 0, 0.5);
        }

        .nuke-button:hover {
            transform: translateY(-2px);
            filter: drop-shadow(0 10px 24px rgba(0, 0, 0, 0.8)) 
                    drop-shadow(0 0 12px rgba(251, 191, 36, 0.3));
        }

        .nuke-button:hover::before {
            box-shadow: 
                0 8px 24px rgba(0, 0, 0, 0.9),
                0 4px 10px rgba(0, 0, 0, 0.7),
                inset 0 2px 4px rgba(0, 0, 0, 0.5),
                inset 0 -2px 4px rgba(0, 0, 0, 0.7),
                inset -1px -1px 2px rgba(75, 85, 99, 0.3),
                inset 1px 1px 2px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(107, 114, 128, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.6),
                /* Hover glow */
                0 0 20px rgba(251, 191, 36, 0.15);
            border-color: 
                #0f172a
                #4b5563
                #0f172a
                #374151;
        }

        .nuke-button:hover .nuke-button-text {
            color: #f3f4f6;
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.9),
                1px 1px 2px rgba(0, 0, 0, 0.8),
                0 0 12px rgba(243, 244, 246, 0.3),
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
        }

        .nuke-button:active {
            transform: translateY(0px);
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.8));
        }

        .nuke-button:active::before {
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.8),
                0 1px 4px rgba(0, 0, 0, 0.6),
                inset 0 4px 8px rgba(0, 0, 0, 0.7),
                inset 0 -2px 4px rgba(0, 0, 0, 0.5),
                inset 1px 1px 3px rgba(0, 0, 0, 0.6),
                inset -1px -1px 2px rgba(55, 65, 81, 0.2),
                inset 0 2px 0 rgba(0, 0, 0, 0.6),
                inset 0 -1px 0 rgba(75, 85, 99, 0.15);
            border-color: 
                #0f172a
                #111827
                #1f2937
                #18181b;
        }

        .nuke-button:active .nuke-button-text {
            color: #d1d5db;
            transform: translateY(1px);
        }

        /* Strong focus highlight for keyboard navigation */
        .military-input:focus {
            background: rgba(15, 15, 16, 0.6) !important;
            border: 2px solid rgba(156, 163, 175, 0.5) !important;
            box-shadow: 
                inset 0 0 25px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                0 3px 10px rgba(0, 0, 0, 0.5),
                0 0 0 2px rgba(156, 163, 175, 0.3),
                0 0 15px rgba(156, 163, 175, 0.2) !important;
            color: #ffffff !important;
        }

        /* Hover highlight for inputs */
        .military-input:hover {
            background: rgba(15, 15, 16, 0.5) !important;
            border: 2px solid rgba(156, 163, 175, 0.4) !important;
            box-shadow: 
                inset 0 0 22px rgba(0, 0, 0, 0.55),
                inset 0 1px 0 rgba(255, 255, 255, 0.12),
                0 2px 8px rgba(0, 0, 0, 0.45),
                0 0 0 1px rgba(156, 163, 175, 0.15) !important;
        }

        /* Hover highlight for elevation value */
        #elevationValue:hover {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .nuke-button:focus {
            outline: none;
        }

        .nuke-button:focus-visible {
            outline: 3px solid rgba(139, 115, 85, 0.6);
            outline-offset: 4px;
        }

        /* Armored panel ruler styling */
        .armored-ruler {
            width: 100%;
            height: 30px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 2px solid #4a4a4a;
            position: relative;
            margin: 10px 0 20px 0;
            box-shadow: inset 0 4px 12px rgba(0, 0, 0, 0.8);
            cursor: grab;
            box-sizing: border-box;
            padding: 2px; /* inset content so marks/indicator sit fully inside the box */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .armored-ruler:active {
            cursor: grabbing;
        }

        .armored-ruler-mark {
            position: absolute;
            bottom: 0;
            width: 2px;
            height: 15px;
            background: #6a6a6a;
            z-index: 1;
            backface-visibility: hidden;
            will-change: transform;
            image-rendering: crisp-edges;
            -webkit-font-smoothing: antialiased;
        }

        .armored-ruler-mark.major {
            height: 26px;
            background: #8a8a8a;
        }

        .armored-ruler-indicator {
            position: absolute;
            bottom: 0;
            width: 4px;
            height: 26px;
            background: #c2b280;
            box-shadow: 0 0 10px rgba(194, 178, 128, 0.6);
            transform: translate3d(-50%, 0, 0);
            transition: left 0.2s ease;
            pointer-events: none;
            z-index: 10;
            backface-visibility: hidden;
            will-change: transform, left;
            image-rendering: crisp-edges;
        }

        .armored-ruler-indicator::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translate3d(-50%, 0, 0);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid #c2b280;
            filter: drop-shadow(0 0 5px rgba(194, 178, 128, 0.6));
            backface-visibility: hidden;
        }

        .armored-ruler-label {
            position: absolute;
            top: 34px;
            transform: translate3d(-50%, 0, 0);
            font-size: 13px;
            color: #9ca3af;
            font-weight: bold;
            white-space: nowrap;
            z-index: 5;
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            backface-visibility: hidden;
            will-change: transform;
        }

        .armored-ruler-label.minor {
            font-size: 10px;
            color: #6a6a6a;
            top: 34px;
        }

        /* Center distance input controls in the calculator box */
        .distance-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            margin-top: 0;
            margin-left: auto;
            margin-right: auto;
        }

        /* Military toggle button animation */
        #snapToggle ~ div > span,
        #autoCalcToggle ~ div > span {
            transition: transform 200ms ease-out;
        }
        #snapToggle:checked ~ div > span {
            transform: translateX(29px) !important;
        }
        #autoCalcToggle:checked ~ div > span {
            transform: translateX(29px) !important;
        }
        
        /* LED light styles for toggle labels */
        .toggle-label-off,
        .toggle-label-on {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            transition: all 0.3s ease;
            text-shadow: none;
            color: #6b7280; /* Dim gray when off */
        }
        
        /* LED OFF state - Red glow for inactive state */
        .led-off {
            color: #ef4444 !important; /* Red */
            text-shadow: 
                0 0 8px rgba(239, 68, 68, 0.8),
                0 0 12px rgba(239, 68, 68, 0.6),
                0 0 16px rgba(239, 68, 68, 0.4);
            font-weight: 700;
        }
        
        /* LED ON state - Green glow for active state */
        .led-on-green {
            color: #22c55e !important; /* Green */
            text-shadow: 
                0 0 8px rgba(34, 197, 94, 0.8),
                0 0 12px rgba(34, 197, 94, 0.6),
                0 0 16px rgba(34, 197, 94, 0.4);
            font-weight: 700;
        }
        
                
        /* WWII Military Design Enhancements - Dark classified theme */
        .military-grid {
            background-color: #111827; /* Dark gray/black base */
            background-image:
                /* Subtle noise */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E"),
                /* Grid lines */
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 200px 200px, 20px 20px, 20px 20px;
            background-position: center top;
            background-repeat: repeat;
            position: relative;
        }

        /* ============================================
           ARMORED PANEL DESIGN
           ============================================ */
        .armored-panel-container {
            background: 
                /* Base metal gradient with depth - TONED DARKNESS */
                linear-gradient(145deg, 
                    #1a1a1a 0%,
                    #0f0f0f 25%,
                    #0a0a0a 50%,
                    #0f0f0f 75%,
                    #1a1a1a 100%
                ),
                /* Metal grain texture */
                repeating-linear-gradient(0deg, 
                    transparent 0px,
                    rgba(0, 0, 0, 0.25) 1px,
                    transparent 2px,
                    rgba(50, 50, 50, 0.03) 3px,
                    transparent 4px
                ),
                /* Vertical wear patterns */
                repeating-linear-gradient(90deg,
                    transparent 0px,
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 2px
                ),
                /* Rust and wear spots - darker */
                radial-gradient(ellipse at 20% 30%, rgba(30, 20, 10, 0.12) 0%, transparent 30%),
                radial-gradient(ellipse at 80% 70%, rgba(25, 15, 8, 0.1) 0%, transparent 35%),
                radial-gradient(ellipse at 50% 10%, rgba(20, 12, 5, 0.08) 0%, transparent 25%),
                /* Scratches and scuffs */
                repeating-linear-gradient(45deg,
                    transparent 0px,
                    transparent 40px,
                    rgba(0, 0, 0, 0.3) 40px,
                    rgba(0, 0, 0, 0.3) 41px,
                    transparent 41px,
                    transparent 80px
                );
            /* BEVELED EDGES - Strong top-left highlight, dark bottom-right shadow */
            border: 6px solid;
            border-color: 
                #1a1a1a /* top - lighter */
                #1a1a1a /* right - lighter */
                #000000 /* bottom - darkest */
                #000000; /* left - darkest */
            border-top-color: #2a2a2a;
            border-left-color: #2a2a2a;
            border-bottom-color: #000000;
            border-right-color: #000000;
            box-shadow: 
                /* Outer 3D depth */
                0 12px 30px rgba(0, 0, 0, 0.4),
                0 6px 15px rgba(0, 0, 0, 0.3),
                0 3px 8px rgba(0, 0, 0, 0.25),
                /* BEVELED EDGE EFFECTS - Top-left highlight */
                inset -6px -6px 12px rgba(0, 0, 0, 0.9),
                inset 6px 6px 12px rgba(0, 0, 0, 0.9),
                /* Top edge bright highlight */
                inset 0 6px 0 rgba(60, 60, 60, 0.3),
                inset 0 4px 0 rgba(40, 40, 40, 0.2),
                /* Left edge highlight */
                inset 6px 0 0 rgba(60, 60, 60, 0.3),
                inset 4px 0 0 rgba(40, 40, 40, 0.2),
                /* Bottom edge deep shadow */
                inset 0 -6px 0 rgba(0, 0, 0, 0.95),
                inset 0 -4px 0 rgba(0, 0, 0, 0.9),
                /* Right edge deep shadow */
                inset -6px 0 0 rgba(0, 0, 0, 0.95),
                inset -4px 0 0 rgba(0, 0, 0, 0.9),
                /* Inner depth */
                inset 0 0 20px rgba(0, 0, 0, 0.8);
            position: relative;
            padding: 30px 40px;
            width: 765px;
            margin: 0 auto;
            overflow: visible;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            transform: perspective(1000px) rotateX(0deg);
        }

        .armored-panel-container::before {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            background: 
                linear-gradient(145deg, 
                    #2a2a2a 0%,
                    #1a1a1a 25%,
                    #0f0f0f 50%,
                    #1a1a1a 75%,
                    #2a2a2a 100%
                ),
                repeating-linear-gradient(0deg,
                    transparent 0px,
                    rgba(0, 0, 0, 0.3) 1px,
                    transparent 2px
                );
            z-index: -1;
            border-radius: 8px;
            box-shadow: 
                0 0 0 2px rgba(0, 0, 0, 0.5),
                0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .armored-panel-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                /* Top bevel highlight */
                linear-gradient(180deg, 
                    rgba(80, 80, 80, 0.4) 0%,
                    rgba(80, 80, 80, 0.2) 2%,
                    transparent 4%
                ),
                /* Left bevel highlight */
                linear-gradient(90deg, 
                    rgba(80, 80, 80, 0.4) 0%,
                    rgba(80, 80, 80, 0.2) 2%,
                    transparent 4%
                ),
                /* Bottom bevel shadow */
                linear-gradient(0deg, 
                    rgba(0, 0, 0, 0.8) 0%,
                    rgba(0, 0, 0, 0.4) 2%,
                    transparent 4%
                ),
                /* Right bevel shadow */
                linear-gradient(270deg, 
                    rgba(0, 0, 0, 0.8) 0%,
                    rgba(0, 0, 0, 0.4) 2%,
                    transparent 4%
                );
            pointer-events: none;
            z-index: 1;
            border-radius: 2px;
        }

        /* 3D Rivets - Main box only */
        .armored-rivet {
            position: absolute;
            width: 20px;
            height: 20px;
            background: 
                radial-gradient(circle at 30% 30%, 
                    rgba(200, 200, 200, 0.6) 0%,
                    rgba(150, 150, 150, 0.5) 15%,
                    rgba(120, 120, 120, 0.4) 25%,
                    #5a5a5a 40%,
                    #3a3a3a 60%,
                    #2a2a2a 80%,
                    #1a1a1a 100%
                ),
                radial-gradient(circle, #4a4a4a 0%, #1a1a1a 100%);
            border: 3px solid;
            border-color: 
                #0a0a0a
                rgba(150, 150, 150, 0.5)
                #0a0a0a
                rgba(120, 120, 120, 0.4);
            border-radius: 50%;
            box-shadow: 
                /* 3D raised effect - more prominent */
                0 6px 12px rgba(0, 0, 0, 0.95),
                0 3px 6px rgba(0, 0, 0, 0.9),
                0 1px 3px rgba(0, 0, 0, 0.8),
                /* Inner depth */
                inset 0 3px 6px rgba(0, 0, 0, 0.8),
                inset 0 -2px 3px rgba(150, 150, 150, 0.3),
                /* Top highlight - brighter */
                inset 0 2px 0 rgba(200, 200, 200, 0.5),
                inset 0 1px 0 rgba(180, 180, 180, 0.4),
                /* Bottom shadow */
                inset 0 -3px 0 rgba(0, 0, 0, 0.9),
                /* Center depression */
                inset 0 0 10px rgba(0, 0, 0, 0.6),
                /* Outer glow for visibility */
                0 0 4px rgba(100, 100, 100, 0.3);
            z-index: 10;
        }

        .armored-rivet-top-left { top: 10px; left: 10px; }
        .armored-rivet-top-right { top: 10px; right: 10px; }
        .armored-rivet-bottom-left { bottom: 10px; left: 10px; }
        .armored-rivet-bottom-right { bottom: 10px; right: 10px; }

        /* Smaller rivets for secondary panels */
        .armored-rivet-small {
            position: absolute;
            width: 14px;
            height: 14px;
            background: 
                radial-gradient(circle at 30% 30%, 
                    rgba(120, 120, 120, 0.7) 0%,
                    rgba(100, 100, 100, 0.6) 15%,
                    rgba(80, 80, 80, 0.5) 30%,
                    #4a4a4a 50%,
                    #3a3a3a 70%,
                    #2a2a2a 100%
                );
            border: 1.5px solid #1a1a1a;
            border-radius: 50%;
            box-shadow: 
                0 3px 6px rgba(0, 0, 0, 0.8),
                inset 0 1px 3px rgba(0, 0, 0, 0.6),
                inset 0 -1px 2px rgba(120, 120, 120, 0.3),
                inset 0 1px 0 rgba(120, 120, 120, 0.4),
                0 0 4px rgba(100, 100, 100, 0.4);
            z-index: 10;
        }

        .armored-rivet-small-top-left { top: 8px; left: 8px; }
        .armored-rivet-small-top-right { top: 8px; right: 8px; }
        .armored-rivet-small-bottom-left { bottom: 8px; left: 8px; }
        .armored-rivet-small-bottom-right { bottom: 8px; right: 8px; }

        /* Pan head screw style for metal panel */
        .screw-pan-head {
            width: 25px;
            height: 25px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .screw-pan-head::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse 100% 60% at center, 
                    rgba(190, 190, 190, 0.6) 0%,
                    rgba(150, 150, 150, 0.5) 20%,
                    #5a5a5a 40%,
                    #3a3a3a 60%,
                    #2a2a2a 80%,
                    #1a1a1a 100%
                );
            border-radius: 50%;
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.7),
                0 2px 4px rgba(0, 0, 0, 0.6),
                inset 0 3px 6px rgba(190, 190, 190, 0.3),
                inset 0 -2px 4px rgba(0, 0, 0, 0.6),
                inset 0 0 15px rgba(0, 0, 0, 0.4);
        }
        
        .screw-pan-head::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 100%;
            height: 16%;
            background: #0a0a0a;
        }
        
        .screw-left {
            left: 8px;
            transform: translateY(-50%) rotate(25deg);
        }
        
        .screw-right {
            right: 8px;
            transform: translateY(-50%) rotate(-12deg);
        }

        .panel-section {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%);
            border: 2px solid #3a3a3a;
            padding: 12px 15px;
            margin: 8px 0;
            box-shadow: 
                inset 0 2px 8px rgba(0, 0, 0, 0.6),
                0 4px 12px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .panel-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #5a5a5a, transparent);
        }

        .panel-label {
            font-size: 0.95rem;
            color: #c2b280;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-align: center;
        }

        .glass-screen-off {
            width: 100%;
            height: 50px;
            background: linear-gradient(135deg, #0a0a0a 0%, #050505 50%, #0a0a0a 100%);
            border: 2px solid #1a1a1a;
            border-radius: 4px;
            box-shadow: 
                inset 0 2px 8px rgba(0, 0, 0, 0.9),
                inset 0 -2px 4px rgba(0, 0, 0, 0.7),
                0 0 20px rgba(0, 0, 0, 0.8),
                inset 0 0 30px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }

        .glass-screen-off::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(180deg, rgba(20, 20, 20, 0.3) 0%, transparent 50%),
                linear-gradient(90deg, transparent 0%, rgba(10, 10, 10, 0.4) 50%, transparent 100%);
            pointer-events: none;
        }

        .glass-screen-off::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 2px,
                rgba(0, 0, 0, 0.1) 4px
            );
            opacity: 0.3;
            pointer-events: none;
        }

        .armored-button {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            border: 2px solid #4a4a4a;
            border-top: 2px solid #5a5a5a;
            border-left: 2px solid #5a5a5a;
            color: #e5e7eb;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.5),
                0 4px 8px rgba(0, 0, 0, 0.6);
            transition: all 0.2s ease;
            position: relative;
            font-family: 'Courier New', monospace;
        }

        .armored-button::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .armored-button:hover {
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            transform: translateY(-2px);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.4),
                0 6px 12px rgba(0, 0, 0, 0.7);
        }

        .armored-button:active {
            transform: translateY(0);
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.7);
        }

        .armored-input {
            width: 112px;
            height: 52px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 2px solid #4a4a4a;
            border-top: 2px solid #2a2a2a;
            color: #e5e7eb;
            font-size: 1.3rem;
            text-align: center;
            font-weight: bold;
            box-shadow: 
                inset 0 4px 12px rgba(0, 0, 0, 0.8),
                0 2px 4px rgba(0, 0, 0, 0.4);
            font-family: 'Courier New', monospace;
        }

        .armored-input:focus {
            outline: none;
            border-color: #c2b280;
            box-shadow: 
                inset 0 4px 12px rgba(0, 0, 0, 0.8),
                0 0 10px rgba(194, 178, 128, 0.3);
        }

        .armored-toggle-container {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
        }

        .armored-toggle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .armored-toggle-label {
            font-size: 0.8rem;
            color: #9ca3af;
            text-transform: uppercase;
        }

        .armored-toggle-switch {
            width: 60px;
            height: 30px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 2px solid #4a4a4a;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.7);
        }

        .armored-toggle-switch::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: linear-gradient(145deg, #5a5a5a, #3a3a3a);
            border: 1px solid #2a2a2a;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
        }

        .armored-toggle-switch.active {
            background: linear-gradient(180deg, #8b6914 0%, #6b5010 100%);
        }

        .armored-toggle-switch.active::before {
            left: 32px;
            background: linear-gradient(145deg, #c2b280, #8b6914);
        }

        .armored-calculate {
            width: 100%;
            padding: 12px;
            background: linear-gradient(145deg, #4a3a1a, #2a1f0f);
            border: 3px solid #6b5010;
            border-top: 3px solid #8b6914;
            color: #fcd34d;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            cursor: pointer;
            box-shadow: 
                inset 0 4px 12px rgba(0, 0, 0, 0.7),
                0 6px 20px rgba(0, 0, 0, 0.8);
            margin-top: 8px;
            position: relative;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }

        .armored-calculate::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(252, 211, 77, 0.2), transparent);
            transition: left 0.5s;
        }

        .armored-calculate:hover::before {
            left: 100%;
        }

        .armored-calculate:hover {
            background: linear-gradient(145deg, #5a4a2a, #3a2f1f);
            transform: translateY(-2px);
            box-shadow: 
                inset 0 4px 12px rgba(0, 0, 0, 0.6),
                0 8px 24px rgba(0, 0, 0, 0.9);
        }

        /* Metal panel to replace calculate button when auto calc is on */
        .armored-metal-panel {
            width: 100%;
            padding: 12px;
            background: 
                /* Base metal gradient with depth */
                linear-gradient(145deg, 
                    #1a1a1a 0%,
                    #0f0f0f 25%,
                    #0a0a0a 50%,
                    #0f0f0f 75%,
                    #1a1a1a 100%
                ),
                /* Metal grain texture */
                repeating-linear-gradient(0deg, 
                    transparent 0px,
                    rgba(0, 0, 0, 0.25) 1px,
                    transparent 2px,
                    rgba(50, 50, 50, 0.03) 3px,
                    transparent 4px
                ),
                /* Vertical wear patterns */
                repeating-linear-gradient(90deg,
                    transparent 0px,
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 2px
                ),
                /* Rust and wear spots */
                radial-gradient(ellipse at 20% 30%, rgba(30, 20, 10, 0.12) 0%, transparent 30%),
                radial-gradient(ellipse at 80% 70%, rgba(25, 15, 8, 0.1) 0%, transparent 35%),
                radial-gradient(ellipse at 50% 10%, rgba(20, 12, 5, 0.08) 0%, transparent 25%),
                /* Scratches and scuffs */
                repeating-linear-gradient(45deg,
                    transparent 0px,
                    transparent 40px,
                    rgba(0, 0, 0, 0.3) 40px,
                    rgba(0, 0, 0, 0.3) 41px,
                    transparent 41px,
                    transparent 80px
                );
            border: 3px solid;
            border-color: 
                #2a2a2a /* top - lighter */
                #1a1a1a /* right */
                #000000 /* bottom - darkest */
                #1a1a1a; /* left */
            box-shadow: 
                inset 0 4px 12px rgba(0, 0, 0, 0.7),
                0 6px 20px rgba(0, 0, 0, 0.8);
            margin-top: 8px;
            position: relative;
            box-sizing: border-box;
            height: 54px; /* Match calculate button height exactly */
        }

        .armored-result {
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 2px solid #4a4a4a;
            padding: 25px;
            margin-top: 8px;
            text-align: center;
            box-shadow: 
                inset 0 4px 12px rgba(0, 0, 0, 0.8);
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            position: relative;
        }
        
        .copy-result-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(252, 211, 77, 0.2);
            border: 1px solid rgba(252, 211, 77, 0.4);
            color: #fcd34d;
            padding: 0;
            padding-top: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 2px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            line-height: 1;
            text-align: center;
        }
        
        .copy-result-button:hover {
            background: rgba(252, 211, 77, 0.3);
            border-color: rgba(252, 211, 77, 0.6);
        }
        
        .copy-result-button:active {
            background: rgba(252, 211, 77, 0.4);
        }
        
        .copy-result-button.copied {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.6);
            color: #4ade80;
        }
        
        .reset-result-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(252, 211, 77, 0.2);
            border: 1px solid rgba(252, 211, 77, 0.4);
            color: #fcd34d;
            padding: 0;
            padding-top: 2px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 2px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            line-height: 1;
            text-align: center;
            font-family: 'SpecialElite', monospace;
        }
        
        .reset-result-button:hover {
            background: rgba(252, 211, 77, 0.3);
            border-color: rgba(252, 211, 77, 0.6);
        }
        
        .reset-result-button:active {
            background: rgba(252, 211, 77, 0.4);
        }
        
        .reset-result-button.resetting {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.6);
            color: #4ade80;
        }

        .armored-result-value {
            font-family: 'Courier New', 'Courier', monospace;
            font-size: 3rem;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            margin: 15px auto;
            border: 2px solid #8b6914;
            padding: 0 40px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.8);
            text-align: center;
            height: 80px;
            line-height: 80px;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: auto;
            min-width: 380px;
        }
        
        /* Decorative military-style vertical lines on sides */
        .armored-result-value::before,
        .armored-result-value::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 8px,
                    rgba(255, 255, 255, 0.2) 8px,
                    rgba(255, 255, 255, 0.2) 10px
                ),
                linear-gradient(
                    180deg,
                    transparent 0%,
                    rgba(139, 115, 85, 0.3) 10%,
                    rgba(255, 255, 255, 0.4) 20%,
                    rgba(255, 255, 255, 0.5) 30%,
                    rgba(255, 255, 255, 0.5) 70%,
                    rgba(255, 255, 255, 0.4) 80%,
                    rgba(139, 115, 85, 0.3) 90%,
                    transparent 100%
                );
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        .armored-result-value::before {
            left: 12px;
        }
        
        .armored-result-value::after {
            right: 12px;
        }
        
        .mechanical-counter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            height: 80px;
            vertical-align: top;
        }
        
        .digit-wheel {
            display: inline-block;
            position: relative;
            width: 0.7em;
            height: 80px;
            overflow: hidden;
            font-variant-numeric: tabular-nums;
            font-weight: 700;
            text-align: center;
        }
        
        .digit-strip {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        
        .digit-strip.rolling {
            transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .digit-strip.snapping {
            transition: none !important;
        }
        
        .digit-cell {
            font-family: 'Courier New', 'Courier', monospace;
            height: 80px;
            line-height: 80px;
            display: block;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            padding-top: 0;
            transform: translateY(0px);
        }
        
        /* MIL label only for main display - large size */
        .armored-result-value .mil-label {
            display: inline-block;
            margin-left: 0;
            color: #ffffff;
            font-size: 3rem;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            font-variant-numeric: normal;
            vertical-align: middle;
            line-height: 80px;
            font-weight: 700;
            letter-spacing: 0;
            transform: translateY(-2px);
            padding-left: 4px;
            padding-right: 4px;
        }
        
        /* MIL label digits (letters) should have same styling as number digits */
        .armored-result-value .mil-label .digit {
            display: inline-block;
            position: relative;
            text-align: center;
            transform: translateY(0px);
            margin-right: 2px;
        }
        
        /* Small MIL labels for base value and other text - normal size */
        .mil-label {
            display: inline;
            font-size: inherit;
            color: inherit;
            text-shadow: none;
            font-weight: normal;
            letter-spacing: normal;
            line-height: normal;
            margin: 0;
        }
        
        .mil-static-counter {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 2px;
            height: 80px;
            vertical-align: top;
        }
        
        .mil-wheel {
            font-family: 'Courier New', 'Courier', monospace;
            display: inline-block;
            position: relative;
            width: 0.7em;
            height: 80px;
            overflow: hidden;
            font-variant-numeric: tabular-nums;
            font-weight: 700;
            text-align: center;
        }
        
        /* Make the first letter (M) counter box wider */
        .mil-static-counter .mil-wheel:first-child {
            width: calc(0.9em - 1px);
        }
        
        .mil-strip {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        
        .mil-cell {
            font-family: 'Courier New', 'Courier', monospace;
            height: 80px;
            line-height: 80px;
            display: block;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            padding-top: 0;
            transform: translateY(0px);
        }
        
        .armored-result-value span {
            display: inline-block;
            transform: translateY(4px);
        }
        
        .armored-result-value .digit {
            display: inline-block;
            position: relative;
            font-variant-numeric: tabular-nums;
            min-width: 0.6em;
            text-align: center;
            transform: translateY(0px);
        }
        
        /* Vertical separator lines between all elements for odometer look - matching demo style */
        /* Add separator after each digit in elevationValue, but not after the last one */
        #elevationValue .digit:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(139, 115, 85, 0.3) 10%,
                rgba(255, 255, 255, 0.4) 20%,
                rgba(255, 255, 255, 0.5) 30%,
                rgba(255, 255, 255, 0.5) 70%,
                rgba(255, 255, 255, 0.4) 80%,
                rgba(139, 115, 85, 0.3) 90%,
                transparent 100%
            );
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        /* Add separator before first digit (for minus sign or first number) */
        .armored-result-value .digit:first-child::before {
            content: '';
            position: absolute;
            left: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(139, 115, 85, 0.3) 10%,
                rgba(255, 255, 255, 0.4) 20%,
                rgba(255, 255, 255, 0.5) 30%,
                rgba(255, 255, 255, 0.5) 70%,
                rgba(255, 255, 255, 0.4) 80%,
                rgba(139, 115, 85, 0.3) 90%,
                transparent 100%
            );
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        /* Add separator before MIL label (before first letter) */
        .armored-result-value .mil-label .digit:first-child::before {
            content: '';
            position: absolute;
            left: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(139, 115, 85, 0.3) 10%,
                rgba(255, 255, 255, 0.4) 20%,
                rgba(255, 255, 255, 0.5) 30%,
                rgba(255, 255, 255, 0.5) 70%,
                rgba(255, 255, 255, 0.4) 80%,
                rgba(139, 115, 85, 0.3) 90%,
                transparent 100%
            );
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        /* Add separator after each MIL letter (including the last one to complete odometer) */
        .armored-result-value .mil-label .digit::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(139, 115, 85, 0.3) 10%,
                rgba(255, 255, 255, 0.4) 20%,
                rgba(255, 255, 255, 0.5) 30%,
                rgba(255, 255, 255, 0.5) 70%,
                rgba(255, 255, 255, 0.4) 80%,
                rgba(139, 115, 85, 0.3) 90%,
                transparent 100%
            );
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        /* Add spacing between digits for better separation */
        .armored-result-value .digit {
            margin-right: 2px;
            position: relative;
        }
        
        /* Ensure MIL label has relative positioning for separator */
        .armored-result-value .mil-label {
            position: relative;
        }
        
        /* All animations removed - no animations on final value */

        /* Old animation styles removed - no longer used */

        /* Armored slider styling */
        .armored-slider {
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%) !important;
            border: 2px solid #4a4a4a !important;
            box-shadow: 
                inset 0 4px 12px rgba(0, 0, 0, 0.8),
                0 2px 4px rgba(0, 0, 0, 0.4) !important;
        }

        /* Fix calculator card width so grid lines hit both left and right edges cleanly */
        .calculator-card {
            width: 765px;
            margin: 0 auto;
            padding-bottom: 30px;
            /* Paper texture background */
            background: var(--panel); 
            border: 1px solid var(--line);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(0,0,0,1);
            position: relative;
        }
        
        /* Remove TOP SECRET watermark overlay */
        .calculator-card::before {
            content: '';
            display: none;
        }
        
        /* Inner classified stamp effect - simple border */
        .calculator-card::after {
            content: '';
            position: absolute;
            top: 6px;
            left: 6px;
            right: 6px;
            bottom: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 1;
        }
        
        .dog-tags {
            color: #d1d5db;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            letter-spacing: 2px;
            text-transform: uppercase;
            font-family: 'SpecialElite', monospace;
        }
        
        .map-marker {
            position: relative;
        }

        /* Custom select styles - Armored panel aesthetic */
        .custom-select {
            position: relative;
            width: 100%;
            z-index: 100;
            overflow: visible;
            min-width: 0;
            max-width: 100%;
        }

        .select-selected {
            position: relative;
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(100, 100, 100, 0.03) 2px, rgba(100, 100, 100, 0.03) 4px);
            color: #e5e7eb;
            white-space: nowrap;
            padding: 10px 14px;
            padding-left: 10px;
            padding-right: 50px;
            border: 3px solid #3a3a3a;
            border-radius: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0;
            transition: all 0.2s;
            font-family: 'SpecialElite', monospace;
            font-size: 16px;
            line-height: 1.2;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.5),
                0 4px 12px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            min-width: 0;
        }
        
        .select-selected > * {
            flex-shrink: 0;
        }
        
        .select-selected > img {
            flex-shrink: 0;
        }
        
        /* Allow text span to shrink and truncate */
        .select-selected > span {
            flex-shrink: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-left: 0;
            transform: translateY(3px);
        }

        .select-selected::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #4a4a4a, #2a2a2a, #4a4a4a);
            z-index: -1;
            border-radius: 4px;
        }

        /* Field Manual Bookmark - Classified Document Page Tab */
        .select-info-button {
            position: absolute;
            left: calc(50% + 380px - 17px);
            top: calc(50% - 424px);
            transform: translateY(calc(-50% + 10px));
            width: 60px;
            height: 165px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: 
                /* Paper texture noise */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E"),
                /* Paper lines */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 39px,
                    rgba(160, 147, 122, 0.15) 40px,
                    rgba(160, 147, 122, 0.15) 41px,
                    transparent 42px
                ),
                /* CONFIDENTIAL red bookmark strip - right edge (solid, no bevel) */
                linear-gradient(90deg, 
                    transparent 0%,
                    transparent calc(100% - 16px),
                    #8b1a1a calc(100% - 16px),
                    #8b1a1a 100%
                ),
                /* Aged paper gradient */
                linear-gradient(180deg, 
                    #f5f1e8 0%,
                    #e8e0d0 15%,
                    #ddd4c5 50%,
                    #d4c9b8 85%,
                    #c9bdab 100%
                );
            color: #2a1f0f;
            border: 2px solid #a0937a;
            border-left: none;
            border-radius: 0 8px 8px 0;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'SpecialElite', 'Courier New', monospace;
            line-height: 1.4;
            box-shadow: 
                inset -2px 0 4px rgba(0, 0, 0, 0.1),
                -8px 0 12px rgba(0, 0, 0, 0.3),
                -4px 0 8px rgba(0, 0, 0, 0.2),
                -2px 0 4px rgba(0, 0, 0, 0.15);
            z-index: 1;
            padding: 10px 8px;
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.8), 0 1px 1px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            overflow: visible;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        .select-info-button span {
            display: block;
            position: relative;
            z-index: 3;
            pointer-events: none;
            white-space: nowrap;
            font-family: 'Arial', 'Helvetica', sans-serif;
            font-size: 13px;
            font-weight: 700;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.9), 0 1px 3px rgba(0, 0, 0, 0.5);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* CONFIDENTIAL text overlay on red bookmark strip */
        .select-info-button::before {
            content: 'CONFIDENTIAL';
            position: absolute;
            top: 0;
            right: 0;
            width: 16px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial', 'Helvetica', sans-serif;
            font-size: 9px;
            color: #ffffff;
            letter-spacing: calc(0.2em + 2px);
            text-transform: uppercase;
            font-weight: 900;
            z-index: 10;
            pointer-events: none;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 8px 0;
            white-space: nowrap;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.8), 0 1px 2px rgba(0, 0, 0, 0.6);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Worn edges and paper aging overlay */
        .select-info-button::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                /* Worn top edge */
                linear-gradient(180deg, rgba(169, 157, 139, 0.25) 0%, transparent 10%),
                /* Worn bottom edge */
                linear-gradient(0deg, rgba(169, 157, 139, 0.25) 0%, transparent 10%),
                /* Right edge shadow (book binding) */
                linear-gradient(90deg, rgba(0, 0, 0, 0.15) 0%, transparent 20%),
                /* Paper aging spots */
                radial-gradient(ellipse at 25% 20%, rgba(184, 167, 146, 0.35) 0%, transparent 35%),
                radial-gradient(ellipse at 75% 80%, rgba(184, 167, 146, 0.3) 0%, transparent 30%);
            pointer-events: none;
            border-radius: 0 8px 8px 0;
            z-index: 2;
        }

        /* Hover state - slides out further */
        .select-info-button:hover {
            left: calc(50% + 380px - 7px);
            transform: translateY(calc(-50% + 10px));
            background: 
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.1'/%3E%3C/svg%3E"),
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 39px,
                    rgba(160, 147, 122, 0.2) 40px,
                    rgba(160, 147, 122, 0.2) 41px,
                    transparent 42px
                ),
                /* CONFIDENTIAL red bookmark strip - right edge (preserved in hover) */
                linear-gradient(90deg, 
                    transparent 0%,
                    transparent calc(100% - 16px),
                    #8b1a1a calc(100% - 16px),
                    #8b1a1a 100%
                ),
                linear-gradient(180deg, 
                    #f8f4eb 0%,
                    #ebe3d3 15%,
                    #e0d7c8 50%,
                    #d7ccbb 85%,
                    #ccc0ad 100%
                );
            color: #1f1709;
            border-color: #b8a68f;
            box-shadow: 
                inset -2px 0 5px rgba(0, 0, 0, 0.12),
                -10px 0 14px rgba(0, 0, 0, 0.35),
                -5px 0 9px rgba(0, 0, 0, 0.25),
                -2px 0 4px rgba(0, 0, 0, 0.2);
        }

        /* Active state - stays at hover position when clicked */
        .select-info-button:active,
        .select-info-button:focus {
            left: calc(50% + 380px - 7px);
            transform: translateY(calc(-50% + 10px));
            box-shadow: 
                inset -2px 0 5px rgba(0, 0, 0, 0.12),
                -10px 0 14px rgba(0, 0, 0, 0.35),
                -5px 0 9px rgba(0, 0, 0, 0.25),
                -2px 0 4px rgba(0, 0, 0, 0.2);
        }

        /* Extended state - button stays extended when modal is open */
        .select-info-button.extended {
            left: calc(50% + 380px - 7px) !important;
        }


        /* Rivets on dropdown */
        .select-selected::after {
            content: '';
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #c2b280;
            transition: transform 0.2s;
            filter: drop-shadow(0 0 2px rgba(194, 178, 128, 0.5));
            z-index: 2;
        }

        .select-selected.select-arrow-active::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .select-selected:hover {
            border-color: #4a4a4a;
            background-color: #2a2a2a;
            background-image: 
                linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(100, 100, 100, 0.03) 2px, rgba(100, 100, 100, 0.03) 4px);
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.4),
                0 6px 16px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(194, 178, 128, 0.2);
        }

        .select-selected:active {
            transform: translateY(1px);
            box-shadow: 
                inset 0 0 40px rgba(0, 0, 0, 0.6),
                0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .select-items {
            position: absolute;
            background-color: #1a1a1a !important;
            background-image: 
                linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(100, 100, 100, 0.03) 2px, rgba(100, 100, 100, 0.03) 4px);
            border: 3px solid #3a3a3a;
            border-top: none;
            border-radius: 0;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1001;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.5),
                0 6px 20px rgba(0, 0, 0, 0.8);
        }

        .select-items::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #4a4a4a, #2a2a2a, #4a4a4a);
            z-index: -1;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
        }

        .select-hide {
            display: none;
        }

        .select-items div {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            color: #d4d4d8;
            background-color: #1a1a1a;
            font-family: 'SpecialElite', monospace;
            font-size: 14px;
            line-height: 1.2;
            position: relative;
            white-space: nowrap;
            min-width: 0;
        }
        
        .select-items div > * {
            flex-shrink: 0;
        }
        
        .select-items div > img {
            flex-shrink: 0;
        }

        .select-items div:hover {
            background-color: #2a2a2a;
            background-image: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #ffffff;
            box-shadow: inset 0 0 20px rgba(194, 178, 128, 0.1);
        }

        .select-items div:active {
            background-color: #1a1a1a;
            background-image: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
        }

        /* Tank specifications panel - Armored style */
        .tank-specs-panel {
            position: relative;
            background: 
                linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(100, 100, 100, 0.03) 2px, rgba(100, 100, 100, 0.03) 4px);
            border: 2px solid #3a3a3a;
            padding: 12px 14px 10px 14px;
            margin-top: 8px;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.5),
                0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .tank-specs-panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #4a4a4a, #2a2a2a, #4a4a4a);
            z-index: -1;
            border-radius: 4px;
        }


        .spec-item {
            display: flex;
            align-items: baseline;
            justify-content: flex-start;
            margin-bottom: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.3;
            position: relative;
            z-index: 2;
            text-align: left;
        }

        .spec-item:last-child {
            margin-bottom: 0;
        }

        .spec-label {
            color: #c2b280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: 0;
            flex-shrink: 0;
            font-family: 'SpecialElite', monospace;
            font-size: 12px;
        }

        .spec-value {
            color: #e5e7eb;
            font-weight: 500;
            margin-left: 7px;
            font-size: 13px;
        }

        .spec-bullet {
            color: #c2b280;
            margin-right: 5px;
            font-weight: bold;
            font-size: 9px;
        }

        .flag-icon {
            width: 30px;
            height: 22px;
            object-fit: contain;
            border-radius: 0;
            display: block;
            flex-shrink: 0;
            align-self: center;
            transform: translateY(1px);
            margin-right: 4px;
        }

        /* Info icon and modal styles - Classified theme */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: transparent;
            color: #9ca3af;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
            line-height: 1;
            padding: 0;
            border: 1px solid #4b5563;
            transform: translateY(2px);
        }

        .info-icon:hover {
            background-color: #374151;
            color: #ffffff;
            border-color: #9ca3af;
        }

        .info-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
        }

        .info-modal-content {
            background: 
                linear-gradient(180deg, #f5f0e8 0%, #e8e0d0 100%),
                url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h100v100H0z' fill='%23f5f0e8'/%3E%3Cpath d='M0 0l100 100M100 0L0 100' stroke='%23d0c8b8' stroke-width='0.5' opacity='0.3'/%3E%3C/svg%3E");
            margin: 3% auto;
            padding: 0;
            border: 2px solid #8b6914;
            border-radius: 0;
            width: 80%;
            max-width: 850px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.6),
                inset 0 0 100px rgba(139, 105, 20, 0.1);
            position: relative;
            font-family: 'Courier New', monospace;
            color: #2a2a2a;
        }

        /* Field Manual Watermark */
        .info-modal-content::before {
            content: 'CONFIDENTIAL';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 4rem;
            color: rgba(139, 105, 20, 0.08);
            letter-spacing: 0.3em;
            font-family: 'SpecialElite', monospace;
            font-weight: bold;
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
        }

        /* Paper texture lines */
        .info-modal-content::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 25px, rgba(139, 105, 20, 0.03) 25px, rgba(139, 105, 20, 0.03) 26px);
            pointer-events: none;
            z-index: 1;
        }

        /* Document header bar with classification */
        .info-modal-header::before {
            content: 'CONFIDENTIAL';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 24px;
            background: linear-gradient(180deg, #8b1a1a 0%, #6b1010 100%);
            border-bottom: 2px solid #5a0a0a;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 1px;
            font-family: 'SpecialElite', monospace;
            font-size: 17px;
            color: #ffffff;
            letter-spacing: 0.6em;
            text-transform: uppercase;
            font-weight: bold;
            z-index: 1;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Document number stamp - moved to bottom of header */
        .info-modal-header::after {
            content: 'DOC-1944-███';
            position: absolute;
            bottom: 8px;
            left: 20px;
            font-family: 'Courier New', monospace;
            font-size: 8px;
            color: #000000;
            letter-spacing: 0.1em;
            z-index: 3;
            pointer-events: none;
            background: transparent;
            padding: 0;
            border: none;
        }

        .info-modal-header {
            background: transparent;
            border-bottom: 1px solid #d0c8b8;
            padding: 20px;
            padding-top: 50px;
            padding-bottom: 50px;
            min-height: 140px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            z-index: 2;
        }

        /* Field Manual Text Elements */
        .field-manual-text {
            position: absolute;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #5a5a5a;
            z-index: 3;
            pointer-events: none;
            line-height: 1.4;
        }

        .field-manual-title {
            top: 28px;
            left: 20px;
            font-weight: bold;
            font-size: 16px;
            color: #8b6914;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .field-manual-subtitle {
            top: 50px;
            left: 20px;
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
        }

        .field-manual-date {
            bottom: 24px;
            right: 20px;
            text-align: right;
            font-size: 9px;
            color: #000000;
        }

        .field-manual-unit {
            bottom: 8px;
            right: 20px;
            text-align: right;
            font-size: 9px;
            color: #000000;
        }

        .field-manual-reference {
            top: 70px;
            left: 20px;
            font-size: 11px;
            color: #000000;
        }

        .info-modal-close {
            color: #8b6914;
            font-size: 43px;
            font-weight: normal;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: auto;
            height: auto;
            position: absolute;
            top: 38px;
            right: 20px;
            line-height: 1;
            z-index: 10;
        }

        .info-modal-close:hover {
            color: #6b5010;
        }

        .info-modal-close:active {
            transform: scale(0.95);
        }

        .info-modal h3 {
            color: #2a2a2a;
            margin: 0;
            font-size: 19px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            font-family: 'SpecialElite', monospace;
        }

        .info-modal-tabs {
            display: flex;
            background: transparent;
            border-bottom: 2px solid #8b6914;
            gap: 0;
            position: relative;
            z-index: 2;
        }

        .info-modal-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            color: #5a5a5a;
            border: none;
            cursor: pointer;
            font-family: 'SpecialElite', monospace;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .info-modal-tab:hover {
            background: rgba(255, 255, 255, 0.3);
            color: #2a2a2a;
        }

        .info-modal-tab.active {
            background: rgba(255, 255, 255, 0.5);
            color: #8b6914;
            border-bottom: 3px solid #8b6914;
            font-weight: bold;
        }

        .info-modal-body {
            padding: 20px;
            max-height: calc(85vh - 200px);
            overflow-y: auto;
            background: transparent;
            position: relative;
            z-index: 2;
        }

        .info-modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .info-modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.3);
            border-left: 1px solid #d0c8b8;
        }

        .info-modal-body::-webkit-scrollbar-thumb {
            background: #8b6914;
        }

        .info-modal-body::-webkit-scrollbar-thumb:hover {
            background: #6b5010;
        }

        .info-modal-section {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid #d0c8b8;
            border-left: 4px solid #8b6914;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }


        .info-modal-section h4 {
            color: #2a2a2a;
            margin-bottom: 12px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: bold;
            border-bottom: 2px solid #8b6914;
            padding-bottom: 5px;
            display: inline-block;
            font-family: 'SpecialElite', monospace;
        }

        .info-modal-section p {
            color: #2a2a2a;
            line-height: 1.6;
            margin: 0;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        .info-modal-section ul {
            color: #2a2a2a;
            margin: 8px 0;
            padding-left: 0;
            list-style: none;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        .info-modal-section ul li::before {
            content: "- ";
            color: #8b6914;
            margin-right: 8px;
            font-weight: bold;
        }

        .info-modal-section li {
            margin-bottom: 6px;
            line-height: 1.6;
        }

        /* Typewriter note styles - looks like typed annotation */
        .typewriter-note {
            position: relative;
            padding: 12px 16px;
            margin: 12px 0;
            background: rgba(255, 255, 255, 0.4);
            border-left: 3px solid;
            border-top: 1px dashed;
            border-bottom: 1px dashed;
            border-right: 1px dashed;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
            transform: rotate(-0.5deg);
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .typewriter-excelled {
            border-left-color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
            margin-left: 20px;
            margin-right: -10px;
        }

        .typewriter-struggled {
            border-left-color: #dc2626;
            border-color: rgba(220, 38, 38, 0.3);
            background: rgba(220, 38, 38, 0.05);
            margin-left: 20px;
            margin-right: -10px;
            transform: rotate(0.5deg);
        }

        .typewriter-label {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 10px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-style: normal;
        }

        .typewriter-excelled .typewriter-label {
            color: #16a34a;
            text-shadow: 0 0 2px rgba(34, 197, 94, 0.3);
        }

        .typewriter-struggled .typewriter-label {
            color: #b91c1c;
            text-shadow: 0 0 2px rgba(220, 38, 38, 0.3);
        }

        .typewriter-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
            color: #2a2a2a;
            font-size: 11px;
            line-height: 1.6;
        }

        .typewriter-list li {
            margin-bottom: 6px;
            padding-left: 16px;
            position: relative;
        }

        .typewriter-list li::before {
            content: '> ';
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .typewriter-excelled .typewriter-list li::before {
            color: #16a34a;
        }

        .typewriter-struggled .typewriter-list li::before {
            color: #b91c1c;
        }

        .stat-with-icon {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .stat-value {
            flex: 1;
        }

        .stat-value p {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 12px;
            color: #e5e7eb;
        }

        /* Field Manual Specifications Style */
        .field-manual-specs {
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #8b6914;
            border-left: 4px solid #8b6914;
            padding: 24px;
            margin: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }


        .spec-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #8b6914;
        }

        .spec-title {
            font-family: 'SpecialElite', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #8b6914;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 4px;
        }

        .spec-subtitle {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .spec-table {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
        }

        .spec-row {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px dotted #d0c8b8;
            min-height: 32px;
            align-items: center;
        }

        .spec-row:first-child {
            grid-template-columns: 180px 1fr;
            overflow-x: visible;
        }

        .spec-row:first-child .spec-value {
            white-space: nowrap;
            word-break: normal;
            overflow-x: visible;
            display: flex;
            align-items: center;
            gap: 0;
            min-width: 0;
            max-width: 100%;
        }

        .spec-row:last-of-type {
            border-bottom: 2px solid #8b6914;
            margin-bottom: 16px;
        }

        .field-manual-specs .spec-label {
            font-weight: normal;
            color: #000000;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 16px;
        }

        .spec-value {
            color: #e5e7eb;
            font-size: 13px;
            word-break: break-word;
            min-width: 0;
            overflow-wrap: break-word;
        }

        .field-manual-footer {
            margin-top: 20px;
            padding-top: 12px;
            border-top: 1px solid #d0c8b8;
            font-family: 'Courier New', monospace;
            font-size: 9px;
            color: #6b7280;
            text-align: center;
        }

        .footer-line {
            color: #d0c8b8;
            margin-bottom: 8px;
            letter-spacing: 0.1em;
        }

        .footer-note {
            font-style: italic;
            margin-bottom: 6px;
            color: #5a5a5a;
            font-size: 12px;
        }

        .footer-stamp {
            color: #000000;
            font-weight: bold;
            font-size: 8px;
            letter-spacing: 0.1em;
            margin-top: 8px;
        }

        .highlight-number {
            color: #8b6914;
            font-size: 15px;
            font-weight: 700;
        }

        .ammo-icon {
            display: inline-block;
            width: 40px;
            height: 40px;
            margin-right: 8px;
            margin-left: 4px;
            vertical-align: middle;
            position: relative;
            top: -2px;
            flex-shrink: 0;
            object-fit: contain;
        }

        .ammo-icon-fallback {
            display: inline-block;
            width: 40px;
            height: 40px;
            margin-right: 8px;
            margin-left: 4px;
            vertical-align: middle;
            position: relative;
            top: -2px;
            flex-shrink: 0;
        }

        .ammo-icon-fallback.he {
            background: #dc2626;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            box-shadow: 
                0 0 4px rgba(220, 38, 38, 0.6),
                0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px solid #b91c1c;
        }

        .ammo-icon-fallback.smoke {
            background: #6b7280;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.2),
                inset -2px -1px 0 0 #4b5563,
                inset 1px -1px 0 0 #9ca3af,
                inset -1px 1px 0 0 #78716c;
            border: 1px solid #4b5563;
        }

        .ammo-icon-fallback.ap {
            background: #4b5563;
            clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
            transform: rotate(90deg);
            box-shadow: 
                0 0 2px rgba(75, 85, 99, 0.6),
                0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px solid #374151;
        }

        .faction-image {
            position: relative;
            /* Fixed dimensions to prevent movement when changing tank types */
            width: 256px;
            height: 256px;
            min-width: 256px;
            min-height: 256px;
            max-width: 256px;
            max-height: 256px;
            /* Classified military document/note style - aged paper texture */
            background: 
                /* Subtle noise texture for paper feel */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E"),
                /* Aged paper stains/spots effect - weathered document */
                radial-gradient(ellipse at 15% 75%, rgba(30, 25, 20, 0.5) 0%, transparent 45%),
                radial-gradient(ellipse at 85% 25%, rgba(25, 20, 15, 0.4) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(20, 15, 10, 0.3) 0%, transparent 60%),
                /* Subtle document texture lines */
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 20px,
                    rgba(0, 0, 0, 0.15) 20px,
                    rgba(0, 0, 0, 0.15) 21px
                ),
                /* Base aged paper texture - darker document colors */
                linear-gradient(145deg, #1a1815 0%, #151310 30%, #0f0e0c 70%, #1a1815 100%);
            padding: 8px;
            /* Slight rotation for casual document placement */
            transform: rotate(-1.5deg);
            /* Shadow for document on surface */
            box-shadow: 
                0 0 0 1px rgba(60, 50, 40, 0.5),
                3px 5px 12px rgba(0, 0, 0, 0.8),
                inset 0 0 20px rgba(0, 0, 0, 0.3);
            /* Document-style border - uniform thickness */
            border: 2px solid #2a2520;
            border-radius: 0;
            isolation: isolate;
            z-index: 30;
            position: relative;
        }
        
        /* Red CLASSIFIED stamp - top right corner */
        .faction-image .postcard-stamp {
            position: absolute;
            top: 12px;
            right: 12px;
            font-family: 'SpecialElite', 'Courier New', monospace;
            font-size: 5px;
            font-weight: bold;
            color: #ffffff;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: 1px solid #cc0000;
            border-radius: 0;
            padding: 2px 6px;
            transform: rotate(-2deg);
            z-index: 5;
            pointer-events: none;
            background: #cc0000;
            box-shadow: 
                1px 1px 3px rgba(0, 0, 0, 0.6),
                inset 0 0 2px rgba(0, 0, 0, 0.2);
            /* Distressed/worn stamp effect */
            filter: contrast(1.15) brightness(0.95);
        }
        
        /* Document text overlay - bottom of note */
        .faction-image .postcard-coords {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 1.4;
            color: rgba(220, 220, 220, 0.85);
            letter-spacing: 0.8px;
            z-index: 5;
            pointer-events: none;
            background: transparent;
            padding: 0;
            border-radius: 0;
            text-align: left;
        }
        
        /* Document text overlay - bottom right */
        .faction-image::after {
            content: "";
            white-space: pre;
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-family: 'Courier New', monospace;
            font-size: 6px;
            line-height: 1.4;
            color: rgba(220, 220, 220, 0.75);
            letter-spacing: 0.8px;
            z-index: 2;
            text-align: right;
            pointer-events: none;
        }
        
        .faction-image img#factionImage {
            position: relative;
            z-index: 1;
            /* Vintage document photo effect - blend with aged paper */
            filter: sepia(0.15) contrast(1.1) brightness(0.95);
            /* Transparent background so document texture shows through */
            background: transparent;
            /* Make it look like a photo embedded in the document */
            mix-blend-mode: normal;
            /* Ensure consistent sizing - fixed dimensions to prevent movement */
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
        }
        
        /* Info icon next to faction selector */

        .stat-badge {
            position: absolute;
            background: #27272a;
            border: 1px solid #52525b;
            border-radius: 2px;
            padding: 4px 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-family: 'SpecialElite', monospace;
            font-weight: 400;
            color: #d4d4d8;
            z-index: 10;
        }

        .stat-badge img {
            width: 14px;
            height: 14px;
            object-fit: contain;
        }

        .stat-badge.top-left {
            top: 4px;
            left: 4px;
        }

        .stat-badge.top-right {
            top: 4px;
            right: 4px;
        }

        .stat-badge.bottom-left {
            bottom: 4px;
            left: 4px;
        }

        .stat-badge.bottom-right {
            bottom: 4px;
            right: 4px;
        }

        .ammo-box {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #8b6914;
            border-left: 4px solid #8b6914;
            border-radius: 0;
            padding: 6px 8px;
            margin-right: 8px;
            margin-bottom: 4px;
            white-space: nowrap;
            font-size: 11px;
            font-weight: 600;
            color: #2a2a2a;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Courier New', monospace;
        }

        .ammo-box img {
            width: 14px;
            height: 14px;
            object-fit: contain;
            flex-shrink: 0;
        }

        /* Invert vehicle icons in field manual info panel */
        /* Note: _invert_28 images are already inverted, so don't apply filter to them */
        .field-manual-specs .ammo-box img:not([src*="_invert_28"]) {
            filter: invert(1);
        }

        /* Fat marker pen strikethrough for "NO" text */
        .no-weapon-marked {
            position: relative;
            color: #9ca3af;
            display: inline-block;
        }

        /* Long marker stroke across value area only */
        .spec-row.no-weapon-row {
            position: relative;
        }

        .spec-row.no-weapon-row .spec-value {
            position: relative;
            z-index: 2;
            color: #9ca3af;
            display: inline-block;
            width: fit-content;
            max-width: 100%;
            padding: 0;
            margin: 0;
        }

        .spec-row.no-weapon-row .spec-value::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(to bottom, 
                rgba(239, 68, 68, 0.9) 0%,
                rgba(239, 68, 68, 0.85) 30%,
                rgba(239, 68, 68, 0.8) 50%,
                rgba(239, 68, 68, 0.85) 70%,
                rgba(239, 68, 68, 0.9) 100%);
            opacity: 0.85;
            border-radius: 5px 3px 4px 5px;
            transform: translateY(-50%) rotate(-1.2deg);
            z-index: 1;
            box-shadow: 
                0 2px 4px rgba(239, 68, 68, 0.3),
                0 1px 2px rgba(0, 0, 0, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
            clip-path: polygon(
                0% 20%,
                2% 15%,
                5% 18%,
                8% 12%,
                12% 16%,
                18% 14%,
                25% 17%,
                32% 13%,
                40% 15%,
                48% 18%,
                55% 14%,
                62% 16%,
                70% 13%,
                78% 15%,
                85% 17%,
                92% 14%,
                96% 16%,
                100% 18%,
                100% 80%,
                98% 85%,
                95% 82%,
                92% 88%,
                88% 84%,
                82% 86%,
                75% 83%,
                68% 87%,
                60% 85%,
                52% 82%,
                45% 86%,
                38% 84%,
                30% 87%,
                22% 85%,
                15% 83%,
                8% 86%,
                4% 84%,
                0% 82%
            );
        }

        .spec-row.no-weapon-row .spec-label {
            position: relative;
            z-index: 2;
            display: inline-block;
            width: fit-content;
            max-width: 100%;
            padding: 0;
            margin: 0;
        }

        .spec-row.no-weapon-row .spec-label::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(to bottom, 
                rgba(239, 68, 68, 0.9) 0%,
                rgba(239, 68, 68, 0.85) 30%,
                rgba(239, 68, 68, 0.8) 50%,
                rgba(239, 68, 68, 0.85) 70%,
                rgba(239, 68, 68, 0.9) 100%);
            opacity: 0.85;
            border-radius: 5px 3px 4px 5px;
            transform: translateY(-50%) rotate(-1.2deg);
            z-index: 1;
            box-shadow: 
                0 2px 4px rgba(239, 68, 68, 0.3),
                0 1px 2px rgba(0, 0, 0, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
            clip-path: polygon(
                0% 20%,
                2% 15%,
                5% 18%,
                8% 12%,
                12% 16%,
                18% 14%,
                25% 17%,
                32% 13%,
                40% 15%,
                48% 18%,
                55% 14%,
                62% 16%,
                70% 13%,
                78% 15%,
                85% 17%,
                92% 14%,
                96% 16%,
                100% 18%,
                100% 80%,
                98% 85%,
                95% 82%,
                92% 88%,
                88% 84%,
                82% 86%,
                75% 83%,
                68% 87%,
                60% 85%,
                52% 82%,
                45% 86%,
                38% 84%,
                30% 87%,
                22% 85%,
                15% 83%,
                8% 86%,
                4% 84%,
                0% 82%
            );
        }

        .spec-row.weapon-row .spec-value {
            white-space: nowrap;
            word-break: normal;
            overflow-x: visible;
        }

        .ammo-box .highlight-number {
            color: #8b6914;
            font-weight: 700;
        }

        .info-tab-content {
            display: none;
        }

        .info-tab-content.active {
            display: block;
        }

        .screenshot-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .screenshot-item {
            position: relative;
            cursor: pointer;
            border: 1px solid #8b6914;
            border-top: 2px solid #8b6914;
            border-bottom: 2px solid #8b6914;
            border-radius: 0;
            overflow: hidden;
            background: linear-gradient(145deg, rgba(255, 250, 240, 0.95) 0%, rgba(245, 240, 230, 0.98) 100%);
            transition: all 0.3s ease;
            box-shadow: 
                inset 0 0 20px rgba(139, 105, 20, 0.05),
                0 2px 6px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(139, 105, 20, 0.1);
            padding: 3px;
        }

        /* Vintage paper texture with WWII film grain */
        .screenshot-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                /* WWII film grain overlay */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)' opacity='0.4'/%3E%3C/svg%3E"),
                /* Paper texture lines */
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(139, 105, 20, 0.02) 2px,
                    rgba(139, 105, 20, 0.02) 3px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(139, 105, 20, 0.015) 2px,
                    rgba(139, 105, 20, 0.015) 3px
                );
            pointer-events: none;
            z-index: 2;
            opacity: 0.7;
            mix-blend-mode: overlay;
        }

        /* Aged corner effect */
        .screenshot-item::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, rgba(139, 105, 20, 0.2) 0%, transparent 60%);
            pointer-events: none;
            z-index: 2;
        }

        .screenshot-item:hover {
            transform: translateY(-2px) rotate(0.5deg);
            box-shadow: 
                inset 0 0 25px rgba(139, 105, 20, 0.08),
                0 4px 12px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(139, 105, 20, 0.2);
            border-color: #6b5010;
            z-index: 10;
        }

        .screenshot-item img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
            position: relative;
            z-index: 1;
            filter: grayscale(100%) contrast(1.1);
            transition: filter 0.3s ease;
        }

        /* Vintage WWII film grain overlay for thumbnails */
        .screenshot-item img::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)' opacity='0.4'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 2;
            mix-blend-mode: overlay;
            opacity: 0.5;
        }

        .screenshot-item:hover img {
            filter: grayscale(100%) contrast(1.2);
        }

        .screenshot-item:hover img::after {
            opacity: 0.6;
        }

        .screenshot-lightbox {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(8px);
        }

        .screenshot-lightbox.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screenshot-lightbox picture {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 90%;
            max-height: 90%;
            margin: auto;
        }

        .screenshot-lightbox img {
            max-width: 100%;
            max-height: 90vh;
            width: auto;
            height: auto;
            object-fit: contain;
            border: 3px solid #8b6914;
            border-top: 4px solid #8b6914;
            border-bottom: 4px solid #8b6914;
            border-radius: 0;
            box-shadow: 
                0 20px 50px rgba(0, 0, 0, 0.9),
                inset 0 0 30px rgba(139, 105, 20, 0.1);
            filter: grayscale(100%) contrast(1.15) brightness(0.95) sepia(0.1);
            position: relative;
            margin: auto;
        }

        .screenshot-lightbox img.hiding {
            opacity: 0 !important;
            visibility: hidden !important;
            display: none !important;
        }

        /* Hide image by default - only show when explicitly ready */
        .screenshot-lightbox picture img {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .screenshot-lightbox picture img.ready {
            opacity: 1;
        }

        /* Ensure picture element is hidden when switching */
        .screenshot-lightbox picture.switching {
            display: none !important;
        }

        /* Vintage photo frame effect */
        .screenshot-lightbox img::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 1px solid rgba(139, 105, 20, 0.3);
            pointer-events: none;
            z-index: 1;
        }

        /* Vintage WWII film grain overlay for lightbox images */
        .screenshot-lightbox img::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)' opacity='0.4'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 2;
            mix-blend-mode: overlay;
            opacity: 0.6;
        }

        .screenshot-lightbox-close {
            position: absolute;
            top: 24px;
            right: 30px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: rgba(17, 24, 39, 0.5);
            border: 1px solid rgba(107, 114, 128, 0.5);
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 2005;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .screenshot-lightbox-close svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .screenshot-lightbox-close:hover {
            background-color: rgba(185, 28, 28, 0.8); /* Muted red warning */
            border-color: rgba(220, 38, 38, 0.5);
            color: white;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
            transform: scale(1.1); /* Subtle grow instead of rotate */
        }

        .nav-zone-left,
        .nav-zone-right {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 30%;
            z-index: 2001;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            /* Prevent image selection when clicking zones */
            user-select: none;
        }

        .nav-zone-left {
            left: 0;
        }

        .nav-zone-right {
            right: 0;
        }

        .nav-zone-left:hover,
        .nav-zone-right:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .nav-arrow {
            color: rgba(255, 255, 255, 0.75); /* Much brighter */
            font-size: 48px; /* Larger */
            opacity: 1; 
            transition: all 0.2s;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.6); /* Stronger shadow */
        }

        .nav-zone-left:hover .nav-arrow,
        .nav-zone-right:hover .nav-arrow {
            color: rgba(255, 255, 255, 0.9);
            transform: scale(1.2);
        }

        
    </style>
    <script src="mobile-detector.js"></script>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
                <div class="max-w-3xl mx-auto relative">
                    <!-- Title -->
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold dog-tags">HLL SPA Artillery Calculator</h1>
                        <p class="text-sm mt-1" style="color: #9ca3af;">Self-Propelled Artillery Targeting Calculator for Hell Let Loose</p>
                    </div>

                    <!-- Main Card -->
                    <div class="armored-panel-container text-center relative z-20" id="calculator-card">
                        <div class="armored-rivet armored-rivet-top-left"></div>
                        <div class="armored-rivet armored-rivet-top-right"></div>
                        <div class="armored-rivet armored-rivet-bottom-left"></div>
                        <div class="armored-rivet armored-rivet-bottom-right"></div>

                        <!-- Warning Message at Top -->
                        <div class="warning-wrapper" style="position: relative; width: 100%; min-height: 0; overflow: visible; margin-bottom: 0; padding-top: 0;">
                            <div id="warning" class="warning-container hidden">
                                <p class="warning-text"></p>
                            </div>
                        </div>

                        <!-- Faction Selection -->
                        <div class="panel-section">
                            <div class="armored-rivet-small armored-rivet-small-top-left"></div>
                            <div class="armored-rivet-small armored-rivet-small-top-right"></div>
                            <div class="armored-rivet-small armored-rivet-small-bottom-left"></div>
                            <div class="armored-rivet-small armored-rivet-small-bottom-right"></div>
                            <div class="flex items-start justify-between gap-4" style="position: relative;">
                                <div class="flex-1" style="position: relative; z-index: 100; display: flex; flex-direction: column; overflow-x: visible; padding-right: 8px; min-width: 0; max-width: calc(100% - 300px);">
                                    <div class="panel-label" style="text-align: center; margin-bottom: 10px;">Tank Selection</div>
                                    <input type="hidden" id="faction" value="British (Bishop SP)">
                                    <div class="custom-select-wrapper" style="display: flex; align-items: center; gap: 8px;">
                                        <div class="custom-select" style="flex-shrink: 1; position: relative; flex: 1; min-width: 0; max-width: 100%;">
                                            <div class="select-selected" id="selectSelected">
                                                <img src="images/UI/Icons/flags/BRITISH_30.webp" alt="BRITISH" class="flag-icon" loading="eager" decoding="async"> <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;">British (Bishop SP)</span>
                                            </div>
                                            <div class="select-items select-hide" id="selectItems">
                                                <div data-value="British (Bishop SP)">
                                                    <img src="images/UI/Icons/flags/BRITISH_30.webp" alt="BRITISH" class="flag-icon" loading="lazy" decoding="async"> British (Bishop SP)
                                                </div>
                                                <div data-value="British (Churchill AVRE)">
                                                    <img src="images/UI/Icons/flags/BRITISH_30.webp" alt="BRITISH" class="flag-icon" loading="lazy" decoding="async"> British (Churchill AVRE)
                                                </div>
                                                <div data-value="US (Sherman M4A3 105)">
                                                    <img src="images/UI/Icons/flags/US_30.webp" alt="US" class="flag-icon" loading="lazy" decoding="async"> US (Sherman M4A3)
                                                </div>
                                                <div data-value="Soviet Union (KV-2)">
                                                    <img src="images/UI/Icons/flags/SOVIET_30.webp" alt="USSR" class="flag-icon" loading="lazy" decoding="async"> Soviet Union (KV-2)
                                                </div>
                                                <div data-value="DAK (Panzer III Ausf.N)">
                                                    <img src="images/UI/Icons/flags/GERMANY_30.webp" alt="Germany" class="flag-icon" loading="lazy" decoding="async"> DAK (Panzer III Ausf.N)
                                                </div>
                                                <div data-value="Germany (Sturmpanzer IV Brummbär)">
                                                    <img src="images/UI/Icons/flags/GERMANY_30.webp" alt="Germany" class="flag-icon" loading="lazy" decoding="async"> Germany (Sturmpanzer IV Brummbär)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="milRangeText" class="tank-specs-panel" style="flex-shrink: 0; overflow: visible; max-width: 100%;">
                                        <div class="spec-item">
                                            <span class="spec-bullet">▸</span>
                                            <span class="spec-label">Elevation:</span>
                                            <span class="spec-value">-89 MIL to 267 MIL</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="w-64 h-64 overflow-hidden faction-image flex items-center justify-center flex-shrink-0" style="margin-top: 5px; margin-right: 25px; margin-left: 25px;">
                                    <div class="postcard-coords" id="classifiedRefText">REF: ORD-1942/SPA-007<br>CLASSIFIED: VALENTINE-BISHOP<br>OPERATION TORCH | 25-PDR SPA</div>
                                    <picture>
                                        <source srcset="images/tanks/BISHOP_248.webp" type="image/webp">
                                        <img id="factionImage" src="images/tanks/BISHOP_248.png" alt="Faction" class="max-w-full max-h-full object-contain" fetchpriority="high" decoding="async">
                                    </picture>
                                </div>
                            </div>
                        </div>
        
                        <!-- Input Fields -->
                        <div class="panel-section">
                            <div class="armored-rivet-small armored-rivet-small-top-left"></div>
                            <div class="armored-rivet-small armored-rivet-small-top-right"></div>
                            <div class="armored-rivet-small armored-rivet-small-bottom-left"></div>
                            <div class="armored-rivet-small armored-rivet-small-bottom-right"></div>
                            <div class="panel-label">Target Distance (meters)</div>
                            <div class="armored-ruler" id="armoredRuler">
                                <div class="armored-ruler-indicator" id="armoredRulerIndicator" style="left: 50%;"></div>
                            </div>
                            <div style="display: flex; justify-content: center; align-items: flex-start; margin: 10px 0; gap: 15px; position: relative;">
                                <div class="armored-toggle" style="position: absolute; left: 0; top: 20px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <div class="armored-toggle-label">Ruler Snap</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span id="snapOffLabel" class="toggle-label-off">OFF</span>
                                        <input type="checkbox" id="snapToggle" class="sr-only" style="display: none;">
                                        <div class="armored-toggle-switch" id="armoredSnapToggle" onclick="toggleArmoredSwitch('snapToggle', this)"></div>
                                        <span id="snapOnLabel" class="toggle-label-on">ON</span>
                                    </div>
                                </div>
                                <div class="distance-controls" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 25px;">
                                    <button onclick="adjustValue('distance', -1)" class="armored-button">-</button>
                                    <input type="text" id="distance" value="400" tabindex="1" class="armored-input">
                                    <button onclick="adjustValue('distance', 1)" class="armored-button">+</button>
                                </div>
                                <div class="armored-toggle" style="position: absolute; right: 0; top: 20px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <div class="armored-toggle-label">Auto Calculation</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span id="calcOffLabel" class="toggle-label-off">OFF</span>
                                        <input type="checkbox" id="autoCalcToggle" class="sr-only" checked style="display: none;">
                                        <div class="armored-toggle-switch active" id="armoredAutoToggle" onclick="toggleArmoredSwitch('autoCalcToggle', this)"></div>
                                        <span id="calcOnLabel" class="toggle-label-on">ON</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel-section" style="margin-bottom: 0;">
                            <div class="armored-rivet-small armored-rivet-small-top-left"></div>
                            <div class="armored-rivet-small armored-rivet-small-top-right"></div>
                            <div class="armored-rivet-small armored-rivet-small-bottom-left"></div>
                            <div class="armored-rivet-small armored-rivet-small-bottom-right"></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: stretch;">
                                <div style="display: flex; flex-direction: column;">
                                    <div style="flex-shrink: 0; margin-bottom: 5px;">
                                        <div class="panel-label">Height Difference (m)</div>
                                        <p class="text-xs mb-1 text-center" style="color: #9ca3af; font-size: 0.7rem; margin-bottom: 4px;">(- target lower, + target higher)</p>
                                    </div>
                                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: auto;">
                                        <button onclick="adjustValue('heightDiff', -1)" class="armored-button">-</button>
                                        <input type="text" id="heightDiff" value="0" tabindex="2" class="armored-input" max="5000">
                                        <button onclick="adjustValue('heightDiff', 1)" class="armored-button">+</button>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column;">
                                    <div style="flex-shrink: 0; margin-bottom: 5px;">
                                        <div class="panel-label">Terrain Elevation (MIL)</div>
                                        <p class="text-xs mb-1 text-center" style="color: #9ca3af; font-size: 0.7rem; margin-bottom: 4px;">Red MIL HUD (- downhill/nose-down, + uphill/nose-up)</p>
                                    </div>
                                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: auto;">
                                        <button onclick="adjustValue('redNumber', -1)" class="armored-button">-</button>
                                        <input type="text" id="redNumber" value="0" tabindex="3" class="armored-input">
                                        <button onclick="adjustValue('redNumber', 1)" class="armored-button">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
        
                        <!-- Calculate Button / Metal Panel -->
                        <div style="position: relative; margin-top: 0; margin-bottom: 5px;">
                            <button onclick="calculate()" id="calculateButton" tabindex="4" class="armored-calculate">
                                Calculate Elevation
                            </button>
                            <div id="metalPanel" class="armored-metal-panel" style="display: none;">
                                <div class="screw-pan-head screw-left"></div>
                                <div class="screw-pan-head screw-right"></div>
                            </div>
                        </div>
        
                        <!-- Result -->
                        <div id="result" class="armored-result">
                            <button class="copy-result-button" onclick="copyResult(this)" title="Copy result to clipboard">⧉</button>
                            <button class="reset-result-button" onclick="resetCalculator(this)" title="Reset all values">⟳</button>
                            <div class="panel-label" style="margin-bottom: 10px;">Set Elevation (Yellow) To:</div>
                            <div class="armored-result-value">
                                <div class="mechanical-counter" id="elevationCounter">
                                    <!-- Digit wheels will be generated here -->
                                </div>
                                <div class="mil-static-counter" id="elevationMilCounter">
                                    <!-- MIL wheels will be generated here -->
                                </div>
                            </div>
                            <div class="text-sm text-gray-400 mt-4" style="font-family: 'Courier New', monospace;">
                                <p>Base: <span id="baseValue" class="text-white">0</span> <span id="baseMilLabel" class="text-white mil-label">MIL</span> | Target Height <span id="heightSymbol">Δ</span>: <span id="heightValue" class="text-gray-300">0m</span> | Terrain Elevation: <span id="redValue" class="text-gray-300">+0</span> <span id="redValueUnit" class="text-gray-400 mil-label">MIL</span></p>
                            </div>
                        </div>

                    </div>

                    <!-- Tank Info Button - Outside main container -->
                    <button id="tankInfoIcon" class="select-info-button" onclick="showTankInfo()">
                        <span>TANK INFORMATION</span>
                    </button>

                    <!-- Tank Info Modal -->
                    <div id="tankInfoModal" class="info-modal">
                        <div class="info-modal-content">
                            <div class="info-modal-header">
                                <div style="flex: 1;">
                                    <div class="field-manual-text field-manual-title">FIELD MANUAL</div>
                                    <div class="field-manual-text field-manual-subtitle">Artillery & Armored Vehicle Specifications</div>
                                    <div class="field-manual-text field-manual-reference">REF: FM-ART-1944 | SECTION: VEHICLE DATA</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="field-manual-text field-manual-date">DATE: ██/██/1944</div>
                                    <div class="field-manual-text field-manual-unit">UNIT: CLASSIFIED</div>
                                </div>
                                <h3 id="tankInfoTitle" style="position: absolute; left: 50%; bottom: 0; transform: translateX(-50%); margin: 0; font-size: 19px; text-align: center; white-space: nowrap;">Tank Information</h3>
                                <button class="info-modal-close" id="closeTankInfo">&times;</button>
                            </div>
                            <div class="info-modal-tabs">
                                <button class="info-modal-tab active" data-tab="stats">Vehicle Stats</button>
                                <button class="info-modal-tab" data-tab="screenshots">Screenshots</button>
                                <button class="info-modal-tab" data-tab="history">History</button>
                            </div>
                            <div class="info-modal-body">
                                <div id="tankInfoContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Screenshot Lightbox -->
                    <div id="screenshotLightbox" class="screenshot-lightbox" onclick="closeScreenshotLightbox()">
                        <div class="nav-zone-left" onclick="event.stopPropagation(); navigateScreenshot(-1);">
                            <span class="nav-arrow">◀</span>
                        </div>
                        <div class="nav-zone-right" onclick="event.stopPropagation(); navigateScreenshot(1);">
                            <span class="nav-arrow">▶</span>
                        </div>
                        <div class="screenshot-lightbox-close" onclick="event.stopPropagation(); closeScreenshotLightbox();">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                        <picture>
                            <source id="screenshotLightboxSource" srcset="" type="image/webp">
                            <img id="screenshotLightboxImg" src="" alt="Screenshot" onclick="event.stopPropagation();">
                        </picture>
                    </div>

                    <!-- Version Info -->
                    <div class="text-xs text-gray-500 text-center mt-4" style="margin-top: calc(1rem - 2px);">
                        <p>HLL SPA Artillery Calculator v1.0.7 - 2025</p>
                        <p class="text-orange-400 mt-1">⚠️ This calculator is still being tested and improved. The results may not always be perfect. Please use your best judgment when using these calculations.</p>
                    </div>
                </div>
    </div>

    <script>
        // Artillery data tables
        const tables = {
            'British (Bishop SP)': {
                600: 133, 573: 142, 547: 151, 520: 160, 493: 169, 467: 178,
                440: 187, 413: 196, 387: 204, 360: 213, 333: 222, 307: 231,
                280: 240, 253: 249, 227: 258, 200: 267,
                minMil: -89, maxMil: 267
            },
            'British (Churchill AVRE)': {
                600: 178, 573: 190, 547: 201, 520: 213, 493: 225, 467: 237,
                440: 249, 413: 261, 387: 273, 360: 284, 333: 296, 307: 308,
                280: 320, 253: 332, 227: 344, 200: 356,
                minMil: -89, maxMil: 356
            },
            'DAK (Panzer III Ausf.N)': {
                600: 267, 573: 284, 547: 302, 520: 320, 493: 338, 467: 356,
                440: 373, 413: 391, 387: 409, 360: 427, 333: 444, 307: 462,
                280: 480, 253: 498, 227: 516, 200: 533,
                minMil: -89, maxMil: 533
            },
            'Germany (Sturmpanzer IV Brummbär)': {
                600: 267, 573: 284, 547: 302, 520: 320, 493: 338, 467: 356,
                440: 373, 413: 391, 387: 409, 360: 427, 333: 444, 307: 462,
                280: 480, 253: 498, 227: 516, 200: 533,
                minMil: -89, maxMil: 533
            },
            'Soviet Union (KV-2)': {
                600: 267, 573: 284, 547: 302, 520: 320, 493: 338, 467: 356,
                440: 373, 413: 391, 387: 409, 360: 427, 333: 444, 307: 462,
                280: 480, 253: 498, 227: 516, 200: 533,
                minMil: -89, maxMil: 533
            },
            'US (Sherman M4A3 105)': {
                600: 267, 573: 284, 547: 302, 520: 320, 493: 338, 467: 356,
                440: 373, 413: 391, 387: 409, 360: 427, 333: 444, 307: 462,
                280: 480, 253: 498, 227: 516, 200: 533,
                minMil: -89, maxMil: 533
            }
        };

        // Tank information data (in-game statistics, history, and real life)
        const tankInfo = {
            'US (Sherman M4A3 105)': {
                title: 'M4A3 Sherman with 105mm Howitzer',
                stats: {
                    elevation: '-89 MIL to 533 MIL',
                    hullGun: 'M1919 .30 cal - 200 rounds × 6 magazines',
                    mainGun: '105mm HOWIZER',
                    turretRotation: '360°',
                    coaxial: 'M1919 .30 cal - 200 rounds × 6 magazines',
                    topSpeed: '24 km/h'
                },
                history: 'The M4A3 Sherman variant equipped with a 105mm howitzer was developed to provide close infantry support. It saw extensive use in the European Theater, particularly during the breakout from Normandy and the push across France. The 105mm howitzer was effective against fortifications and infantry positions, making it valuable for breakthrough operations.',
                realLife: {
                    range: '~11,000m (indirect fire), ~2,000m (direct fire)',
                    production: 'Produced from 1943-1945 at Detroit Arsenal Tank Plant (Warren, Michigan), Fisher Body Tank Plant/Grand Blanc Metal Center (Grand Blanc, Michigan), and other US facilities',
                    service: 'Used by US Army in European and Pacific theaters (1943-1945)',
                    strengths: [
                        'Versatile for both direct and indirect fire support',
                        'Good mobility and reliability',
                        'Standard HE and AP capabilities',
                        'Effective against infantry and fortifications'
                    ],
                    weaknesses: []
                }
            },
            'Soviet Union (KV-2)': {
                title: 'KV-2 Heavy Tank',
                stats: {
                    elevation: '-89 MIL to 533 MIL',
                    hullGun: 'DT .30 cal - 200 rounds × 6 magazines',
                    mainGun: '152MM M-10T - 50 HE rounds, 35 SMOKE rounds, 20 AP rounds',
                    turretRotation: '360°',
                    coaxial: 'NO COAXIAL',
                    topSpeed: '23 km/h'
                },
                history: 'The KV-2 was a Soviet heavy tank armed with a massive 152mm howitzer, designed as an assault tank to destroy fortifications and bunkers. It saw action during the Winter War against Finland and early stages of Operation Barbarossa. Despite its powerful armament, its slow speed, long reload time, and mechanical issues made it vulnerable to German anti-tank weapons.',
                realLife: {
                    range: '~12,000m (indirect fire), ~1,200m (direct fire)',
                    production: 'Produced from 1939-1941, ~334 units built at Kirov Plant (Factory No. 100) in Leningrad (now St. Petersburg, Russia)',
                    service: 'Used by Red Army in Winter War and early Eastern Front (1939-1941)',
                    strengths: [
                        'Extremely powerful armament',
                        'Highly effective against fortifications'
                    ],
                    weaknesses: [
                        'Very slow turret rotation and movement',
                        'Long reload time (20-40 seconds)',
                        'Vulnerable to mechanical breakdowns'
                    ]
                }
            },
            'British (Churchill AVRE)': {
                title: 'Churchill Mk III AVRE',
                stats: {
                    elevation: '-89 MIL to 356 MIL',
                    hullGun: '7.92 BESA - 200 rounds × 6 magazines',
                    mainGun: '230MM PETARD',
                    turretRotation: '360°',
                    coaxial: '7.92 BESA - 200 rounds × 6 magazines',
                    topSpeed: '20 km/h'
                },
                history: 'The Churchill AVRE (Armoured Vehicle Royal Engineers) was a specialized engineering vehicle designed to destroy fortifications. It was armed with a 290mm Petard mortar, capable of firing a 40-pound "Flying Dustbin" projectile. These vehicles were crucial during D-Day and subsequent operations, used to breach enemy defenses and clear obstacles.',
                realLife: {
                    range: '~100m (very short range in real life)',
                    production: 'Base Churchill tanks manufactured at Vauxhall Motors in Luton, Bedfordshire, UK. AVRE conversions performed by Royal Engineers',
                    service: 'Used by British and Canadian forces in Normandy and beyond (1944-1945)',
                    strengths: [
                        'Designed specifically for assaulting fortifications',
                        'Devastating firepower against structures',
                        'Large high-explosive blast radius',
                        'Heavily armored'
                    ],
                    weaknesses: [
                        'Extremely short effective range (~100m)',
                        'Slow'
                    ]
                }
            },
            'British (Bishop SP)': {
                title: 'Bishop SP 25pdr',
                stats: {
                    elevation: '-89 MIL to 267 MIL',
                    hullGun: 'NO MG ON DRIVER',
                    mainGun: 'QF 25 POUNDER - 50 HE rounds, 35 SMOKE rounds, 20 AP rounds',
                    turretRotation: '8° total (4° left and 4° right)',
                    coaxial: 'NO COAXIAL GUN',
                    topSpeed: '20 km/h'
                },
                history: 'The Bishop was a British self-propelled artillery vehicle based on the Valentine tank chassis, armed with a 25-pounder field gun. It was used during World War II, primarily in North Africa. The vehicle was named after its boxy superstructure resembling a bishop\'s mitre. It had limited elevation and traverse, which affected its effectiveness as an artillery piece.',
                realLife: {
                    range: '~6,000-12,000m (indirect fire)',
                    production: 'Produced from 1942-1943, ~149 units built by Birmingham Railway Carriage and Wagon Company in Birmingham, UK',
                    service: 'Used by British forces in North Africa and Italy (1942-1943)',
                    strengths: [
                        'Good for medium-range engagements',
                        'Balanced between mobility and firepower'
                    ],
                    weaknesses: [
                        'Limited turret elevation and traverse',
                        'Replaced by more effective SPGs like the Sexton'
                    ]
                }
            },
            'Germany (Sturmpanzer IV Brummbär)': {
                title: 'Sturmpanzer IV Brummbär',
                stats: {
                    elevation: '-89 MIL to 533 MIL',
                    hullGun: 'NO MG DRIVER',
                    mainGun: 'StuH 45 L/12',
                    turretRotation: '30° total (15° left and 15° right)',
                    coaxial: 'NO COAXIAL GUN',
                    topSpeed: '27 km/h'
                },
                history: 'The Brummbär (Grizzly Bear) was a German assault gun based on the Panzer IV chassis, armed with a 150mm StuH 43 L/12 howitzer. It was designed for urban combat and destroying fortifications. First deployed in 1943, it saw extensive use on the Eastern Front and in urban battles like Stalingrad. Its nickname "Brummbär" reflected its powerful but slow nature.',
                realLife: {
                    range: '~4,600m (indirect fire), ~1,000m (direct fire)',
                    production: 'Produced from 1943-1945, ~306 units built by Alkett (Altmärkische Kettenfabrik) in Berlin-Spandau, Germany',
                    service: 'Used by Wehrmacht on Eastern and Western Fronts (1943-1945)',
                    strengths: [
                        'Extremely powerful armament',
                        'Large high-explosive blast radius',
                        'Heavily armored',
                        'Effective in urban warfare'
                    ],
                    weaknesses: [
                        'Limited traverse (30° total)',
                        'Slow'
                    ]
                }
            },
            'DAK (Panzer III Ausf.N)': {
                title: 'Panzer III Ausf.N',
                stats: {
                    elevation: '-89 MIL to 533 MIL',
                    hullGun: 'MG34 7.92mm - 200 rounds × 6 magazines',
                    mainGun: '7.5CM KwK 37 - 50 HE rounds, 35 SMOKE rounds, 20 AP rounds',
                    turretRotation: '360°',
                    coaxial: 'MG34 7.92mm - 200 rounds × 6 magazines',
                    topSpeed: '26 km/h'
                },
                history: 'The Panzer III Ausf.N was a German medium tank variant armed with a 75mm L/24 short-barreled gun, designed for infantry support rather than anti-tank warfare. It saw service primarily in North Africa with the Afrika Korps and later on the Eastern Front. The Ausf.N was specifically designed for close support with high-explosive rounds.',
                realLife: {
                    range: '~6,000m (indirect fire), ~1,500m (direct fire)',
                    production: 'Produced from 1942-1943 at Daimler-Benz (Berlin-Marienfelde), MAN (Nuremberg), and Henschel (Kassel), Germany',
                    service: 'Used by Afrika Korps and on Eastern Front (1942-1943)',
                    strengths: [
                        'Good balance of mobility and firepower',
                        'Effective against infantry and light vehicles',
                        'Faster than heavy tanks',
                        'Designed for infantry support role'
                    ],
                    weaknesses: [
                        'Limited anti-tank capability'
                    ]
                }
            }
        };

        // Helper function to interpolate values
        function interpolate(table, meters) {
            // Filter out minMil and maxMil properties, only use distance keys
            const distances = Object.keys(table)
                .filter(k => k !== 'minMil' && k !== 'maxMil')
                .map(Number)
                .sort((a, b) => b - a);
            
            const maxDist = distances[0];
            const minDist = distances[distances.length - 1];
            
            // Extrapolate for distances > maxDist (600m)
            if (meters > maxDist) {
                const d1 = distances[0];  // 600m
                const d2 = distances[1];    // 573m
                const m1 = table[d1];
                const m2 = table[d2];
                const slope = (m1 - m2) / (d1 - d2);
                return m1 + (meters - d1) * slope;
            }
            
            // Extrapolate for distances < minDist (200m)
            if (meters < minDist) {
                const d1 = distances[distances.length - 1];  // 200m
                const d2 = distances[distances.length - 2];  // 227m
                const m1 = table[d1];
                const m2 = table[d2];
                const slope = (m1 - m2) / (d1 - d2);
                return m1 + (meters - d1) * slope;
            }
            
            // Interpolate for distances within range
            for (let i = 0; i < distances.length - 1; i++) {
                const d1 = distances[i];
                const d2 = distances[i + 1];
                if (meters <= d1 && meters >= d2) {
                    const m1 = table[d1];
                    const m2 = table[d2];
                    const ratio = (meters - d1) / (d2 - d1);
                    return m1 + ratio * (m2 - m1);
                }
            }
            
            return table[distances[distances.length - 1]];
        }

        // Update MIL range text and stats
        function updateMilRangeText() {
            const faction = document.getElementById('faction').value;
            const table = tables[faction];
            const info = tankInfo[faction];
            const milRangeText = document.getElementById('milRangeText');
            
            if (table && info && info.stats) {
                const stats = info.stats;
                const elevation = `${table.minMil} MIL to ${table.maxMil} MIL`;
                
                // Format main gun - extract only ammo (remove gun name)
                let mainGunText = stats.mainGun;
                const mainGunParts = mainGunText.split(' - ');
                let mainGunDisplay = '';
                if (mainGunParts[1]) {
                    // Extract ammo counts: "50 HE rounds, 35 SMOKE rounds, 20 AP rounds"
                    const ammoMatches = mainGunParts[1].match(/(\d+)\s*(HE|SMOKE|AP)\s*rounds/g);
                    if (ammoMatches) {
                        const ammoList = ammoMatches.map((m, index) => {
                            const match = m.match(/(\d+)\s*(HE|SMOKE|AP)/);
                            if (match) {
                                const count = match[1];
                                const type = match[2];
                                return `${type} ${count}`;
                            }
                            return m;
                        }).join(' • ');
                        mainGunDisplay = ammoList;
                    }
                } else {
                    mainGunDisplay = mainGunText;
                }
                
                // Format hull gun - show if has MG, ammo count, and magazines
                let hullGunText = stats.hullGun;
                if (hullGunText.includes('NO')) {
                    hullGunText = 'NO MG';
                } else {
                    // Extract ammo count and magazines: "200 rounds × 6 magazines"
                    const ammoMatch = hullGunText.match(/(\d+)\s*rounds(?:\s*×\s*(\d+)\s*magazines)?/);
                    if (ammoMatch) {
                        hullGunText = `${ammoMatch[1]} rounds`;
                        if (ammoMatch[2]) {
                            hullGunText += ` × ${ammoMatch[2]} magazines`;
                        }
                    } else {
                        hullGunText = 'YES';
                    }
                }
                
                // Format coaxial gun - show if has MG, ammo count, and magazines
                let coaxialGunText = stats.coaxial;
                if (coaxialGunText.includes('NO')) {
                    coaxialGunText = 'NO MG';
                } else {
                    // Extract ammo count and magazines: "200 rounds × 6 magazines"
                    const ammoMatch = coaxialGunText.match(/(\d+)\s*rounds(?:\s*×\s*(\d+)\s*magazines)?/);
                    if (ammoMatch) {
                        coaxialGunText = `${ammoMatch[1]} rounds`;
                        if (ammoMatch[2]) {
                            coaxialGunText += ` × ${ammoMatch[2]} magazines`;
                        }
                    } else {
                        coaxialGunText = 'YES';
                    }
                }
                
                // Extract total rotation
                let rotationText = stats.turretRotation;
                if (rotationText.includes('total')) {
                    const match = rotationText.match(/(\d+)°/);
                    if (match) {
                        rotationText = match[1] + '°';
                    }
                } else if (rotationText.includes('°')) {
                    const match = rotationText.match(/(\d+°)/);
                    if (match) {
                        rotationText = match[1];
                    }
                }
                
                // Check if values should be crossed out
                const coaxCrossed = coaxialGunText === 'NO MG' ? 'text-decoration: line-through; opacity: 0.6;' : '';
                const hullCrossed = hullGunText === 'NO MG' ? 'text-decoration: line-through; opacity: 0.6;' : '';
                
                milRangeText.innerHTML = `
                    <div class="spec-item">
                        <span class="spec-bullet">▸</span>
                        <span class="spec-label">Main Gun:</span>
                        <span class="spec-value">${mainGunDisplay}</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-bullet">▸</span>
                        <span class="spec-label">Elevation:</span>
                        <span class="spec-value">${elevation}</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-bullet">▸</span>
                        <span class="spec-label">Turret Rotation:</span>
                        <span class="spec-value">${rotationText}</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-bullet">▸</span>
                        <span class="spec-label">Coax MG:</span>
                        <span class="spec-value" style="${coaxCrossed}">${coaxialGunText}</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-bullet">▸</span>
                        <span class="spec-label">Hull MG:</span>
                        <span class="spec-value" style="${hullCrossed}">${hullGunText}</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-bullet">▸</span>
                        <span class="spec-label">Top Speed:</span>
                        <span class="spec-value">${stats.topSpeed}</span>
                    </div>
                `;
            } else if (table) {
                milRangeText.innerHTML = `
                    <div class="spec-item">
                        <span class="spec-bullet">▸</span>
                        <span class="spec-label">Elevation:</span>
                        <span class="spec-value">${table.minMil} MIL to ${table.maxMil} MIL</span>
                    </div>
                `;
            }
        }

        // Update faction image
        function updateFactionImage() {
            const faction = document.getElementById('faction').value;
            const factionMap = {
                'British (Bishop SP)': 'BISHOP_248',
                'British (Churchill AVRE)': 'AVRE_248',
                'US (Sherman M4A3 105)': 'M4A3_248',
                'Soviet Union (KV-2)': 'KV2_248',
                'DAK (Panzer III Ausf.N)': 'PANZERIII_248',
                'Germany (Sturmpanzer IV Brummbär)': 'BRUMMBAR_248'
            };
            
            // Classified reference text for each tank
            const classifiedTextMap = {
                'British (Bishop SP)': {
                    ref: 'REF: ORD-1942/SPA-007',
                    designation: 'CLASSIFIED: VALENTINE-BISHOP',
                    classification: 'OPERATION TORCH | 25-PDR SPA'
                },
                'British (Churchill AVRE)': {
                    ref: 'REF: WO-1943/AVRE-001',
                    designation: 'CLASSIFIED: CHURCHILL-290MM',
                    classification: 'OVERLORD PREP | BREACHING VEHICLE'
                },
                'US (Sherman M4A3 105)': {
                    ref: 'REF: OCM-1944/M4A3-105',
                    designation: 'CLASSIFIED: SHERMAN-105MM',
                    classification: 'OPERATION COBRA | CLOSE SUPPORT'
                },
                'Soviet Union (KV-2)': {
                    ref: 'REF: STAVKA-1941/KV-2-152',
                    designation: 'CLASSIFIED: KV-2 "DRUNKEN MONSTER"',
                    classification: 'BARBAROSSA DEFENSE | 152MM HOWITZER'
                },
                'DAK (Panzer III Ausf.N)': {
                    ref: 'REF: AK-1942/PzIII-Ausf.N',
                    designation: 'CLASSIFIED: PANZER-III-AFRIKA',
                    classification: 'SONNENBLUME | 75MM L/24 INFANTRY SUPPORT'
                },
                'Germany (Sturmpanzer IV Brummbär)': {
                    ref: 'REF: WH-1943/StuPz-IV-150',
                    designation: 'CLASSIFIED: BRUMMBÄR "BEAR"',
                    classification: 'ZITADELLE | URBAN ASSAULT GUN'
                }
            };
            
            const baseName = factionMap[faction] || 'BISHOP_248';
            const img = document.getElementById('factionImage');
            const picture = img ? img.closest('picture') : null;
            
            if (img && picture) {
                const webpSrc = `images/tanks/${baseName}.webp`;
                const pngSrc = `images/tanks/${baseName}.png`;
                
                // Check if we're already showing this image to avoid unnecessary transitions
                const currentSrc = img.src;
                if (currentSrc && (currentSrc.includes(baseName) || currentSrc.endsWith(`${baseName}.png`))) {
                    // Already showing this image, ensure it's visible
                    img.style.opacity = '1';
                    return;
                }
                
                // Update picture element - browser will automatically choose WebP if supported
                const source = picture.querySelector('source');
                
                // Preload the image for smoother transitions with fade effect
                const newImage = new Image();
                
                // Fade out current image (only if there's a current image)
                if (currentSrc && !currentSrc.includes('data:') && currentSrc !== '') {
                    img.style.transition = 'opacity 0.2s ease';
                    img.style.opacity = '0';
                } else {
                    // Initial load - start hidden, will fade in when loaded
                    img.style.opacity = '0';
                    img.style.transition = 'opacity 0.2s ease';
                }
                
                const switchImage = function(useWebP = true) {
                    // Update source elements
                    if (source) {
                        source.srcset = useWebP ? webpSrc : pngSrc;
                    }
                    img.src = pngSrc; // Set PNG as fallback
                    
                    // Remove high priority after initial load to allow other resources
                    if (img.hasAttribute('fetchpriority')) {
                        img.removeAttribute('fetchpriority');
                    }
                    
                    // Fade in the new image
                    requestAnimationFrame(function() {
                        img.style.opacity = '1';
                    });
                };
                
                // Set up load handlers
                let imageLoaded = false;
                newImage.onload = function() {
                    if (!imageLoaded) {
                        imageLoaded = true;
                        switchImage(true); // Use WebP
                    }
                };
                newImage.onerror = function() {
                    if (!imageLoaded) {
                        // Fallback to PNG if WebP fails
                        const pngImage = new Image();
                        pngImage.onload = function() {
                            if (!imageLoaded) {
                                imageLoaded = true;
                                switchImage(false); // Use PNG
                            }
                        };
                        pngImage.onerror = function() {
                            if (!imageLoaded) {
                                imageLoaded = true;
                                // Final fallback to default tank image
                                if (source) {
                                    source.srcset = 'images/tanks/BISHOP_248.webp';
                                }
                                img.src = 'images/tanks/BISHOP_248.png';
                                img.style.opacity = '1';
                            }
                        };
                        pngImage.src = pngSrc;
                    }
                };
                
                // Start loading WebP first
                newImage.src = webpSrc;
                
                // If image is already cached, switch immediately
                if (newImage.complete && newImage.naturalWidth > 0) {
                    imageLoaded = true;
                    switchImage(true); // Use WebP (it's already loaded)
                }
                
                // Also set up error handler on the main image
                img.onerror = function() {
                    if (source) {
                        source.srcset = 'images/tanks/BISHOP_248.webp';
                    }
                    this.src = 'images/tanks/BISHOP_248.png';
                    this.style.opacity = '1';
                };
            } else if (img) {
                // Fallback if picture element not found
                img.style.transition = 'opacity 0.2s ease';
                img.style.opacity = '0';
                
                const newImage = new Image();
                newImage.onload = function() {
                    img.src = `images/tanks/${baseName}.png`;
                    requestAnimationFrame(function() {
                        img.style.opacity = '1';
                    });
                };
                newImage.onerror = function() {
                    img.src = 'images/tanks/BISHOP_248.png';
                    img.style.opacity = '1';
                };
                newImage.src = `images/tanks/${baseName}.png`;
            }
            
            // Update classified reference text
            const classifiedText = classifiedTextMap[faction] || classifiedTextMap['British (Bishop SP)'];
            const refTextElement = document.getElementById('classifiedRefText');
            if (refTextElement) {
                refTextElement.innerHTML = `${classifiedText.ref}<br>${classifiedText.designation}<br>${classifiedText.classification}`;
            }
            
            updateMilRangeText();
        }

        // Adjust value function for increment/decrement buttons
        function adjustValue(fieldId, delta) {
            const input = document.getElementById(fieldId);
            const inputValue = input.value || '0';
            const currentValue = parseFloat(inputValue.replace('+', '')) || 0;
            let newValue = Math.round(currentValue + delta);

            // Apply limits
            if (fieldId === 'distance') {
                newValue = Math.max(0, Math.min(1000, newValue));
            } else if (fieldId === 'redNumber') {
                newValue = Math.max(-1000, Math.min(1000, newValue));
            } else if (fieldId === 'heightDiff') {
                newValue = Math.max(-5000, Math.min(5000, newValue));
            }

            // Write raw numeric value into the field for fast manual editing
            input.value = newValue;
            
            // Update ruler if distance field changed
            if (fieldId === 'distance') {
                const snapToggle = document.getElementById('snapToggle');
                
                // Turn off snap mode when using +/- buttons if value is not a 25m increment
                if (snapToggle && snapToggle.checked) {
                    const isMultipleOf25 = Math.abs(newValue % 25) < 0.001; // Check if value is a multiple of 25
                    if (!isMultipleOf25) {
                        snapToggle.checked = false;
                        updateToggleLEDs();
                        syncArmoredToggles();
                        saveState(); // Save state when snap mode is toggled off
                    }
                }
                
                updateArmoredRuler(newValue);
            }
            
            // Always save state when values change
            saveState();
            
            // Trigger calculation if we have distance and auto mode is enabled
            // calculate() will set all display values correctly
            const distance = parseFloat(document.getElementById('distance').value);
            if (distance && !isNaN(distance) && isAutoCalcEnabled()) {
                calculate();
            } else {
                // When auto calc is off, reset base value to "--" and final value to 0000 when any value changes
                const baseValueEl = document.getElementById('baseValue');
                if (baseValueEl) {
                    baseValueEl.textContent = '--';
                }
                // Reset final value to 0000 when auto calc is off
                if (fieldId === 'distance' || fieldId === 'heightDiff' || fieldId === 'redNumber') {
                    rollElevationToNumber(0);
                    // Show "--" for height and elevation when auto calc is off
                    const heightValueEl = document.getElementById('heightValue');
                    const redValueEl = document.getElementById('redValue');
                    if (heightValueEl) heightValueEl.textContent = '--';
                    if (redValueEl) redValueEl.textContent = '--';
                    // Update MIL labels after values are set to "--"
                    updateMilLabels();
                }
            }
        }

        // Constants
        const SLIDER_THUMB_WIDTH = 18;

        // Check if auto calculation is enabled
        function isAutoCalcEnabled() {
            const toggle = document.getElementById('autoCalcToggle');
            return toggle ? toggle.checked : true; // Default to auto
        }
        
        // Function to update display values from input fields ONLY when not calculated
        // This should NOT overwrite calculated values from calculate() function
        function updateDisplayValues() {
            const heightInput = document.getElementById('heightDiff');
            const redInput = document.getElementById('redNumber');
            const distanceInput = document.getElementById('distance');
            const factionInput = document.getElementById('faction');
            const heightEl = document.getElementById('heightValue');
            const redEl = document.getElementById('redValue');
            const baseEl = document.getElementById('baseValue');
            const heightSymbolEl = document.getElementById('heightSymbol');
            
            // Only update base if it's "--" or empty (error state)
            if (baseEl && distanceInput && factionInput) {
                if (baseEl.textContent === '--' || baseEl.textContent.trim() === '') {
                    const distance = parseFloat(distanceInput.value);
                    const faction = factionInput.value;
                    if (distance && !isNaN(distance) && tables[faction]) {
                        const base = interpolate(tables[faction], distance);
                        if (!isNaN(base)) {
                            baseEl.textContent = base.toFixed(1);
                        }
                    }
                }
            }
            
            // Only update height if it's "--" or empty (error state)
            if (heightEl && heightInput) {
                if (heightEl.textContent === '--' || heightEl.textContent.trim() === '') {
                    const hVal = parseFloat(heightInput.value) || 0;
                    const hText = (hVal >= 0 ? '+' : '') + hVal + 'm';
                    heightEl.textContent = hText;
                    heightEl.className = hVal >= 0 ? 'text-green-400' : 'text-red-400';
                }
            }
            if (heightSymbolEl && heightInput) {
                const hVal = parseFloat(heightInput.value) || 0;
                heightSymbolEl.textContent = hVal >= 0 ? '▲' : '▼';
            }
            
            // Only update elevation if it's "--" or empty (error state)
            if (redEl && redInput) {
                if (redEl.textContent === '--' || redEl.textContent.trim() === '') {
                    const rVal = parseFloat(redInput.value) || 0;
                    const rText = (rVal >= 0 ? '+' : '') + rVal;
                    redEl.textContent = rText;
                    const colorClass = rVal >= 0 ? 'text-green-400' : 'text-red-400';
                    redEl.className = colorClass;
                    const redUnitEl = document.getElementById('redValueUnit');
                    if (redUnitEl) {
                        redUnitEl.className = colorClass;
                    }
                }
            }
        }

        // Update calculate button visibility based on mode
        function updateCalculateButton() {
            const button = document.getElementById('calculateButton');
            const metalPanel = document.getElementById('metalPanel');
            const isAuto = isAutoCalcEnabled();
            if (button && metalPanel) {
                if (isAuto) {
                    // Ensure button is visible to get its height
                    if (button.style.display === 'none') {
                        button.style.display = '';
                    }
                    // Get button height before hiding it
                    const buttonHeight = button.offsetHeight;
                    // Hide button, show metal panel
                    button.style.display = 'none';
                    metalPanel.style.display = 'block';
                    // Match metal panel height to button height exactly
                    metalPanel.style.height = buttonHeight + 'px';
                    button.disabled = true;
                } else {
                    // Show button, hide metal panel
                    button.style.display = '';
                    metalPanel.style.display = 'none';
                    button.disabled = false;
                }
            }
        }

        // Update MIL label visibility based on whether results are calculated
        function updateMilLabels() {
            // MIL is always visible in mechanical counter, so this function is no longer needed
            // But keeping it for compatibility with other code that calls it
            const milCounter = document.getElementById('elevationMilCounter');
            if (milCounter) {
                milCounter.style.display = '';
            }
            
            // Update MIL label visibility based on values
            const baseValueEl = document.getElementById('baseValue');
            const baseMilLabelEl = document.getElementById('baseMilLabel');
            const redValueEl = document.getElementById('redValue');
            const redValueUnitEl = document.getElementById('redValueUnit');
            
            // Hide MIL labels when values are "--"
            if (baseValueEl && baseMilLabelEl) {
                baseMilLabelEl.style.display = (baseValueEl.textContent.trim() === '--') ? 'none' : '';
            }
            if (redValueEl && redValueUnitEl) {
                redValueUnitEl.style.display = (redValueEl.textContent.trim() === '--') ? 'none' : '';
            }
        }

        // Sync ruler with input field
        function syncSliderWithInput() {
            const distanceInput = document.getElementById('distance');
            const armoredRuler = document.getElementById('armoredRuler');
            
            distanceInput.addEventListener('input', function() {
                const snapToggle = document.getElementById('snapToggle');
                const inputValue = parseFloat(this.value) || 400;
                
                // Turn off snap mode if value is not a 25m increment
                if (snapToggle && snapToggle.checked) {
                    const isMultipleOf25 = Math.abs(inputValue % 25) < 0.001; // Check if value is a multiple of 25
                    if (!isMultipleOf25) {
                        snapToggle.checked = false;
                        syncArmoredToggles();
                        updateToggleLEDs();
                        saveState(); // Save state when snap mode is toggled off
                    }
                }
                
                updateArmoredRuler(inputValue);
                if (isAutoCalcEnabled()) {
                    calculate();
                } else {
                    // When auto calc is off, reset base value to "--" and final value to 0000
                    const baseValueEl = document.getElementById('baseValue');
                    if (baseValueEl) {
                        baseValueEl.textContent = '--';
                    }
                    rollElevationToNumber(0);
                    // Show "--" for height and elevation when auto calc is off
                    const heightValueEl = document.getElementById('heightValue');
                    const redValueEl = document.getElementById('redValue');
                    if (heightValueEl) heightValueEl.textContent = '--';
                    if (redValueEl) redValueEl.textContent = '--';
                    // Update MIL labels after values are set to "--"
                    updateMilLabels();
                }
                saveState();
            });
            
            // Make ruler draggable with pixel-perfect snapping
            if (armoredRuler) {
                let isDragging = false;
                
                // Helper function to calculate value from mouse position
                function calculateValueFromMouse(e, rulerElement) {
                    const containerRect = rulerElement.getBoundingClientRect();
                    let relativeX = e.clientX - containerRect.left;
                    // Account for padding so clicks map to the same grid as marks
                    const style = getComputedStyle(rulerElement);
                    const padLeft = parseFloat(style.paddingLeft) || 0;
                    const padRight = parseFloat(style.paddingRight) || 0;
                    const usableWidth = Math.max(1, (rulerElement.clientWidth || containerRect.width) - padLeft - padRight);

                    // Clamp to padded area
                    relativeX = Math.max(padLeft, Math.min(relativeX, padLeft + usableWidth));
                    
                    const min = 200;
                    const max = 600;
                    const range = max - min;
                    
                    // Align click math with rendering math (usable width)
                    const ratio = Math.max(0, Math.min(1, (relativeX - padLeft) / usableWidth));
                    
                    let newValue = min + ratio * range;
                    
                    // Apply snap if enabled - snap to nearest 25m mark
                    const snapToggle = document.getElementById('snapToggle');
                    if (snapToggle && snapToggle.checked) {
                        // Snap to nearest 25m increment
                        newValue = Math.round(newValue / 25) * 25;
                    } else {
                        // Round to nearest integer when not snapping
                        newValue = Math.round(newValue);
                    }
                    
                    return Math.max(min, Math.min(max, newValue));
                }
                
                // Helper function to update indicator position only (lightweight for dragging)
                function updateIndicatorOnly(newValue) {
                    const indicator = document.getElementById('armoredRulerIndicator');
                    if (!indicator || !armoredRuler) return;
                    
                    const min = 200;
                    const max = 600;
                    const range = max - min;
                    const clampedValue = Math.max(min, Math.min(max, newValue));
                    
                    const style = getComputedStyle(armoredRuler);
                    const padLeft = parseFloat(style.paddingLeft) || 0;
                    const padRight = parseFloat(style.paddingRight) || 0;
                    const rulerWidth = armoredRuler.clientWidth || armoredRuler.getBoundingClientRect().width;
                    const usableWidth = Math.max(1, rulerWidth - padLeft - padRight);
                    
                    const ratio = (clampedValue - min) / range;
                    const pixelPosition = Math.round(ratio * usableWidth) + padLeft;
                    indicator.style.left = pixelPosition + 'px';
                }
                
                // Helper function to update value (full update with calculations)
                function updateValue(newValue, skipExpensive = false) {
                    distanceInput.value = newValue;
                    
                    if (skipExpensive) {
                        // During dragging, only update indicator position
                        updateIndicatorOnly(newValue);
                        // Trigger calculation if auto mode is enabled, even during drag
                        if (isAutoCalcEnabled()) {
                            calculate();
                        } else {
                            // When auto calc is off, reset base value to "--" and final value to 0000
                            const baseValueEl = document.getElementById('baseValue');
                            if (baseValueEl) {
                                baseValueEl.textContent = '--';
                            }
                            rollElevationToNumber(0);
                            // Show "--" for height and elevation when auto calc is off
                            const heightValueEl = document.getElementById('heightValue');
                            const redValueEl = document.getElementById('redValue');
                            if (heightValueEl) heightValueEl.textContent = '--';
                            if (redValueEl) redValueEl.textContent = '--';
                            // Update MIL labels after values are set to "--"
                            updateMilLabels();
                        }
                    } else {
                        // Full update when not dragging
                        updateArmoredRuler(newValue);
                        
                        if (isAutoCalcEnabled()) {
                            calculate();
                        } else {
                            // When auto calc is off, reset base value to "--" and final value to 0000
                            const baseValueEl = document.getElementById('baseValue');
                            if (baseValueEl) {
                                baseValueEl.textContent = '--';
                            }
                            rollElevationToNumber(0);
                            // Show "--" for height and elevation when auto calc is off
                            const heightValueEl = document.getElementById('heightValue');
                            const redValueEl = document.getElementById('redValue');
                            if (heightValueEl) heightValueEl.textContent = '--';
                            if (redValueEl) redValueEl.textContent = '--';
                            // Update MIL labels after values are set to "--"
                            updateMilLabels();
                        }
                        saveState();
                    }
                }
                
                // Throttle using requestAnimationFrame
                let rafId = null;
                let pendingValue = null;
                
                function scheduleUpdate(newValue, skipExpensive) {
                    pendingValue = { value: newValue, skipExpensive: skipExpensive };
                    if (rafId === null) {
                        rafId = requestAnimationFrame(() => {
                            if (pendingValue) {
                                updateValue(pendingValue.value, pendingValue.skipExpensive);
                                pendingValue = null;
                            }
                            rafId = null;
                        });
                    }
                }
                
                // Helper to get coordinates from mouse or touch event
                function getEventCoordinates(e) {
                    if (e.touches && e.touches.length > 0) {
                        return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
                    }
                    return { clientX: e.clientX, clientY: e.clientY };
                }
                
                // Mouse down - start dragging
                armoredRuler.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    e.preventDefault(); // Prevent text selection
                    
                    const newValue = calculateValueFromMouse(e, this);
                    updateValue(newValue, false); // Full update on initial click
                });
                
                // Touch start - start dragging
                armoredRuler.addEventListener('touchstart', function(e) {
                    isDragging = true;
                    e.preventDefault(); // Prevent scrolling
                    
                    const coords = getEventCoordinates(e);
                    const touchEvent = { clientX: coords.clientX };
                    const newValue = calculateValueFromMouse(touchEvent, this);
                    updateValue(newValue, false); // Full update on initial touch
                }, { passive: false });
                
                // Mouse move - update while dragging (throttled)
                document.addEventListener('mousemove', function(e) {
                    if (isDragging && armoredRuler) {
                        e.preventDefault();
                        const newValue = calculateValueFromMouse(e, armoredRuler);
                        scheduleUpdate(newValue, true); // Lightweight update during drag
                    }
                });
                
                // Touch move - update while dragging (throttled)
                document.addEventListener('touchmove', function(e) {
                    if (isDragging && armoredRuler) {
                        e.preventDefault();
                        const coords = getEventCoordinates(e);
                        const touchEvent = { clientX: coords.clientX };
                        const newValue = calculateValueFromMouse(touchEvent, armoredRuler);
                        scheduleUpdate(newValue, true); // Lightweight update during drag
                    }
                }, { passive: false });
                
                // Mouse up - stop dragging and do full update
                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        isDragging = false;
                        // Cancel any pending RAF updates
                        if (rafId !== null) {
                            cancelAnimationFrame(rafId);
                            rafId = null;
                        }
                        // Do final full update with calculations
                        if (pendingValue) {
                            updateValue(pendingValue.value, false);
                            pendingValue = null;
                        } else {
                            // Ensure final value is saved
                            const currentValue = parseFloat(distanceInput.value);
                            if (!isNaN(currentValue)) {
                                updateValue(currentValue, false);
                            }
                        }
                    }
                });
                
                // Touch end - stop dragging and do full update
                document.addEventListener('touchend', function() {
                    if (isDragging) {
                        isDragging = false;
                        // Cancel any pending RAF updates
                        if (rafId !== null) {
                            cancelAnimationFrame(rafId);
                            rafId = null;
                        }
                        // Do final full update with calculations
                        if (pendingValue) {
                            updateValue(pendingValue.value, false);
                            pendingValue = null;
                        } else {
                            // Ensure final value is saved
                            const currentValue = parseFloat(distanceInput.value);
                            if (!isNaN(currentValue)) {
                                updateValue(currentValue, false);
                            }
                        }
                    }
                });
                
                // Touch cancel - stop dragging
                document.addEventListener('touchcancel', function() {
                    if (isDragging) {
                        isDragging = false;
                        if (rafId !== null) {
                            cancelAnimationFrame(rafId);
                            rafId = null;
                        }
                        pendingValue = null;
                    }
                });
                
                // Mouse leave - stop dragging if mouse leaves the ruler
                armoredRuler.addEventListener('mouseleave', function() {
                    if (isDragging) {
                        // Keep dragging active even when mouse leaves, but stop on mouseup
                    }
                });
            }
            
            // Initialize ruler position
            updateArmoredRuler(parseFloat(distanceInput.value) || 400);
        }

        // Update armored ruler with marks and indicator - pixel perfect
        function updateArmoredRuler(value) {
            const ruler = document.getElementById('armoredRuler');
            const indicator = document.getElementById('armoredRulerIndicator');
            if (!ruler || !indicator) return;
            
            // Get padding to align marks/indicator inside the box
            const style = getComputedStyle(ruler);
            const padLeft = parseFloat(style.paddingLeft) || 0;
            const padRight = parseFloat(style.paddingRight) || 0;

            // Get actual pixel width of ruler (content box, excluding border)
            let rulerWidth = ruler.clientWidth;
            if (!rulerWidth) {
                const rulerRect = ruler.getBoundingClientRect();
                rulerWidth = rulerRect.width;
            }

            // Usable width for marks/indicator (inside padding)
            const usableWidth = Math.max(1, rulerWidth - padLeft - padRight);
            
            // If ruler not yet rendered (width is 0), use offsetWidth or schedule retry
            if (rulerWidth === 0) {
                rulerWidth = ruler.offsetWidth;
                if (rulerWidth === 0) {
                    // Ruler not ready yet, retry on next frame
                    requestAnimationFrame(() => updateArmoredRuler(value));
                    return;
                }
            }
            
            // Clear existing marks and labels
            const existingMarks = ruler.querySelectorAll('.armored-ruler-mark');
            existingMarks.forEach(mark => mark.remove());
            const existingLabels = ruler.querySelectorAll('.armored-ruler-label');
            existingLabels.forEach(label => label.remove());
            
            // Ruler range
            const min = 200;
            const max = 600;
            const range = max - min;
            
            // Clamp value to valid range
            const clampedValue = Math.max(min, Math.min(max, value));
            
            // Create marks with pixel-perfect positioning
            // Big lines at 50m intervals, small lines at 25m intervals
            const step = 25;
            const steps = (max - min) / step; // 16 intervals
            for (let idx = 0; idx <= steps; idx++) {
                const i = min + idx * step;
                const isMajor = (i % 50 === 0);
                
                // Calculate exact pixel position with distributed rounding
                let pixelPosition;
                if (idx === 0) {
                    // First mark: position at 1px to cover left edge (mark is 2px wide, centered)
                    pixelPosition = 1;
                } else if (idx === steps) {
                    // Last mark: position at rulerWidth - 1px to cover right edge
                    pixelPosition = rulerWidth - 1;
                } else {
                    // Middle marks: distribute evenly within usable width
                    pixelPosition = Math.round((idx * usableWidth) / steps) + padLeft;
                }
                
                // Create mark
                const mark = document.createElement('div');
                mark.className = 'armored-ruler-mark' + (isMajor ? ' major' : '');
                mark.style.left = pixelPosition + 'px';
                mark.style.transform = 'translate3d(-50%, 0, 0)';
                ruler.appendChild(mark);
                
                // Create label for all marks (major and minor)
                const label = document.createElement('div');
                label.className = 'armored-ruler-label' + (isMajor ? '' : ' minor');
                label.textContent = i.toString();
                label.style.left = pixelPosition + 'px';
                ruler.appendChild(label);
            }
            
            // Update indicator position - pixel perfect alignment with marks
            const ratio = (clampedValue - min) / range;
            const pixelPosition = Math.round(ratio * usableWidth) + padLeft;
            indicator.style.left = pixelPosition + 'px';
        }

        // Mechanical Counter System - from demo
        let currentElevationDigits = [];
        let isElevationNegative = false;
        const elevationCounterElement = document.getElementById('elevationCounter');
        const CELL_HEIGHT = 80;
        
        function createElevationDigitWheel(index, isFirstWheel = false) {
            const wheel = document.createElement('div');
            wheel.className = 'digit-wheel';
            
            const strip = document.createElement('div');
            strip.className = 'digit-strip';
            strip.id = `elevation-strip-${index}`;
            
            if (isFirstWheel) {
                // First wheel: only 0 and minus sign (no other digits)
                const firstWheelSequence = [0, '−'];
                const sequenceLength = firstWheelSequence.length;
                
                // Create 40 cells (sequence repeated for smooth rolling)
                for (let i = 0; i < 40; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'digit-cell';
                    cell.textContent = firstWheelSequence[i % sequenceLength];
                    strip.appendChild(cell);
                }
            } else {
                // Regular digit wheels: 0-9 repeated (more cells for smooth animation)
                for (let i = 0; i < 40; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'digit-cell';
                    cell.textContent = i % 10;
                    strip.appendChild(cell);
                }
            }
            
            wheel.appendChild(strip);
            return wheel;
        }
        
        function createElevationMILWheel(letter) {
            const wheel = document.createElement('div');
            wheel.className = 'mil-wheel';
            
            const strip = document.createElement('div');
            strip.className = 'mil-strip';
            
            // Create cells with the letter in the middle position (position 10)
            for (let i = 0; i < 20; i++) {
                const cell = document.createElement('div');
                cell.className = 'mil-cell';
                if (i === 10) {
                    cell.textContent = letter;
                } else {
                    cell.textContent = ' ';
                }
                strip.appendChild(cell);
            }
            
            // Position to show the letter (middle position)
            strip.style.transform = `translateY(-${10 * CELL_HEIGHT}px)`;
            
            wheel.appendChild(strip);
            return wheel;
        }
        
        function initializeElevationMIL() {
            const milCounter = document.getElementById('elevationMilCounter');
            if (!milCounter) return;
            
            milCounter.innerHTML = '';
            const letters = ['M', 'I', 'L'];
            letters.forEach(letter => {
                const wheel = createElevationMILWheel(letter);
                milCounter.appendChild(wheel);
            });
        }
        
        function setupElevationCounter(targetNumber) {
            const absValue = Math.abs(targetNumber);
            const numStr = String(Math.max(0, Math.floor(absValue))).padStart(3, '0');
            const targetDigits = numStr.split('').map(Number);
            const isNeg = targetNumber < 0;
            
            // Always create 4 wheels (first wheel can show - or digit)
            if (currentElevationDigits.length !== 4) {
                elevationCounterElement.innerHTML = '';
                for (let i = 0; i < 4; i++) {
                    const wheel = createElevationDigitWheel(i, i === 0);
                    elevationCounterElement.appendChild(wheel);
                }
            }
            
            // Initialize all strips to show 0 (or - for first wheel if negative)
            for (let i = 0; i < 4; i++) {
                const strip = document.getElementById(`elevation-strip-${i}`);
                if (strip) {
                    if (i === 0 && isNeg) {
                        strip.style.transition = 'none';
                        strip.style.transform = `translateY(-${1 * CELL_HEIGHT}px)`; // Position 1 is minus sign
                    } else {
                        strip.style.transition = 'none';
                        strip.style.transform = 'translateY(0)';
                    }
                }
            }
            
            currentElevationDigits = [0, 0, 0, 0];
            isElevationNegative = isNeg;
        }
        
        function rollElevationToNumber(targetNumber) {
            const absValue = Math.abs(targetNumber);
            const numStr = String(Math.max(0, Math.floor(absValue))).padStart(3, '0');
            const targetDigits = numStr.split('').map(Number);
            const isNeg = targetNumber < 0;
            
            // Ensure we have 4 wheels
            if (currentElevationDigits.length !== 4) {
                setupElevationCounter(targetNumber);
            }
            
            // Handle first wheel separately (can show 0 or -)
            const firstStrip = document.getElementById('elevation-strip-0');
            if (firstStrip) {
                const currentFirstValue = isElevationNegative ? '-' : 0;
                const targetFirstValue = isNeg ? '-' : 0;
                const isResetting = targetNumber === 0;
                const signChanged = targetFirstValue !== currentFirstValue;
                const needsAnimation = signChanged || isResetting;
                
                if (needsAnimation) {
                    // Simple direct switch between 0 and - (no rolling animation)
                    void firstStrip.offsetWidth;
                    
                    setTimeout(() => {
                        if (isNeg) {
                            // Switch directly to minus sign (position 1)
                            firstStrip.style.transition = 'transform 0.2s ease-in-out';
                            firstStrip.style.transform = `translateY(-${1 * CELL_HEIGHT}px)`;
                        } else {
                            // Switch directly to 0 (position 0)
                            firstStrip.style.transition = 'transform 0.2s ease-in-out';
                            firstStrip.style.transform = `translateY(0)`;
                        }
                    }, 0);
                }
            }
            
            // Roll remaining 3 digits (index 1, 2, 3) with staggered delay
            // Only animate digits that actually change
            for (let index = 1; index < 4; index++) {
                const strip = document.getElementById(`elevation-strip-${index}`);
                if (!strip) continue;
                
                // Get current digit from state, but also verify from DOM transform
                let currentDigit = currentElevationDigits[index] || 0;
                let actualCurrentPosition = currentDigit * CELL_HEIGHT;
                const transform = strip.style.transform || '';
                const transformMatch = transform.match(/translateY\((-?\d+)px\)/);
                if (transformMatch) {
                    // Get the actual pixel position from DOM (will be negative)
                    actualCurrentPosition = Math.abs(parseInt(transformMatch[1]));
                    // Calculate current digit from actual position (normalize to 0-9)
                    currentDigit = Math.round(actualCurrentPosition / CELL_HEIGHT) % 10;
                }
                
                const targetDigit = targetDigits[index - 1];
                
                // Check if digit actually changed
                if (currentDigit === targetDigit) {
                    // Digit hasn't changed - set position immediately without animation
                    const finalSnapPosition = -(targetDigit * CELL_HEIGHT);
                    strip.style.transition = 'none';
                    strip.style.transform = `translateY(${finalSnapPosition}px)`;
                    strip.classList.remove('rolling', 'snapping');
                    continue;
                }
                
                // Normalize current position to base range (0-9) to ensure we start from a safe position
                const normalizedCurrentPosition = currentDigit * CELL_HEIGHT;
                
                // Calculate how many positions to move (direct movement, no rolling)
                // For both upward and downward, move directly without wrapping
                let moveDistance = targetDigit - currentDigit;
                // No wrapping - move directly to target (can be negative for downward)
                
                // Calculate final animation position (direct movement)
                const finalPosition = -(normalizedCurrentPosition + moveDistance * CELL_HEIGHT);
                
                // Snap to normalized position first (without animation)
                strip.style.transition = 'none';
                strip.style.transform = `translateY(-${normalizedCurrentPosition}px)`;
                
                // Force reflow and wait a frame for snap to apply
                void strip.offsetWidth;
                requestAnimationFrame(() => {
                    // Animate with staggered delay (only for changing digits)
                    setTimeout(() => {
                        strip.style.transition = 'transform 0.2s ease-in-out';
                        strip.style.transform = `translateY(${finalPosition}px)`;
                    }, (index - 1) * 35); // Stagger each digit by 35ms
                });
            }
            
            // Update current state
            currentElevationDigits = [isNeg ? '-' : 0, targetDigits[0], targetDigits[1], targetDigits[2]];
            isElevationNegative = isNeg;
        }
        
        // Track previous warning message type to avoid repeating animation
        let previousWarningType = '';
        let previousWarningMessage = '';
        let isWarningAnimating = false;
        let warningAnimationTimeout = null;

        // Normalize warning message to extract just the warning type (ignore changing values)
        function normalizeWarningMessage(message) {
            if (!message) return '';
            // Remove dynamic values and keep only the warning type
            // Replace numeric values with placeholders to compare warning types
            let normalized = message
                .replace(/\(-?\d+\s*MIL\)/g, '(X MIL)')            // Replace "(267 MIL)" with "(X MIL)"
                .replace(/\d+\s*MIL/g, 'X MIL')                    // Replace "267 MIL" with "X MIL"
                .replace(/\(\d+m\)/g, '(Xm)')                      // Replace "(189m)" with "(Xm)"
                .replace(/\d+m/g, 'Xm')                            // Replace "189m" with "Xm"
                .replace(/\(-?\d+\)/g, '(X)')                      // Replace "(267)" with "(X)"
                .replace(/:\s*\d+/g, ': X')                        // Replace ": 189" with ": X"
                .replace(/\d+-\d+/g, 'X-X')                        // Replace ranges like "200-600" with "X-X"
                .trim();
            return normalized;
        }

        // Show warning with animation only if warning type changed
        function showWarning(warningDiv, message) {
            if (!warningDiv) return;
            
            const warningP = warningDiv.querySelector('p');
            if (warningP) {
                const currentMessage = message || warningP.textContent;
                const currentWarningType = normalizeWarningMessage(currentMessage);
                
                // Check if warning type changed (not just the message values)
                const warningTypeChanged = currentWarningType !== previousWarningType;
                const wasHidden = warningDiv.classList.contains('hidden');
                
                // Remove hiding class if present
                warningDiv.classList.remove('hiding');
                
                // Update the message
                warningP.textContent = currentMessage;
                
                // Only animate if warning type changed or warning was hidden
                // AND animation is not currently in progress
                if ((warningTypeChanged || wasHidden) && !isWarningAnimating) {
                    warningDiv.classList.remove('hidden');
                    // Mark animation as in progress
                    isWarningAnimating = true;
                    
                    // Clear any pending animation timeout
                    if (warningAnimationTimeout) {
                        clearTimeout(warningAnimationTimeout);
                    }
                    
                    // Reset animation to ensure it plays
                    warningDiv.style.animation = 'none';
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            warningDiv.style.animation = '';
                            // Reset animation flag after animation completes (400ms)
                            warningAnimationTimeout = setTimeout(() => {
                                isWarningAnimating = false;
                                warningAnimationTimeout = null;
                            }, 400);
                        });
                    });
                    previousWarningType = currentWarningType;
                    previousWarningMessage = currentMessage;
                } else {
                    // Warning type didn't change, just update the text without animation
                    warningDiv.classList.remove('hidden');
                    // Update stored message but keep the same type
                    previousWarningMessage = currentMessage;
                }
            } else {
                // Fallback if no p element
                warningDiv.classList.remove('hiding');
                warningDiv.classList.remove('hidden');
                previousWarningType = normalizeWarningMessage(message || '');
                previousWarningMessage = message || '';
            }
        }

        // Hide warning with reverse animation
        function hideWarning(warningDiv) {
            if (!warningDiv) return;
            
            // Only animate if warning is currently visible and not already animating
            if (!warningDiv.classList.contains('hidden') && !isWarningAnimating) {
                // Mark animation as in progress
                isWarningAnimating = true;
                
                // Clear any pending animation timeout
                if (warningAnimationTimeout) {
                    clearTimeout(warningAnimationTimeout);
                }
                
                // Add hiding class first to trigger reverse animation
                warningDiv.classList.add('hiding');
                // Reset animation to ensure it plays
                warningDiv.style.animation = 'none';
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        warningDiv.style.animation = '';
                        // After animation completes, add hidden class and remove hiding
                        setTimeout(() => {
                            warningDiv.classList.remove('hiding');
                            warningDiv.classList.add('hidden');
                            previousWarningType = '';
                            previousWarningMessage = '';
                            isWarningAnimating = false;
                            warningAnimationTimeout = null;
                        }, 400); // Match animation duration
                    });
                });
            } else {
                // Already hidden or animating, just ensure it stays hidden
                warningDiv.classList.remove('hiding');
                warningDiv.classList.add('hidden');
                previousWarningType = '';
                previousWarningMessage = '';
            }
        }

        // Reset warning animation to replay it (kept for backwards compatibility)
        function resetWarningAnimation(warningDiv) {
            if (!warningDiv) return;
            warningDiv.style.animation = 'none';
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    warningDiv.style.animation = '';
                });
            });
        }

        // Calculate function
        function calculate() {
            try {
                const faction = document.getElementById('faction').value;
                const distance = parseFloat(document.getElementById('distance').value);
            
            // Parse heightDiff - handle +, -, and empty values
            const heightDiffInput = document.getElementById('heightDiff');
            let heightDiff = 0;
            if (heightDiffInput) {
                const heightDiffValue = heightDiffInput.value.trim();
                if (heightDiffValue === '' || heightDiffValue === '-' || heightDiffValue === '+') {
                    heightDiff = 0;
                } else {
                    const parsed = parseFloat(heightDiffValue.replace(/\+/g, ''));
                    heightDiff = isNaN(parsed) ? 0 : parsed;
                }
            }
            
            // Parse redNumber - handle +, -, and empty values
            const redNumberInput = document.getElementById('redNumber');
            let redNumber = 0;
            if (redNumberInput) {
                const redNumberValue = redNumberInput.value.trim();
                if (redNumberValue === '' || redNumberValue === '-' || redNumberValue === '+') {
                    redNumber = 0;
                } else {
                    const parsed = parseFloat(redNumberValue.replace(/\+/g, ''));
                    redNumber = isNaN(parsed) ? 0 : parsed;
                }
            }
            
            const warningDiv = document.getElementById('warning');
            const resultDiv = document.getElementById('result');
            
            if (!distance || isNaN(distance)) {
                if (warningDiv) {
                    showWarning(warningDiv, 'Please enter a valid distance');
                }
                // Show default "0000 MIL" when validation fails
                rollElevationToNumber(0);
                document.getElementById('baseValue').textContent = '--';
                document.getElementById('heightValue').textContent = '--';
                document.getElementById('redValue').textContent = '--';
                updateMilLabels();
                return;
            }
            
            const table = tables[faction];
            if (!table) {
                if (warningDiv) {
                    showWarning(warningDiv, `Error: Unknown faction "${faction}"`);
                }
                // Show default "0000 MIL" when faction error
                rollElevationToNumber(0);
                document.getElementById('baseValue').textContent = '--';
                document.getElementById('heightValue').textContent = '--';
                document.getElementById('redValue').textContent = '--';
                updateMilLabels();
                return;
            }
            const minDist = Math.min(...Object.keys(table).filter(k => k !== 'minMil' && k !== 'maxMil').map(Number));
            const maxDist = Math.max(...Object.keys(table).filter(k => k !== 'minMil' && k !== 'maxMil').map(Number));

            const base = interpolate(table, distance);
            // Calculate final elevation: base plus height difference minus tank body angle
            // If target is higher (positive heightDiff), aim higher (add)
            // If tank is elevated (positive redNumber), compensate by aiming lower (subtract)
            const final = Math.round(base + heightDiff - redNumber);
            

            // Check turret elevation limits
            const minMil = table.minMil;
            const maxMil = table.maxMil;
            
            // Check if final elevation is outside turret's MIL limits
            if (final < minMil || final > maxMil) {
                let limitWarning = '';
                if (final < minMil) {
                    limitWarning = `WARNING: Calculated elevation (${final} MIL) is below this turret's minimum elevation (${minMil} MIL).`;
                } else if (final > maxMil) {
                    limitWarning = `WARNING: Calculated elevation (${final} MIL) exceeds this turret's maximum elevation (${maxMil} MIL).`;
                }
                if (warningDiv) {
                    showWarning(warningDiv, limitWarning);
                }
            } else if (distance < minDist || distance > maxDist) {
                // Keep distance warning if no MIL limit issue
                if (warningDiv) {
                    showWarning(warningDiv, `Warning: Distance (${distance}m) is outside the typical range (${minDist}-${maxDist}m).`);
                }
            } else {
                if (warningDiv) {
                    hideWarning(warningDiv);
                }
            }

            // Update elevation using mechanical counter
            rollElevationToNumber(Math.round(final));
            
            // Remove any existing animation classes to prevent animations (legacy cleanup)
            const elevationCounterEl = document.getElementById('elevationCounter');
            const elevationValueContainer = elevationCounterEl ? elevationCounterEl.closest('.armored-result-value') : null;
            if (elevationValueContainer) {
                elevationValueContainer.classList.remove(
                    'elevation-count-up', 'elevation-pulse', 'elevation-slide-fade', 'elevation-scale-bounce',
                    'elevation-mechanical-odometer', 'elevation-mechanical-tick', 
                    'elevation-mechanical-snap', 'elevation-mechanical-gauge'
                );
            }

            // ===== CRITICAL: Set ALL display values - MUST BE DONE HERE =====
            // These values MUST be set and MUST NEVER be "--" after a successful calculation
            
            // Normalize values to ensure they're numbers
            const displayHeightDiff = (typeof heightDiff === 'number' && !isNaN(heightDiff)) ? heightDiff : 0;
            const displayRedNumber = (typeof redNumber === 'number' && !isNaN(redNumber)) ? redNumber : 0;
            
            // Set base value - ALWAYS set, NEVER "--"
            const baseValueEl = document.getElementById('baseValue');
            if (baseValueEl) {
                if (typeof base === 'number' && !isNaN(base)) {
                    const baseText = base.toFixed(1);
                    baseValueEl.textContent = baseText;
                    baseValueEl.innerHTML = baseText;
                } else {
                    console.error('Base value is invalid:', base);
                }
            } else {
                console.error('baseValue element not found!');
            }
            
            // Set target height - ALWAYS set, NEVER "--"
            const heightElement = document.getElementById('heightValue');
            const heightSymbolElement = document.getElementById('heightSymbol');
            if (heightElement) {
                const heightText = (displayHeightDiff >= 0 ? '+' : '') + displayHeightDiff + 'm';
                heightElement.textContent = heightText;
                heightElement.className = displayHeightDiff >= 0 ? 'text-green-400' : 'text-red-400';
            } else {
                console.error('heightValue element not found!');
            }
            if (heightSymbolElement) {
                heightSymbolElement.textContent = displayHeightDiff >= 0 ? '▲' : '▼';
            }
            
            // Set elevation - ALWAYS set, NEVER "--"
            const redElement = document.getElementById('redValue');
            const redUnitElement = document.getElementById('redValueUnit');
            if (redElement) {
                const redText = (displayRedNumber >= 0 ? '+' : '') + displayRedNumber;
                redElement.textContent = redText;
                const colorClass = displayRedNumber >= 0 ? 'text-green-400' : 'text-red-400';
                redElement.className = colorClass;
                if (redUnitElement) {
                    redUnitElement.className = colorClass;
                }
            } else {
                console.error('redValue element not found!');
            }
            
            // Final verification - ensure values are set and not overwritten
            setTimeout(() => {
                const baseEl = document.getElementById('baseValue');
                const heightEl = document.getElementById('heightValue');
                const redEl = document.getElementById('redValue');
                
                // Re-verify and set base if needed
                if (baseEl && typeof base === 'number' && !isNaN(base)) {
                    if (baseEl.textContent === '--' || baseEl.textContent === '0' || baseEl.textContent.trim() === '') {
                        baseEl.textContent = base.toFixed(1);
                    }
                }
                
                // Re-verify and set height if needed
                if (heightEl) {
                    const currentText = heightEl.textContent;
                    const expectedText = (displayHeightDiff >= 0 ? '+' : '') + displayHeightDiff + 'm';
                    if (currentText === '--' || currentText === '0m' || currentText.trim() === '') {
                        heightEl.textContent = expectedText;
                    }
                }
                
                // Re-verify and set elevation if needed
                if (redEl) {
                    const currentText = redEl.textContent;
                    const expectedText = (displayRedNumber >= 0 ? '+' : '') + displayRedNumber;
                    if (currentText === '--' || currentText === '+0' || currentText === '0' || currentText.trim() === '') {
                        redEl.textContent = expectedText;
                    }
                }
            }, 50);
            
            // Update MIL labels after values are set
            updateMilLabels();

            // In manual mode, focus distance input after calculation (for Enter key workflow)
            // In auto mode, remove focus from calculate button to clear yellow highlight
            if (!isAutoCalcEnabled()) {
                const distanceInputEl = document.getElementById('distance');
                if (distanceInputEl) {
                    distanceInputEl.focus();
                    distanceInputEl.select();
                }
            } else if (document.activeElement && document.activeElement.id === 'calculateButton') {
                document.activeElement.blur();
            }

            // Persist current state
            saveState();
            } catch (error) {
                console.error('Error in calculate function:', error);
                // Show error to user
                const warningDiv = document.getElementById('warning');
                if (warningDiv) {
                    showWarning(warningDiv, 'Error calculating elevation. Please check your inputs.');
                }
            }
        }
        
        // Explicitly expose to global scope for inline onclick handlers
        window.calculate = calculate;

        // Copy result to clipboard
        function copyResult(buttonElement) {
            // Get value from mechanical counter
            const counterElement = document.getElementById('elevationCounter');
            let elevationValue = '0000';
            if (counterElement) {
                const strips = counterElement.querySelectorAll('.digit-strip');
                let valueStr = '';
                
                strips.forEach((strip, index) => {
                    const transform = strip.style.transform || '';
                    const match = transform.match(/translateY\(-?(\d+)px\)/);
                    if (match) {
                        const position = Math.round(parseInt(match[1]) / CELL_HEIGHT);
                        const cells = strip.querySelectorAll('.digit-cell');
                        
                        if (cells.length > 0) {
                            // Get the cell at the current position (modulo to handle wrapping)
                            const cellIndex = position % cells.length;
                            const cellContent = cells[cellIndex]?.textContent || '0';
                            valueStr += cellContent;
                        } else {
                            // Fallback: calculate digit from position
                            if (index === 0) {
                                // First wheel: even position = 0, odd position = '−'
                                valueStr += (position % 2 === 1) ? '−' : '0';
                            } else {
                                // Regular digit wheels: 0-9
                                valueStr += (position % 10);
                            }
                        }
                    } else {
                        valueStr += '0';
                    }
                });
                
                // Process the value string
                if (valueStr.includes('−')) {
                    // Has minus sign - extract it and pad the numeric part
                    const numericPart = valueStr.replace(/[^0-9]/g, '');
                    const paddedNumeric = numericPart.padStart(4, '0');
                    // Remove leading zeros, but keep at least one digit
                    const trimmedNumeric = paddedNumeric.replace(/^0+/, '') || '0';
                    elevationValue = '−' + trimmedNumeric;
                } else {
                    // No minus sign - just pad to 4 digits
                    const numericPart = valueStr.replace(/[^0-9]/g, '');
                    const paddedNumeric = numericPart.padStart(4, '0');
                    // Remove leading zeros, but keep at least one digit
                    elevationValue = paddedNumeric.replace(/^0+/, '') || '0';
                }
            }
            
            // Get display values
            const baseValueEl = document.getElementById('baseValue');
            const heightValueEl = document.getElementById('heightValue');
            const redValueEl = document.getElementById('redValue');
            const heightSymbolEl = document.getElementById('heightSymbol');
            
            const baseValue = baseValueEl ? baseValueEl.textContent.trim() : '--';
            const heightValue = heightValueEl ? heightValueEl.textContent.trim() : '--';
            const redValue = redValueEl ? redValueEl.textContent.trim() : '--';
            const heightSymbol = heightSymbolEl ? heightSymbolEl.textContent.trim() : 'Δ';
            
            // Format the result text
            let resultText = `Set Elevation To: ${elevationValue} MIL`;
            
            // Get the button element - use passed element or fallback to querySelector
            const copyButton = buttonElement || document.querySelector('.copy-result-button');
            
            // Store original content if not already stored, or always use the known original
            if (copyButton && !copyButton.dataset.originalContent) {
                copyButton.dataset.originalContent = '⧉';
            }
            const originalContent = copyButton ? (copyButton.dataset.originalContent || '⧉') : '⧉';
            
            // Copy to clipboard
            navigator.clipboard.writeText(resultText).then(() => {
                // Show feedback
                if (copyButton) {
                    copyButton.classList.add('copied');
                    copyButton.innerHTML = '✓';
                    setTimeout(() => {
                        copyButton.innerHTML = originalContent;
                        copyButton.classList.remove('copied');
                    }, 2000);
                }
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = resultText;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    if (copyButton) {
                        copyButton.classList.add('copied');
                        copyButton.innerHTML = '✓';
                        setTimeout(() => {
                            copyButton.innerHTML = originalContent;
                            copyButton.classList.remove('copied');
                        }, 2000);
                    }
                } catch (err) {
                    alert('Failed to copy. Please select and copy the text manually.');
                }
                document.body.removeChild(textArea);
            });
        }
        
        // Reset calculator to default values
        function resetCalculator(buttonElement) {
            // Get button element
            const resetButton = buttonElement || document.querySelector('.reset-result-button');
            
            // Store original content if not already stored
            if (resetButton && !resetButton.dataset.originalContent) {
                resetButton.dataset.originalContent = '⟳';
            }
            const originalContent = resetButton ? (resetButton.dataset.originalContent || '⟳') : '⟳';
            
            // Add resetting class and change text
            if (resetButton) {
                resetButton.classList.add('resetting');
                resetButton.innerHTML = '✓';
            }
            
            // Reset input fields
            const distanceInput = document.getElementById('distance');
            const heightDiffInput = document.getElementById('heightDiff');
            const redNumberInput = document.getElementById('redNumber');
            
            if (distanceInput) {
                distanceInput.value = '400';
                // Update ruler directly (don't trigger input event which might interfere with snap)
                if (typeof updateArmoredRuler === 'function') {
                    updateArmoredRuler(400);
                }
            }
            if (heightDiffInput) {
                heightDiffInput.value = '0';
            }
            if (redNumberInput) {
                redNumberInput.value = '0';
            }
            
            // Sync snap toggle state if snap is enabled
            const snapToggle = document.getElementById('snapToggle');
            if (snapToggle && snapToggle.checked) {
                // If snap is on, ensure it's properly synced and value is snapped
                if (typeof syncArmoredToggles === 'function') {
                    syncArmoredToggles();
                }
                // Snap value to nearest 25m (400 is already on 25m boundary)
                const snappedValue = Math.round(400 / 25) * 25;
                if (distanceInput) {
                    distanceInput.value = snappedValue;
                    if (typeof updateArmoredRuler === 'function') {
                        updateArmoredRuler(snappedValue);
                    }
                }
            }
            
            // Recalculate to update all displays and counter
            // Use setTimeout to ensure inputs are processed first
            setTimeout(() => {
                if (typeof calculate === 'function') {
                    calculate();
                } else {
                    // Fallback: manually reset counter and displays
                    if (typeof rollElevationToNumber === 'function') {
                        rollElevationToNumber(0);
                    } else if (typeof setupElevationCounter === 'function') {
                        setupElevationCounter(0);
                    }
                    
                    // Reset display values
                    const baseValueEl = document.getElementById('baseValue');
                    const heightValueEl = document.getElementById('heightValue');
                    const redValueEl = document.getElementById('redValue');
                    
                    if (baseValueEl) baseValueEl.textContent = '0';
                    if (heightValueEl) heightValueEl.textContent = '0m';
                    if (redValueEl) redValueEl.textContent = '+0';
                }
                
                // Hide warning if visible
                const warningDiv = document.getElementById('warning');
                if (warningDiv) {
                    hideWarning(warningDiv);
                }
                
                // Ensure snap toggle is synced after reset
                if (typeof syncArmoredToggles === 'function') {
                    syncArmoredToggles();
                }
                
                // Save state
                if (typeof saveState === 'function') {
                    saveState();
                }
            }, 50);
            
            // Reset button appearance after a moment
            setTimeout(() => {
                if (resetButton) {
                    resetButton.classList.remove('resetting');
                    resetButton.innerHTML = originalContent;
                }
            }, 800);
        }
        
        // Explicitly expose to global scope for inline onclick handlers
        window.resetCalculator = resetCalculator;

        // Save current UI state to localStorage
        function saveState() {
            try {
                const state = {
                    faction: document.getElementById('faction').value,
                    distance: document.getElementById('distance').value,
                    heightDiff: document.getElementById('heightDiff').value,
                    redNumber: document.getElementById('redNumber').value,
                    fineTune: document.getElementById('snapToggle') ? document.getElementById('snapToggle').checked : false,
                    autoCalc: document.getElementById('autoCalcToggle') ? document.getElementById('autoCalcToggle').checked : true
                };
                localStorage.setItem('hllSpaState', JSON.stringify(state));
            } catch (e) {
                // Ignore storage errors (e.g., disabled storage)
            }
        }

        // Load UI state from localStorage if available
        function loadState() {
            try {
                const raw = localStorage.getItem('hllSpaState');
                if (!raw) return;
                const state = JSON.parse(raw);

                if (state.faction) {
                    const hiddenFaction = document.getElementById('faction');
                    hiddenFaction.value = state.faction;

                    // Update custom select display
                    const flagMap = {
                        'British (Bishop SP)': 'BRITISH_30.webp',
                        'British (Churchill AVRE)': 'BRITISH_30.webp',
                        'US (Sherman M4A3 105)': 'US_30.webp',
                        'Soviet Union (KV-2)': 'SOVIET_30.webp',
                        'DAK (Panzer III Ausf.N)': 'GERMANY_30.webp',
                        'Germany (Sturmpanzer IV Brummbär)': 'GERMANY_30.webp'
                    };

                    const flag = flagMap[state.faction] || 'BRITISH_30.webp';
                    const selectSelected = document.getElementById('selectSelected');
                    // Format faction name for display (remove "105" from M4A3)
                    const displayName = state.faction.replace(' (Sherman M4A3 105)', ' (Sherman M4A3)');
                    selectSelected.innerHTML = `<img src="images/UI/Icons/flags/${flag}" alt="${flag.split('.')[0]}" class="flag-icon" loading="eager" decoding="async"> <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;">${displayName}</span>`;

                    updateFactionImage();
                }

                const distanceInput = document.getElementById('distance');
                if (state.distance !== undefined && state.distance !== null && state.distance !== '') {
                    distanceInput.value = state.distance;
                    updateArmoredRuler(parseFloat(state.distance) || 400);
                }

                const heightDiffInput = document.getElementById('heightDiff');
                if (state.heightDiff !== undefined && state.heightDiff !== null && state.heightDiff !== '') {
                    heightDiffInput.value = state.heightDiff;
                }

                const redNumberInput = document.getElementById('redNumber');
                if (state.redNumber !== undefined && state.redNumber !== null && state.redNumber !== '') {
                    redNumberInput.value = state.redNumber;
                }

                const snapToggle = document.getElementById('snapToggle');
                if (snapToggle && typeof state.fineTune === 'boolean') {
                    snapToggle.checked = state.fineTune;
                    updateSnapModeLabel();
                }

                const autoCalcToggle = document.getElementById('autoCalcToggle');
                if (autoCalcToggle && typeof state.autoCalc === 'boolean') {
                    autoCalcToggle.checked = state.autoCalc;
                    updateCalcModeLabel();
                }
                
                // Update UI elements after loading state
                if (distanceInput) {
                    updateArmoredRuler(parseFloat(distanceInput.value) || 400);
                }
                updateCalculateButton();
                updateToggleLEDs();
            } catch (e) {
                // Ignore parse/storage errors
            }
        }

        // Function to update calculation mode label (no longer needed - labels are static)
        function updateCalcModeLabel() {
            // Labels are now static, no update needed
        }

        // Function to update snap mode label (no longer needed - labels are static)
        function updateSnapModeLabel() {
            // Labels are now static, no update needed
        }

        // Toggle function for armored panel switches
        function toggleArmoredSwitch(checkboxId, element) {
            try {
                const checkbox = document.getElementById(checkboxId);
                if (!checkbox) {
                    return;
                }
                
                checkbox.checked = !checkbox.checked;
                
                // Update visual state immediately
                if (checkbox.checked) {
                    element.classList.add('active');
                } else {
                    element.classList.remove('active');
                }
                
                // Trigger the existing event handlers
                if (checkboxId === 'snapToggle') {
                    const event = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(event);
                } else if (checkboxId === 'autoCalcToggle') {
                    const event = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(event);
                    // Also sync the toggle state to ensure it's correct
                    syncArmoredToggles();
                }
            } catch (error) {
                console.error('Error in toggleArmoredSwitch:', error);
            }
        }
        
        // Explicitly expose to global scope for inline onclick handlers
        window.toggleArmoredSwitch = toggleArmoredSwitch;

        // Sync armored toggles with checkboxes on load
        function syncArmoredToggles() {
            const snapToggle = document.getElementById('snapToggle');
            const autoToggle = document.getElementById('autoCalcToggle');
            const armoredSnap = document.getElementById('armoredSnapToggle');
            const armoredAuto = document.getElementById('armoredAutoToggle');
            
            if (snapToggle && armoredSnap) {
                if (snapToggle.checked) {
                    armoredSnap.classList.add('active');
                } else {
                    armoredSnap.classList.remove('active');
                }
            }
            
            if (autoToggle && armoredAuto) {
                if (autoToggle.checked) {
                    armoredAuto.classList.add('active');
                } else {
                    armoredAuto.classList.remove('active');
                }
            }
            
            // Update LED indicators
            updateToggleLEDs();
        }

        // Function to update LED-style toggle labels
        function updateToggleLEDs() {
            const snapToggle = document.getElementById('snapToggle');
            const snapOnLabel = document.getElementById('snapOnLabel');
            const snapOffLabel = document.getElementById('snapOffLabel');
            const autoCalcToggle = document.getElementById('autoCalcToggle');
            const calcOnLabel = document.getElementById('calcOnLabel');
            const calcOffLabel = document.getElementById('calcOffLabel');
            
            // Update Ruler Snap toggle labels
            if (snapToggle && snapOnLabel && snapOffLabel) {
                if (snapToggle.checked) {
                    // ON state: light up ON label with green LED, turn OFF label off
                    snapOnLabel.classList.add('led-on-green');
                    snapOnLabel.classList.remove('led-off');
                    snapOffLabel.classList.remove('led-on-green', 'led-off');
                } else {
                    // OFF state: light up OFF label with red LED, turn ON label off
                    snapOffLabel.classList.add('led-off');
                    snapOffLabel.classList.remove('led-on-green');
                    snapOnLabel.classList.remove('led-on-green', 'led-off');
                }
            }
            
            // Update Auto Calculation toggle labels
            if (autoCalcToggle && calcOnLabel && calcOffLabel) {
                if (autoCalcToggle.checked) {
                    // ON state: light up ON label with green LED, turn OFF label off
                    calcOnLabel.classList.add('led-on-green');
                    calcOnLabel.classList.remove('led-off');
                    calcOffLabel.classList.remove('led-on-green', 'led-off');
                } else {
                    // OFF state: light up OFF label with red LED, turn ON label off
                    calcOffLabel.classList.add('led-off');
                    calcOffLabel.classList.remove('led-on-green');
                    calcOnLabel.classList.remove('led-on-green', 'led-off');
                }
            }
        }

        // Load any saved state before wiring up interactions
        loadState();
        
        // #region agent log
        function checkElevationLabelOverlap() {
            const resultContainer = document.getElementById('result');
            if (!resultContainer) return;
            const copyButton = resultContainer.querySelector('.copy-result-button');
            const resetButton = resultContainer.querySelector('.reset-result-button');
            const label = resultContainer.querySelector('.panel-label');
            if (!copyButton || !resetButton || !label) return;
            const containerWidth = resultContainer.offsetWidth;
            const containerRect = resultContainer.getBoundingClientRect();
            const copyRect = copyButton.getBoundingClientRect();
            const resetRect = resetButton.getBoundingClientRect();
            const labelRect = label.getBoundingClientRect();
            const leftButtonRight = resetRect.right - containerRect.left;
            const rightButtonLeft = copyRect.left - containerRect.left;
            const availableWidth = rightButtonLeft - leftButtonRight;
            const labelWidth = labelRect.width;
            const labelLeft = labelRect.left - containerRect.left;
            const labelRight = labelRect.right - containerRect.left;
            const overlapsLeft = labelLeft < leftButtonRight;
            const overlapsRight = labelRight > rightButtonLeft;
            fetch('http://127.0.0.1:7242/ingest/28125f55-0e6d-43a1-ac1a-2bf78147e3ae',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:5854',message:'Elevation label overlap check',data:{containerWidth:containerWidth,leftButtonRight:leftButtonRight,rightButtonLeft:rightButtonLeft,availableWidth:availableWidth,labelWidth:labelWidth,labelLeft:labelLeft,labelRight:labelRight,overlapsLeft:overlapsLeft,overlapsRight:overlapsRight,timestamp:Date.now()},sessionId:'debug-session',runId:'pre-fix',hypothesisId:'A'})}).catch(()=>{});
        }
        // #endregion
        
        // Initialize mechanical counter
        setupElevationCounter(0);
        initializeElevationMIL();

        // Ensure faction image and badges are displayed on initial load
        updateFactionImage();
        updateMilRangeText();

        syncSliderWithInput();

        // #region agent log
        checkElevationLabelOverlap();
        window.addEventListener('resize', checkElevationLabelOverlap);
        // #endregion
        
        // Run initial calculation after everything is set up (only if auto mode)
        if (isAutoCalcEnabled()) {
            calculate();
        } else {
            // Show default "0000 MIL" when auto calculation is off on initial load
            setupElevationCounter(0);
            rollElevationToNumber(0);
            const baseEl = document.getElementById('baseValue');
            const heightEl = document.getElementById('heightValue');
            const redEl = document.getElementById('redValue');
            if (baseEl) baseEl.textContent = '--';
            // Show "--" when auto calculation is off
            if (heightEl) {
                heightEl.textContent = '--';
            }
            if (redEl) {
                redEl.textContent = '--';
            }
        }
        updateCalculateButton();
        updateMilLabels();
        syncArmoredToggles();
        
        // Sync armored toggles when checkboxes change
        const snapToggleCheckbox = document.getElementById('snapToggle');
        const autoToggleCheckbox = document.getElementById('autoCalcToggle');
        if (snapToggleCheckbox) {
            snapToggleCheckbox.addEventListener('change', syncArmoredToggles);
        }
        if (autoToggleCheckbox) {
            autoToggleCheckbox.addEventListener('change', syncArmoredToggles);
        }

        // Make editing fast and keep fields from being empty
        ['distance', 'heightDiff', 'redNumber'].forEach(id => {
            const input = document.getElementById(id);
            if (!input) return;

            // On focus/click, select the entire value so typing overwrites it
            const selectAllHandler = function() {
                const v = this.value || '';
                if (!v.length) return;
                setTimeout(() => {
                    try {
                        this.setSelectionRange(0, v.length);
                    } catch (e) {
                        // some browsers may not support setSelectionRange
                    }
                }, 0);
            };

            // On blur, if left empty, force it back to 0
            const ensureNonEmptyHandler = function() {
                if (this.value.trim() === '') {
                    this.value = '0';
                    try {
                        if (this.id === 'distance') {
                            // update ruler with distance
                            updateArmoredRuler(0);
                        }
                        saveState();
                        if (isAutoCalcEnabled()) {
                        calculate();
                        } else {
                            // When auto calc is off, reset base value to "--"
                            const baseValueEl = document.getElementById('baseValue');
                            if (baseValueEl) {
                                baseValueEl.textContent = '--';
                            }
                        }
                    } catch (e) {
                        // ignore if not available yet
                    }
                } else {
                    // Enforce min/max limits for distance field
                    if (this.id === 'distance') {
                        const numValue = parseFloat(this.value);
                        if (!isNaN(numValue)) {
                            let finalValue = numValue;
                            
                            if (numValue < 0) {
                                finalValue = 0;
                            } else if (numValue > 1000) {
                                finalValue = 1000;
                            }
                            
                            // If snap mode is enabled, snap to nearest 25m
                            const snapToggle = document.getElementById('snapToggle');
                            if (snapToggle && snapToggle.checked) {
                                finalValue = Math.round(finalValue / 25) * 25;
                            }
                            
                            if (finalValue !== numValue) {
                                this.value = finalValue;
                            }
                            
                            // Update ruler with final value
                            updateArmoredRuler(finalValue);
                            
                            // If value was snapped, trigger calculation and save state
                            if (finalValue !== numValue) {
                                saveState();
                                if (isAutoCalcEnabled()) {
                                    calculate();
                                }
                            }
                        }
                    }
                    
                    // Enforce min/max limits for redNumber field (tank body angle)
                    if (this.id === 'redNumber') {
                        const numValue = parseFloat(this.value);
                        if (!isNaN(numValue)) {
                            if (numValue < -1000) {
                                this.value = '-1000';
                            } else if (numValue > 1000) {
                                this.value = '1000';
                            }
                        }
                    }
                    
                    // When leaving a field with a value, calculate in auto mode
                    if (isAutoCalcEnabled()) {
                        calculate();
                    }
                    // Note: When auto calc is off, don't reset base value on blur
                    // The base value should only be reset when input values actually change,
                    // not when fields lose focus (e.g., clicking calculate button)
                }
            };

            // On focus (when tabbing to field), calculate in auto mode
            const focusCalcHandler = function() {
                // Don't calculate on focus - it interferes with typing
                // Calculation will happen on blur instead
            };

            // Prevent typing letters - only allow numbers and decimal separator (comma or period)
            input.addEventListener('keypress', function(e) {
                const char = String.fromCharCode(e.which || e.keyCode);
                const currentValue = this.value;
                
                // Allow minus sign only at the start for redNumber and heightDiff
                if (char === '-') {
                    if (this.id === 'redNumber' || this.id === 'heightDiff') {
                        // Only allow minus at the start and if not already present
                        if (this.selectionStart !== 0 || currentValue.includes('-')) {
                            e.preventDefault();
                        }
                        return;
                    } else {
                        e.preventDefault();
                        return;
                    }
                }
                
                // Allow: numbers (0-9), comma (,), period (.)
                if (!/[0-9,.]/.test(char) && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    return;
                }
                
                // Only allow one decimal separator
                if ((char === ',' || char === '.') && (currentValue.includes(',') || currentValue.includes('.'))) {
                    e.preventDefault();
                }
            });

            // Normalize input value - convert comma to period and ensure only numbers and one decimal separator
            input.addEventListener('input', function(e) {
                const cursorPos = this.selectionStart;
                let value = this.value;
                
                // Handle negative numbers for redNumber and heightDiff fields
                const isNegative = value.startsWith('-');
                // Remove all non-numeric characters except comma, period, and minus sign
                value = value.replace(/[^0-9,.\-]/g, '');
                // Ensure minus sign is only at the start
                if (value.includes('-')) {
                    value = '-' + value.replace(/-/g, '');
                } else if (isNegative && !value.startsWith('-')) {
                    value = '-' + value;
                }
                
                // Replace comma with period
                value = value.replace(/,/g, '.');
                // Ensure only one decimal separator
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                
                // Enforce min/max limits for distance field
                if (this.id === 'distance') {
                    // Turn off snap mode when typing to allow exact values
                    const snapToggle = document.getElementById('snapToggle');
                    if (snapToggle && snapToggle.checked) {
                        snapToggle.checked = false;
                        updateSnapModeLabel();
                        // Note: saveState() will be called by the distanceInput input handler
                        // that syncs the ruler, so we don't need to call it here
                    }
                    
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        if (numValue < 0) {
                            value = '0';
                        } else if (numValue > 1000) {
                            value = '1000';
                        }
                    }
                }
                
                // Enforce min/max limits for redNumber field (tank body angle)
                if (this.id === 'redNumber') {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        if (numValue < -1000) {
                            value = '-1000';
                        } else if (numValue > 1000) {
                            value = '1000';
                        }
                    }
                }
                
                // Enforce min/max limits for heightDiff field
                if (this.id === 'heightDiff') {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        if (numValue < -5000) {
                            value = '-5000';
                        } else if (numValue > 5000) {
                            value = '5000';
                        }
                    }
                }
                
                if (value !== this.value) {
                    this.value = value;
                    // Restore cursor position
                    setTimeout(() => {
                        const newPos = Math.min(cursorPos, value.length);
                        this.setSelectionRange(newPos, newPos);
                    }, 0);
                }
                
                // Trigger calculation in auto mode when any input changes
                // calculate() will set all display values correctly
                if (isAutoCalcEnabled()) {
                    if (this.id === 'heightDiff' || this.id === 'redNumber' || this.id === 'distance') {
                        // Use setTimeout to ensure value is updated in DOM before calculation
                        setTimeout(() => {
                            calculate();
                        }, 0);
                    }
                } else {
                    // When auto calc is off, reset base value to "--" and final value to 0000 when any input changes
                    if (this.id === 'heightDiff' || this.id === 'redNumber' || this.id === 'distance') {
                        const baseValueEl = document.getElementById('baseValue');
                        if (baseValueEl) {
                            baseValueEl.textContent = '--';
                        }
                        // Reset final value to 0000 when auto calc is off
                        rollElevationToNumber(0);
                        // Show "--" for height and elevation when auto calc is off
                        const heightValueEl = document.getElementById('heightValue');
                        const redValueEl = document.getElementById('redValue');
                        if (heightValueEl) heightValueEl.textContent = '--';
                        if (redValueEl) redValueEl.textContent = '--';
                        // Update MIL labels after values are set to "--"
                        updateMilLabels();
                    }
                }
            });

            // Also prevent paste of non-numeric content
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                
                // Handle negative numbers for redNumber and heightDiff fields
                const isNegative = paste.trim().startsWith('-');
                // Remove all non-numeric characters except comma, period, and minus sign
                let cleaned = paste.replace(/[^0-9,.\-]/g, '');
                // Ensure minus sign is only at the start
                if (cleaned.includes('-')) {
                    cleaned = '-' + cleaned.replace(/-/g, '');
                } else if (isNegative && !cleaned.startsWith('-')) {
                    cleaned = '-' + cleaned;
                }
                
                // Replace comma with period for consistency, or keep first decimal separator
                if (cleaned.includes(',') && cleaned.includes('.')) {
                    // If both exist, keep the first one
                    const firstComma = cleaned.indexOf(',');
                    const firstPeriod = cleaned.indexOf('.');
                    if (firstComma < firstPeriod) {
                        cleaned = cleaned.replace(/\./g, '');
                    } else {
                        cleaned = cleaned.replace(/,/g, '');
                    }
                } else if (cleaned.includes(',')) {
                    // Replace comma with period
                    cleaned = cleaned.replace(/,/g, '.');
                }
                // Ensure only one decimal separator
                const parts = cleaned.split('.');
                if (parts.length > 2) {
                    cleaned = parts[0] + '.' + parts.slice(1).join('');
                }
                
                // Apply limits after cleaning
                if (this.id === 'distance') {
                    const numValue = parseFloat(cleaned);
                    if (!isNaN(numValue)) {
                        if (numValue < 0) cleaned = '0';
                        else if (numValue > 1000) cleaned = '1000';
                    }
                } else if (this.id === 'redNumber') {
                    const numValue = parseFloat(cleaned);
                    if (!isNaN(numValue)) {
                        if (numValue < -1000) cleaned = '-1000';
                        else if (numValue > 1000) cleaned = '1000';
                    }
                }
                
                this.value = cleaned;
                
                // After paste, handle calculation or reset base value
                if (isAutoCalcEnabled()) {
                    if (this.id === 'heightDiff' || this.id === 'redNumber' || this.id === 'distance') {
                        // Use setTimeout to ensure value is updated in DOM before calculation
                        setTimeout(() => {
                            calculate();
                        }, 0);
                    }
                } else {
                    // When auto calc is off, reset base value to "--" when any input changes
                    if (this.id === 'heightDiff' || this.id === 'redNumber' || this.id === 'distance') {
                        const baseValueEl = document.getElementById('baseValue');
                        if (baseValueEl) {
                            baseValueEl.textContent = '--';
                        }
                    }
                }
            });

            input.addEventListener('focus', selectAllHandler);
            input.addEventListener('focus', focusCalcHandler);
            input.addEventListener('click', selectAllHandler);
            input.addEventListener('blur', ensureNonEmptyHandler);
        });

        // Fine-tuning toggle functionality
        const snapToggleEl = document.getElementById('snapToggle');

        // If no saved state set it, default to fine-tune mode
        if (!localStorage.getItem('hllSpaState')) {
            if (snapToggleEl) {
                snapToggleEl.checked = false;
            }
            updateSnapModeLabel();
        }

        if (snapToggleEl) {
            snapToggleEl.addEventListener('change', function() {
                syncArmoredToggles();
                if (this.checked) {
                    // Snap mode: 25m increments
                    // Snap current value to nearest 25m
                    const distanceInput = document.getElementById('distance');
                    const currentValue = parseFloat(distanceInput.value) || 400;
                    const snappedValue = Math.round(currentValue / 25) * 25;
                    distanceInput.value = snappedValue;
                    // Update ruler with new snapped value
                    updateArmoredRuler(snappedValue);
                    // Trigger calculation if auto mode is enabled
                    if (isAutoCalcEnabled()) {
                        calculate();
                    }
                }
                updateSnapModeLabel();
                saveState();
            });
        }

        // Keyboard focus loop: Distance -> Height -> Elevation -> Calculate (manual only) -> Distance
        const distanceInputEl = document.getElementById('distance');
        const heightInputEl = document.getElementById('heightDiff');
        const redInputEl = document.getElementById('redNumber');
        const calcButtonEl = document.getElementById('calculateButton');

        // Function to update tab loop based on auto/manual mode
        function updateTabLoop() {
            const isAuto = isAutoCalcEnabled();
            
            if (calcButtonEl) {
                // In auto mode, remove button from tab order; in manual mode, include it
                calcButtonEl.tabIndex = isAuto ? -1 : 4;
            }
        }
        
        if (calcButtonEl && distanceInputEl && heightInputEl && redInputEl) {
            // Calculate button: loop back to Distance when tabbing forward (manual mode only)
            calcButtonEl.addEventListener('keydown', function(e) {
                if (e.key === 'Tab' && !e.shiftKey) {
                    if (!isAutoCalcEnabled()) {
                        e.preventDefault();
                        distanceInputEl.focus();
                        distanceInputEl.select();
                    }
                } else if (e.key === 'Enter') {
                    // Enter key will trigger calculate() via button's onclick
                    // Focus will be set to distance input by calculate() function in manual mode
                }
            });
            
            // RedNumber input: loop back to Distance when tabbing forward in auto mode
            redInputEl.addEventListener('keydown', function(e) {
                if (e.key === 'Tab' && !e.shiftKey) {
                    if (isAutoCalcEnabled()) {
                        e.preventDefault();
                        distanceInputEl.focus();
                        distanceInputEl.select();
                    }
                }
            });
            
            // Initialize tab loop
            updateTabLoop();
        }

        // Auto calculation toggle functionality
        const autoCalcToggle = document.getElementById('autoCalcToggle');
        
        // Set initial label text
        updateCalcModeLabel();
        updateSnapModeLabel();
        updateToggleLEDs();
        
        if (autoCalcToggle) {
            autoCalcToggle.addEventListener('change', function() {
                try {
                    updateCalcModeLabel();
                    updateToggleLEDs();
                    saveState();
                    updateCalculateButton();
                    updateTabLoop();
                    // If switching to auto, calculate immediately
                    if (this.checked) {
                        calculate();
                } else {
                    // Show default "0000 MIL" when auto calculation is turned off
                    rollElevationToNumber(0);
                    const baseValueEl = document.getElementById('baseValue');
                    const heightValueEl = document.getElementById('heightValue');
                    const redValueEl = document.getElementById('redValue');
                    if (baseValueEl) baseValueEl.textContent = '--';
                    // Show "--" when auto calculation is off
                    if (heightValueEl) {
                        heightValueEl.textContent = '--';
                    }
                    if (redValueEl) {
                        redValueEl.textContent = '--';
                    }
                    // Show MIL labels for default "0000"
                    updateMilLabels();
                }
                } catch (error) {
                    console.error('Error in auto calculation toggle:', error);
                    // Ensure toggle state is still updated even if calculation fails
                    updateToggleLEDs();
                    syncArmoredToggles();
                }
            });
        }

        // Update ruler on resize (in case layout changes)
        window.addEventListener('resize', function() {
            const distanceInput = document.getElementById('distance');
            if (distanceInput) {
                updateArmoredRuler(parseFloat(distanceInput.value) || 400);
            }
        });
        
        // Enter key cycling through inputs: Distance -> Height -> Elevation -> (Calculate in manual) -> Distance
        if (distanceInputEl && heightInputEl && redInputEl) {
            distanceInputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    heightInputEl.focus();
                    heightInputEl.select();
                }
            });
            
            heightInputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    redInputEl.focus();
                    redInputEl.select();
                }
            });
            
            redInputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (isAutoCalcEnabled()) {
                        // Auto mode: loop back to distance
                        distanceInputEl.focus();
                        distanceInputEl.select();
                    } else {
                        // Manual mode: focus calculate button
                        calcButtonEl.focus();
                    }
                }
            });
        }

        // Custom select functionality
        const selectSelected = document.getElementById('selectSelected');
        const selectItems = document.getElementById('selectItems');
        const hiddenFaction = document.getElementById('faction');

        selectSelected.addEventListener('click', function() {
            selectItems.classList.toggle('select-hide');
            this.classList.toggle('select-arrow-active');
        });

        selectItems.addEventListener('click', function(e) {
            if (e.target !== this) {
                const selectedDiv = e.target.closest('div');
                if (selectedDiv) {
                    const value = selectedDiv.getAttribute('data-value');
                    const text = selectedDiv.innerHTML;
                    // Wrap text content in span for truncation
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = text;
                    const img = tempDiv.querySelector('img');
                    const textContent = tempDiv.textContent.trim();
                    selectSelected.innerHTML = img ? `${img.outerHTML} <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;">${textContent}</span>` : `<span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;">${textContent}</span>`;
                    hiddenFaction.value = value;

                    selectItems.classList.add('select-hide');
                    selectSelected.classList.remove('select-arrow-active');

                    updateFactionImage();
                    if (isAutoCalcEnabled()) {
                    calculate();
                    } else {
                        // Reset final counter to 0000 when switching tanks and auto calc is off
                        rollElevationToNumber(0);
                    }
                    saveState();
                }
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-select')) {
                selectItems.classList.add('select-hide');
                selectSelected.classList.remove('select-arrow-active');
            }
        });

        // Tank info modal functionality
        const tankInfoIcon = document.getElementById('tankInfoIcon');
        const tankInfoModal = document.getElementById('tankInfoModal');
        const closeTankInfo = document.getElementById('closeTankInfo');
        const tankInfoTitle = document.getElementById('tankInfoTitle');
        const tankInfoContent = document.getElementById('tankInfoContent');

        // Mapping of tank names to screenshot folder names
        const tankScreenshotMap = {
            'US (Sherman M4A3 105)': 'M4A3',
            'Soviet Union (KV-2)': 'KV2',
            'British (Churchill AVRE)': 'AVRE',
            'British (Bishop SP)': 'BISHOP',
            'Germany (Sturmpanzer IV Brummbär)': 'STURMPANZER',
            'DAK (Panzer III Ausf.N)': 'PANZER III'
        };

        // Function to get screenshots for a tank
        function getTankScreenshots(tankName) {
            const folderName = tankScreenshotMap[tankName];
            if (!folderName) return [];
            
            // List of screenshot filenames for each tank (using new naming convention)
            const screenshotFiles = {
                'M4A3': [
                    'm4a3_1.png',
                    'm4a3_2.png',
                    'm4a3_3.png',
                    'm4a3_4.png',
                    'm4a3_5.png',
                    'm4a3_6.png',
                    'm4a3_7.png'
                ],
                'KV2': [
                    'kv2_1.png',
                    'kv2_2.png',
                    'kv2_3.png',
                    'kv2_4.png',
                    'kv2_5.png',
                    'kv2_6.png',
                    'kv2_7.png',
                    'kv2_8.png'
                ],
                'AVRE': [
                    'avre_1.png',
                    'avre_2.png',
                    'avre_3.png',
                    'avre_4.png',
                    'avre_5.png',
                    'avre_6.png',
                    'avre_7.png',
                    'avre_8.png'
                ],
                'BISHOP': [
                    'bishop_1.png',
                    'bishop_2.png',
                    'bishop_3.png',
                    'bishop_4.png',
                    'bishop_5.png',
                    'bishop_6.png',
                    'bishop_7.png',
                    'bishop_8.png'
                ],
                'STURMPANZER': [
                    'brummbar_1.png',
                    'brummbar_2.png',
                    'brummbar_3.png',
                    'brummbar_4.png',
                    'brummbar_5.png',
                    'brummbar_6.png',
                    'brummbar_7.png',
                    'brummbar_8.png'
                ],
                'PANZER III': [
                    'panzer3_1.png',
                    'panzer3_2.png',
                    'panzer3_3.png',
                    'panzer3_4.png',
                    'panzer3_5.png',
                    'panzer3_6.png',
                    'panzer3_7.png',
                    'panzer3_8.png'
                ]
            };
            
            const files = screenshotFiles[folderName] || [];
            // Use the updated screenshot set that matches the current UI styling
            return files.map(file => `images/screenshots/${folderName}/${file}`);
        }

        // Function to generate screenshot gallery HTML
        function generateScreenshotGallery(tankName) {
            const screenshots = getTankScreenshots(tankName);
            if (screenshots.length === 0) return '';
            
            const galleryItems = screenshots.map((src, index) => {
                // Escape quotes in the path for onclick attribute
                const escapedSrc = src.replace(/'/g, "\\'");
                // Create WebP paths (both thumbnail and full)
                const thumbSrcPNG = src.replace(/(\.[^.]+)$/, '_thumb$1');
                const thumbSrcWebP = thumbSrcPNG.replace(/\.png$/, '.webp');
                const fullSrcWebP = src.replace(/\.png$/, '.webp');
                return `
                    <div class="screenshot-item" data-src="${escapedSrc}" data-src-webp="${fullSrcWebP.replace(/'/g, "\\'")}">
                        <picture>
                            <source srcset="${thumbSrcWebP}" type="image/webp">
                            <img src="${thumbSrcPNG}" alt="Screenshot ${index + 1}" loading="lazy" decoding="async">
                        </picture>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="info-modal-section">
                    <h4>In-Game Screenshots</h4>
                    <div class="screenshot-gallery">
                        ${galleryItems}
                    </div>
                </div>
            `;
        }

        // Store current screenshot gallery and index
        let currentScreenshotGallery = [];
        let currentScreenshotIndex = -1;

        // Function to open screenshot in lightbox (make it global)
        window.openScreenshotLightbox = function(src) {
            const lightbox = document.getElementById('screenshotLightbox');
            const lightboxImg = document.getElementById('screenshotLightboxImg');
            const lightboxSource = document.getElementById('screenshotLightboxSource');
            if (lightbox && lightboxImg) {
                // IMMEDIATELY clear old image source using transparent pixel to force clear
                // This must happen before anything else to prevent old image flash
                const blankPixel = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                const lightboxPicture = lightboxImg.closest('picture');
                
                // ALWAYS hide picture element first if lightbox is active - prevents any rendering
                if (lightbox.classList.contains('active') && lightboxPicture) {
                    lightboxPicture.classList.add('switching');
                }
                
                if (lightbox.classList.contains('active') && lightboxImg.src) {
                    // Remove ready class and add hiding class
                    lightboxImg.classList.remove('ready');
                    lightboxImg.classList.add('hiding');
                    
                    // REMOVE source element from DOM entirely to prevent browser from using it
                    if (lightboxSource && lightboxSource.parentNode) {
                        lightboxSource.parentNode.removeChild(lightboxSource);
                    }
                    // Remove src entirely instead of setting to blank pixel - prevents browser from showing cached image
                    lightboxImg.removeAttribute('src');
                    lightboxImg.removeAttribute('srcset');
                    // Also clear any cached image data
                    if (lightboxImg.complete) {
                        lightboxImg.src = '';
                    }
                    
                    // Force multiple reflows to ensure the blank pixel is rendered
                    void lightboxImg.offsetHeight;
                    void lightboxImg.offsetWidth;
                }
                
                // Get all screenshots from the current gallery (both PNG and WebP)
                const screenshotItems = document.querySelectorAll('.screenshot-item');
                currentScreenshotGallery = Array.from(screenshotItems).map(item => {
                    // Try WebP first, fallback to PNG
                    const webpSrc = item.getAttribute('data-src-webp');
                    return webpSrc || item.getAttribute('data-src');
                });
                
                // Find the index of the clicked image
                const clickedItem = Array.from(screenshotItems).find(item => 
                    item.getAttribute('data-src') === src || item.getAttribute('data-src-webp') === src
                );
                
                let targetWebpSrc, targetPngSrc, targetSrc;
                
                if (clickedItem) {
                    targetWebpSrc = clickedItem.getAttribute('data-src-webp');
                    targetPngSrc = clickedItem.getAttribute('data-src');
                    targetSrc = targetPngSrc || src;
                    currentScreenshotIndex = Array.from(screenshotItems).indexOf(clickedItem);
                } else {
                    currentScreenshotIndex = 0;
                    targetSrc = currentScreenshotGallery[0] || src;
                }
                
                // If opening fresh, ensure image starts hidden but will show when ready
                if (!lightbox.classList.contains('active') || !lightboxImg.src || lightboxImg.src === blankPixel) {
                    // Remove ready class to ensure image is hidden initially
                    lightboxImg.classList.remove('ready');
                    lightboxImg.classList.remove('hiding');
                    // Remove switching class if present
                    if (lightboxPicture) {
                        lightboxPicture.classList.remove('switching');
                    }
                }
                
                // Preload the new image before switching to avoid showing old image
                const newImg = new Image();
                let imageLoaded = false;
                
                const switchImage = function() {
                    if (imageLoaded) return; // Prevent multiple calls
                    imageLoaded = true;
                    
                    // Recreate source element if it was removed, or update existing one
                    const pictureElement = lightboxImg.closest('picture');
                    let currentSource = pictureElement ? pictureElement.querySelector('source') : null;
                    
                    if (targetWebpSrc) {
                        if (!currentSource) {
                            // Recreate source element if it was removed
                            currentSource = document.createElement('source');
                            currentSource.id = 'screenshotLightboxSource';
                            currentSource.type = 'image/webp';
                            if (pictureElement) {
                                pictureElement.insertBefore(currentSource, lightboxImg);
                            }
                        }
                        currentSource.srcset = targetWebpSrc;
                    } else if (currentSource && currentSource.parentNode) {
                        // Remove source if no WebP version
                        currentSource.parentNode.removeChild(currentSource);
                    }
                    
                    // Set the new image source BUT keep picture hidden until image loads
                    lightboxImg.src = targetSrc;
                    
                    // Function to show the new image
                    const showNewImage = function() {
                        // Remove switching class from picture element
                        const lightboxPicture = pictureElement;
                        if (lightboxPicture) {
                            lightboxPicture.classList.remove('switching');
                        }
                        
                        // Remove hiding class and add ready class
                        lightboxImg.classList.remove('hiding');
                        lightboxImg.classList.add('ready');
                    };
                    
                    // Check if image is already loaded (cached)
                    if (lightboxImg.complete && lightboxImg.naturalWidth > 0) {
                        // Image is already loaded, show it (use small delay to ensure src is set)
                        setTimeout(function() {
                            showNewImage();
                        }, 10);
                    } else {
                        // Wait for image to load
                        const originalOnload = lightboxImg.onload;
                        lightboxImg.onload = function() {
                            if (originalOnload) originalOnload();
                            showNewImage();
                        };
                        const originalOnerror = lightboxImg.onerror;
                        lightboxImg.onerror = function() {
                            if (originalOnerror) originalOnerror();
                            // Even on error, show the image
                            showNewImage();
                        };
                    }
                };
                
                // Set up load handlers before setting src
                newImg.onload = switchImage;
                newImg.onerror = switchImage; // Still show image even if preload fails
                
                // Start loading
                newImg.src = targetSrc;
                
                // If image is already cached, onload may not fire, so check immediately
                if (newImg.complete) {
                    switchImage();
                }
                
                lightbox.classList.add('active');
            }
        };

        // Function to navigate between screenshots
        window.navigateScreenshot = function(direction) {
            if (currentScreenshotGallery.length === 0) return;
            
            currentScreenshotIndex += direction;
            
            // Loop around
            if (currentScreenshotIndex < 0) {
                currentScreenshotIndex = currentScreenshotGallery.length - 1;
            } else if (currentScreenshotIndex >= currentScreenshotGallery.length) {
                currentScreenshotIndex = 0;
            }
            
            const lightboxImg = document.getElementById('screenshotLightboxImg');
            const lightboxSource = document.getElementById('screenshotLightboxSource');
            const screenshotItems = document.querySelectorAll('.screenshot-item');
            
            if (lightboxImg && screenshotItems[currentScreenshotIndex]) {
                const item = screenshotItems[currentScreenshotIndex];
                const webpSrc = item.getAttribute('data-src-webp');
                const pngSrc = item.getAttribute('data-src');
                const targetSrc = pngSrc || currentScreenshotGallery[currentScreenshotIndex];
                
                // Preload the image before switching to avoid visible loading
                const newImg = new Image();
                
                // Fade out current image
                lightboxImg.style.transition = 'opacity 0.15s ease';
                lightboxImg.style.opacity = '0';
                
                // Preload the new image
                const switchImage = function() {
                    // Update source elements
                    if (lightboxSource && webpSrc) {
                        lightboxSource.srcset = webpSrc;
                    }
                    lightboxImg.src = targetSrc;
                    
                    // Fade in the new image
                    requestAnimationFrame(function() {
                        lightboxImg.style.opacity = '1';
                    });
                };
                
                // Set up load handlers before setting src
                newImg.onload = switchImage;
                newImg.onerror = switchImage; // Still show image even if preload fails
                
                // Start loading
                newImg.src = targetSrc;
                
                // If image is already cached, onload may not fire, so check immediately
                if (newImg.complete) {
                    switchImage();
                }
            }
        };

        // Function to close screenshot lightbox (make it global)
        window.closeScreenshotLightbox = function() {
            const lightbox = document.getElementById('screenshotLightbox');
            if (lightbox) {
                lightbox.classList.remove('active');
            }
        };

        // Keyboard navigation for lightbox
        document.addEventListener('keydown', function(e) {
            const lightbox = document.getElementById('screenshotLightbox');
            if (lightbox && lightbox.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeScreenshotLightbox();
                } else if (e.key === 'ArrowLeft') {
                    navigateScreenshot(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateScreenshot(1);
                }
            }
        });

        function showTankInfo() {
            const faction = document.getElementById('faction').value;
            const info = tankInfo[faction];
            
            if (info) {
                tankInfoTitle.textContent = info.title;
                
                // Helper function to format ammunition (200 × 6 or 200/6 means rounds × magazines)
                function formatAmmo(text) {
                    if (text.includes(' × ') || text.includes('×') || text.includes('/')) {
                        // Replace × with × and add clarification
                        return text.replace(/(\d+)\s*[×/]\s*(\d+)/g, '$1 rounds × $2 magazines');
                    }
                    return text;
                }
                
                // Generate screenshot gallery
                const screenshotGallery = generateScreenshotGallery(faction);
                
                // Function to collect all image paths that will be used in the content
                function collectImagePaths(info) {
                    const imagePaths = new Set();
                    
                    // Collect from main gun
                    if (info.stats.mainGun) {
                        const parts = info.stats.mainGun.split(' - ');
                        if (parts.length === 2) {
                            const ammoText = parts[1];
                            const ammoMatches = ammoText.match(/(\d+)\s*(HE|SMOKE|AP)\s*rounds/g);
                            if (ammoMatches) {
                                ammoMatches.forEach(m => {
                                    const match = m.match(/(\d+)\s*(HE|SMOKE|AP)/);
                                    if (match) {
                                        const type = match[2];
                                        imagePaths.add(`images/UI/Icons/vehicles/${type.toUpperCase()}_invert_28.png`);
                                    }
                                });
                            }
                        }
                    }
                    
                    // Collect from coaxial and hull gun (T_HUD_Status_Ammo_invert_28.png)
                    if (info.stats.coaxial && !info.stats.coaxial.includes('NO')) {
                        imagePaths.add('images/UI/Icons/vehicles/T_HUD_Status_Ammo_invert_28.png');
                    }
                    if (info.stats.hullGun && !info.stats.hullGun.includes('NO')) {
                        imagePaths.add('images/UI/Icons/vehicles/T_HUD_Status_Ammo_invert_28.png');
                    }
                    
                    return Array.from(imagePaths);
                }
                
                // Function to preload images
                function preloadImages(imagePaths) {
                    return Promise.all(imagePaths.map(path => {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.onload = resolve;
                            img.onerror = resolve; // Resolve even on error to not block
                            img.src = path;
                        });
                    }));
                }
                
                function formatMainGun(text) {
                    // Extract gun name and ammunition info
                    const parts = text.split(' - ');
                    if (parts.length === 2) {
                        const gunName = parts[0];
                        const ammoText = parts[1];
                        
                        // Extract all ammo types with their counts - build complete HTML
                        const ammoItems = [];
                        const ammoMatches = ammoText.match(/(\d+)\s*(HE|SMOKE|AP)\s*rounds/g);
                        if (ammoMatches) {
                            ammoMatches.forEach(m => {
                                const match = m.match(/(\d+)\s*(HE|SMOKE|AP)/);
                                if (match) {
                                    const count = match[1];
                                    const type = match[2];
                                    // Construct image path - type is already uppercase from regex
                                    const imagePath = `images/UI/Icons/vehicles/${type.toUpperCase()}_invert_28.png`;
                                    // Build each ammo item with explicit image tag (inside single box)
                                    ammoItems.push(`<span style="display: inline-flex; align-items: center; gap: 3px; margin-right: 8px;"><img src="${imagePath}" alt="${type}" style="width: 14px; height: 14px; object-fit: contain;" loading="eager" decoding="async"><span class="highlight-number">${count}</span> <span class="highlight-number">${type}</span></span>`);
                                }
                            });
                        }
                        
                        // Return gun name + single ammo box containing all ammo types
                        const ammoBox = ammoItems.length > 0 
                            ? `<span class="ammo-box">${ammoItems.join('')}</span>`
                            : '';
                        return `<span class="highlight-number" style="margin-right: 14px;">${gunName}</span>${ammoBox}`;
                    }
                    return `<span class="highlight-number">${text}</span>`;
                }
                
                // Function to highlight elevation MIL values - full value highlighted
                function formatElevation(text) {
                    return `<span class="highlight-number">${text}</span>`;
                }
                
                // Function to highlight turret rotation
                function formatTurretRotation(text) {
                    return `<span class="highlight-number">${text}</span>`;
                }
                
                // Function to highlight top speed - full value highlighted
                function formatTopSpeed(text) {
                    return `<span class="highlight-number">${text}</span>`;
                }
                
                // Function to highlight coaxial and hull gun
                function formatGunAmmo(text) {
                    if (text.includes('NO') || text.includes('NO ')) {
                        return `<span class="no-weapon-marked">${text}</span>`;
                    }
                    // Split by " - " to separate gun name and ammo
                    const parts = text.split(' - ');
                    if (parts.length === 2) {
                        const gunName = parts[0];
                        const ammoText = parts[1];
                        // Format: "200 rounds × 6 magazines" into one box with image
                        const ammoMatch = ammoText.match(/(\d+)\s*rounds\s*[×x]\s*(\d+)\s*magazines/i);
                        if (ammoMatch) {
                            const rounds = ammoMatch[1];
                            const magazines = ammoMatch[2];
                            const imagePath = 'images/UI/Icons/vehicles/T_HUD_Status_Ammo_invert_28.png';
                            return `<span class="highlight-number" style="margin-right: 14px;">${gunName}</span><span class="ammo-box"><img src="${imagePath}" alt="Ammo" loading="eager" decoding="async"><span class="highlight-number">${rounds}</span> rounds × <span class="highlight-number">${magazines}</span> magazines</span>`;
                        }
                    }
                    // Fallback to highlight full text
                    return `<span class="highlight-number">${text}</span>`;
                }
                
                // Generate content for each tab
                const statsContent = `
                    <div class="info-tab-content active" id="tab-stats">
                        <div class="field-manual-specs">
                            <div class="spec-header">
                                <div class="spec-title">VEHICLE STATS</div>
                                <div class="spec-subtitle">Performance Data</div>
                            </div>
                            
                            <div class="spec-table">
                                <div class="spec-row">
                                    <div class="spec-label">PRIMARY ARMAMENT:</div>
                                    <div class="spec-value">${formatMainGun(info.stats.mainGun)}</div>
                                </div>
                                <div class="spec-row">
                                    <div class="spec-label">ELEVATION RANGE:</div>
                                    <div class="spec-value">${formatElevation(info.stats.elevation)}</div>
                                </div>
                                <div class="spec-row">
                                    <div class="spec-label">TURRET ROTATION:</div>
                                    <div class="spec-value">${formatTurretRotation(info.stats.turretRotation)}</div>
                                </div>
                                <div class="spec-row weapon-row ${(info.stats.coaxial && (info.stats.coaxial.includes('NO') || info.stats.coaxial.includes('NO '))) ? 'no-weapon-row' : ''}">
                                    <div class="spec-label">COAXIAL WEAPON:</div>
                                    <div class="spec-value">${formatGunAmmo(formatAmmo(info.stats.coaxial))}</div>
                                </div>
                                <div class="spec-row weapon-row ${(info.stats.hullGun && (info.stats.hullGun.includes('NO') || info.stats.hullGun.includes('NO '))) ? 'no-weapon-row' : ''}">
                                    <div class="spec-label">HULL MACHINE GUN:</div>
                                    <div class="spec-value">${formatGunAmmo(formatAmmo(info.stats.hullGun))}</div>
                                </div>
                                <div class="spec-row">
                                    <div class="spec-label">MAXIMUM SPEED:</div>
                                    <div class="spec-value">${formatTopSpeed(info.stats.topSpeed)}</div>
                                </div>
                            </div>
                            
                            <div class="field-manual-footer">
                                <div class="footer-line">────────────────────────────────────────</div>
                                <div class="footer-note">NOTES: Specifications based on in-game data. Actual performance may vary.</div>
                                <div class="footer-stamp">VERIFIED: ██/██/1944</div>
                            </div>
                        </div>
                    </div>
                `;
                
                const screenshotsContent = `
                    <div class="info-tab-content" id="tab-screenshots">
                        ${screenshotGallery || '<div class="info-modal-section"><p>No screenshots available for this tank.</p></div>'}
                    </div>
                `;
                
                const historyContent = `
                    <div class="info-tab-content" id="tab-history">
                        <div class="info-modal-section">
                            <h4>Background</h4>
                            <p>${info.history}</p>
                        </div>
                        <div class="info-modal-section">
                            <h4>Range</h4>
                            <p>${info.realLife.range}</p>
                        </div>
                        <div class="info-modal-section">
                            <h4>Production</h4>
                            <p>${info.realLife.production}</p>
                        </div>
                        <div class="info-modal-section">
                            <h4>Service</h4>
                            <p>${info.realLife.service}</p>
                        </div>
                        <div class="info-modal-section">
                            <h4>Strengths & Weaknesses</h4>
                            ${info.realLife.strengths && info.realLife.strengths.length > 0 ? `
                                <div class="typewriter-note typewriter-excelled" style="margin-bottom: 16px; margin-top: 12px;">
                                    <div class="typewriter-label">WHERE IT EXCELLED:</div>
                                    <ul class="typewriter-list">
                                        ${info.realLife.strengths.map(strength => `<li>${strength}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${info.realLife.weaknesses && info.realLife.weaknesses.length > 0 ? `
                                <div class="typewriter-note typewriter-struggled">
                                    <div class="typewriter-label">WHERE IT STRUGGLED:</div>
                                    <ul class="typewriter-list">
                                        ${info.realLife.weaknesses.map(weakness => `<li>${weakness}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Collect and preload images before displaying modal
                const imagePaths = collectImagePaths(info);
                
                // Preload images, then display modal
                preloadImages(imagePaths).then(() => {
                    tankInfoContent.innerHTML = statsContent + screenshotsContent + historyContent;
                    tankInfoModal.style.display = 'block';
                    tankInfoModal.setAttribute('data-open', 'true');
                    // Keep button extended when modal is open
                    if (tankInfoIcon) {
                        tankInfoIcon.classList.add('extended');
                    }
                    
                    // Reset tabs to default "stats" tab
                    const tabContainer = document.querySelector('.info-modal-tabs');
                    if (tabContainer) {
                        // Remove active from all tabs
                        tabContainer.querySelectorAll('.info-modal-tab').forEach(btn => btn.classList.remove('active'));
                        // Set stats tab as active
                        const statsTab = tabContainer.querySelector('[data-tab="stats"]');
                        if (statsTab) {
                            statsTab.classList.add('active');
                        }
                    }

                    // Ensure stats content is visible
                    const modalContent = document.querySelector('.info-modal-content');
                    if (modalContent) {
                        modalContent.querySelectorAll('.info-tab-content').forEach(content => content.classList.remove('active'));
                        const statsTabContent = modalContent.querySelector('#tab-stats');
                        if (statsTabContent) {
                            statsTabContent.classList.add('active');
                        }
                    }
                    
                    // Add click handlers for screenshot items (using event delegation)
                    const screenshotItems = tankInfoContent.querySelectorAll('.screenshot-item');
                    screenshotItems.forEach(item => {
                        item.addEventListener('click', function(e) {
                            // IMMEDIATELY clear old image before opening new one to prevent flash
                            const lightboxImg = document.getElementById('screenshotLightboxImg');
                            const lightboxSource = document.getElementById('screenshotLightboxSource');
                            const lightboxPicture = lightboxImg ? lightboxImg.closest('picture') : null;
                            
                            // ALWAYS hide picture element FIRST using CSS class to prevent any rendering
                            if (lightboxPicture) {
                                lightboxPicture.classList.add('switching');
                            }
                            
                            if (lightboxImg) {
                                // Remove ready class and add hiding class
                                lightboxImg.classList.remove('ready');
                                lightboxImg.classList.add('hiding');
                                
                                // REMOVE source element from DOM entirely to prevent browser from using it
                                if (lightboxSource && lightboxSource.parentNode) {
                                    lightboxSource.parentNode.removeChild(lightboxSource);
                                }
                                
                                // Remove src entirely instead of setting to blank pixel - prevents browser from showing cached image
                                lightboxImg.removeAttribute('src');
                                lightboxImg.removeAttribute('srcset');
                                // Also clear any cached image data
                                if (lightboxImg.complete) {
                                    lightboxImg.src = '';
                                }
                                
                                // Force multiple reflows to ensure changes take effect
                                void lightboxImg.offsetHeight;
                                void lightboxImg.offsetWidth;
                            }
                            
                            const src = this.getAttribute('data-src');
                            const webpSrc = this.getAttribute('data-src-webp');
                            
                            // Use requestAnimationFrame to ensure clearing happens in next frame before opening
                            requestAnimationFrame(function() {
                                openScreenshotLightbox(webpSrc || src);
                            });
                        });
                    });
                });
            }
        }
        
        // Tab switching functionality (using event delegation)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('info-modal-tab')) {
                const clickedTab = e.target;
                const tabContainer = clickedTab.closest('.info-modal-tabs');
                const modalContent = clickedTab.closest('.info-modal-content');
                
                if (tabContainer && modalContent) {
                    // Remove active class from all tabs
                    tabContainer.querySelectorAll('.info-modal-tab').forEach(btn => btn.classList.remove('active'));
                    
                    // Remove active class from all content
                    modalContent.querySelectorAll('.info-tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    clickedTab.classList.add('active');
                    
                    // Show corresponding content
                    const tabName = clickedTab.getAttribute('data-tab');
                    const content = modalContent.querySelector(`#tab-${tabName}`);
                    if (content) {
                        content.classList.add('active');
                    }
                }
            }
        });

        function closeTankInfoModal() {
            if (tankInfoModal) {
                tankInfoModal.style.display = 'none';
                tankInfoModal.removeAttribute('data-open');
            }
            // Move button back to original position when modal closes
            if (tankInfoIcon) {
                tankInfoIcon.classList.remove('extended');
            }
        }

        if (tankInfoIcon) {
            tankInfoIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                // Close dropdown if open
                selectItems.classList.add('select-hide');
                selectSelected.classList.remove('select-arrow-active');
                showTankInfo();
            });
        }

        if (closeTankInfo) {
            closeTankInfo.addEventListener('click', closeTankInfoModal);
        }

        // Close modal when clicking outside of it
        window.addEventListener('click', function(e) {
            if (e.target === tankInfoModal) {
                closeTankInfoModal();
            }
        });

        // Close modal with Escape key - comprehensive handler
        document.addEventListener('keydown', function(e) {
            // Only handle Escape key
            if (e.key !== 'Escape' && e.key !== 'Esc' && e.keyCode !== 27) {
                return;
            }
            
            // Check if tank info modal is open using multiple methods
            if (tankInfoModal) {
                const isOpenByStyle = tankInfoModal.style.display === 'block';
                const isOpenByData = tankInfoModal.getAttribute('data-open') === 'true';
                const isOpenByComputed = window.getComputedStyle(tankInfoModal).display === 'block';
                const isOpenByClass = tankInfoIcon && tankInfoIcon.classList.contains('extended');
                
                // If modal is open by any method, close it
                if (isOpenByStyle || isOpenByData || isOpenByComputed || isOpenByClass) {
                    closeTankInfoModal();
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    return false;
                }
            }
        }, true); // Use capture phase

    </script>
</body>
</html>
